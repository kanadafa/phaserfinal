<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <title>Phaser UI Example</title>
  <script src="./asset/phaser@3.55.2.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fontfaceobserver/2.1.0/fontfaceobserver.standalone.js"></script>
  <!-- å¼•å…¥ FontFaceObserver -->
  <!-- <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js"></script> -->
</head>

<body>

  <style>
    @font-face {
      font-family: 'a';
      src: url('asset/fonts/Cubic_11.woff') format('woff');

    }


    body {
      margin: 0;
      background-color: #000;
      /* å¯è‡ªè¨‚èƒŒæ™¯é¡è‰² */
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      /* æ»¿ç‰ˆå‚ç›´ */
    }

    canvas {
      display: block;
    }
  </style>
  <script>



    // èƒŒæ™¯éŸ³æ¨‚--------------------------------------------------------------------------------------------------------------------------------------------------
    class BootScene extends Phaser.Scene {
      constructor() {
        super({ key: 'BootScene', active: true });
      }

      preload() {
        // è¼‰å…¥èƒŒæ™¯éŸ³æ¨‚
        this.load.audio('bgm', 'asset/audio/bgm.mp3');
      }

      create() {
        // æ’­æ”¾ä¸¦å¾ªç’°
        this.sound.play('bgm', { loop: true, volume: 1 });
        // å•Ÿå‹•ä¸»é¸å–®å ´æ™¯
        this.scene.launch('MenuScene');
      }
    }
    // ä¸»é¸å–®å ´æ™¯--------------------------------------------------------------------------------------------------------------------------------------------------
    class MenuScene extends Phaser.Scene {
      constructor() {
        super({ key: 'MenuScene' });
      }

      preload() {
        // this.load.script('webfont', 'https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js');



        this.load.audio('btnselect', 'asset/audio/select07.mp3');
        this.load.audio('clickselect', 'asset/audio/click.mp3');
        this.load.image('bg', 'asset/menu/bg.jpg');
        this.load.image('btn_start', 'asset/menu/btn_start.png');
        this.load.image('btn_setting', 'asset/menu/btn_setting.png');
        this.load.image('btn_exit', 'asset/menu/btn_exit.png');
        this.load.video('home', 'asset/video/home.mp4', 'loadeddata', false, true);
      }

      create() {
        // 1. åŠ å½±ç‰‡ç•¶èƒŒæ™¯
        const homeVideo = this.add.video(400, 300, 'home')
          .setDisplaySize(800, 600)
          .setDepth(0)
          .setAlpha(0.65);
        homeVideo.setMute(true);

        // 2. ç‹€æ…‹
        const rawVideo = homeVideo.video;
        let reverseInterval = null;

        // 3. å½±ç‰‡å€’æ’­æ§åˆ¶
        function startReverse() {
          rawVideo.pause();
          setTimeout(() => {
            reverseInterval = setInterval(() => {
              if (rawVideo.currentTime <= 0.04) {
                clearInterval(reverseInterval);
                // åˆ°é ­å¾Œæš«åœå†æ­£æ’­
                setTimeout(() => {
                  rawVideo.currentTime = 0.01;
                  rawVideo.play();
                }, 500); // åœ 0.5 ç§’
              } else {
                rawVideo.currentTime -= 1 / 45; // è¶Šå¤§è¶Šå¿«
              }
            }, 1000 / 45);
          }, 500); // åœ 0.5 ç§’
        }

        // 4. æ­£æ’­åˆ°å°¾è§¸ç™¼å€’æ’­
        rawVideo.addEventListener('ended', startReverse);

        // 5. ä¸€é–‹å§‹æ­£æ’­ï¼ˆä¸ loopï¼‰
        rawVideo.currentTime = 0.01;
        homeVideo.play(false);

        // 6. æ¸…ç† intervalï¼Œé˜²æ­¢é‡é€²å ´æ™¯ç–ŠåŠ 
        this.events.on('shutdown', () => {
          if (reverseInterval) clearInterval(reverseInterval);
          rawVideo.removeEventListener('ended', startReverse);
        });

        // WebFont.load({
        //     google: {
        //         families: ['Press Start 2P'] // é€™æ˜¯ç¯„ä¾‹å­—é«”ï¼Œå¯ä»¥æ›æˆä½ æƒ³è¦çš„
        //     },
        //     active: () => {
        //         this.add.text(100, 100, 'Fewqoj ', {
        //             fontFamily: '"Press Start 2P"',
        //             fontSize: '20px',
        //             color: '#ffffff'
        //         });
        //     }
        // });

        const overSound = this.sound.add('btnselect');

        this.input.on('gameobjectover', (pointer, gameObject) => {
          overSound.play();
          // ä½ å¯ä»¥åœ¨é€™è£¡åˆ¤æ–·æ˜¯å“ªé¡†æŒ‰éˆ•å†åšå ´æ™¯åˆ‡æ›ç­‰è¡Œç‚ºï¼š
          // if (gameObject === btn1) this.scene.start('ModeScene');
          // else if (gameObject === btn2) â€¦
        });

        const clickSound = this.sound.add('clickselect');

        this.input.on('gameobjectdown', (pointer, gameObject) => {
          clickSound.play();
          // ä½ å¯ä»¥åœ¨é€™è£¡åˆ¤æ–·æ˜¯å“ªé¡†æŒ‰éˆ•å†åšå ´æ™¯åˆ‡æ›ç­‰è¡Œç‚ºï¼š
          // if (gameObject === btn1) this.scene.start('ModeScene');
          // else if (gameObject === btn2) â€¦
        });



        // ä½¿ç”¨ FontFaceObserver ç¢ºä¿å­—é«”åŠ è¼‰å®Œæˆ
        function addLetterSpacing(text, spacing = '\u200A') {
          return text.split('').join(spacing);
        }

        const font = new FontFaceObserver('a');
        font.load().then(() => {
          let spaced = addLetterSpacing('çµäººXè˜‹æœ', '\u200A'); // èª¿æ•´ spacing å­—å…ƒ
          let text = this.add.text(this.cameras.main.centerX, 150, spaced, {
            fontFamily: 'a',
            fontSize: '64px',
            //color: '#ffffff'
          });
          text.setOrigin(0.5);

          text.setTintFill(
            0xff0000, // å·¦ä¸Š â†’ ç´…è‰²
            0xffff00, // å³ä¸Š â†’ é»ƒè‰²
            0xff6600, // å·¦ä¸‹ â†’ æ©˜è‰²
            0xffffff  // å³ä¸‹ â†’ ç™½è‰²
          );
        });



        // Start æŒ‰éˆ•
        const startButton = this.add.image(400, 250, 'btn_start')
          .setOrigin(0.5)
          .setScale(0.35)
          .setInteractive({ useHandCursor: true });


        startButton.on('pointerover', () => {
          startButton.setScale(0.38); // æ”¾å¤§ä¸€é»
        });

        startButton.on('pointerout', () => {
          startButton.setScale(0.35); // é‚„åŸ
        });

        startButton.on('pointerover', () => {
          startButton.setAlpha(0.8);
        });

        startButton.on('pointerout', () => {
          startButton.setAlpha(1);
        });

        startButton.on('pointerdown', () => {
          console.log('é¡¯ç¤ºé–‹å§‹');
          this.scene.start('StoryScene');
        });

        // Setting æŒ‰éˆ•
        const settingButton = this.add.image(400, 400, 'btn_setting')
          .setOrigin(0.5)
          .setScale(0.35)
          .setInteractive({ useHandCursor: true });

        settingButton.on('pointerover', () => {
          settingButton.setScale(0.38); // æ”¾å¤§ä¸€é»
        });

        settingButton.on('pointerout', () => {
          settingButton.setScale(0.35); // é‚„åŸ
        });

        settingButton.on('pointerover', () => {
          settingButton.setAlpha(0.8);
        });

        settingButton.on('pointerout', () => {
          settingButton.setAlpha(1);
        });

        settingButton.on('pointerdown', () => {
          console.log('é¡¯ç¤ºè¨­å®š');
          this.scene.start('SettingScene');
        });

        // Exit æŒ‰éˆ•
        const exitButton = this.add.image(400, 550, 'btn_exit')
          .setOrigin(0.5)
          .setScale(0.35)
          .setInteractive({ useHandCursor: true });

        exitButton.on('pointerover', () => {
          exitButton.setScale(0.38); // æ”¾å¤§ä¸€é»
        });

        exitButton.on('pointerout', () => {
          exitButton.setScale(0.35); // é‚„åŸ
        });

        exitButton.on('pointerover', () => {
          exitButton.setAlpha(0.8);
        });

        exitButton.on('pointerout', () => {
          exitButton.setAlpha(1);
        });

        exitButton.on('pointerdown', () => {
          console.log('é¡¯ç¤ºé›¢é–‹');
          window.close();
        });

      }

      update() {
      }
    }


    //-----------------
    const storyText = [
      "åœ¨é™é çš„æ£®æ—æ·±è™•ï¼Œæœ‰ä¸€æ£µå·¨å¤§çš„è˜‹æœæ¨¹ï¼Œé€™æ£µå·¨æ¨¹è³ç«‹åœ¨è¬å¹´å¤æ—ä¸­ã€‚",
      "æ¯ç•¶è˜‹æœæˆç†Ÿæ™‚ï¼Œæ¨¹ä¸Šæœƒæ‰è½é–ƒäº®çš„é‡‘è‰²è˜‹æœï¼Œå‚³èå®ƒçš„æœå¯¦æ¯åƒä¸€é¡†å°±èƒ½å»¶å£½ä¸€å¹´ã€‚",
      "é‹æ°£å¥½ç”šè‡³å¯èƒ½æœƒé‡è¦‹æ›´ç¨€æœ‰çš„å½©è™¹è˜‹æœï¼Œåƒä¸‹å»èƒ½å¾—æ°¸ç”Ÿã€‚",
      "é€™äº›è˜‹æœå¸å¼•äº†ç„¡æ•¸å†’éšªè€…å’Œå°‹å¯¶çµäººçš„ç›®å…‰ã€‚",
      "ä½ æ˜¯ä¸€åå¹´è¼•çš„å°‹å¯¶çµäººï¼Œæ±ºå®šæ·±å…¥æ£®æ—ï¼Œå†’éšªå°‹æ‰¾é€™æ£µç¥å¥‡çš„è˜‹æœæ¨¹ã€‚",
      "ç•¶ä½ é‹æ°£å¥½æˆåŠŸæ‰¾åˆ°äº†ï¼Œæ­£æƒ³ä¾é å®ƒç™¼å®¶è‡´å¯Œæ™‚",
      "å»é­é‡è¨±å¤šå±æ©Ÿ",
      "æœ‰å¤§è€é·¹å¾ˆèŸ’è›‡ç­‰è‘—ä½ ï¼Œç”šè‡³æ˜¯æƒ¡åŠ£çš„å¤©æ°£",
      "ä½ å†’è‘—ç”Ÿå‘½å±éšªé—–å…¥æ£®æ—æ·±è™•ï¼Œæ˜¯æ­»ä¹Ÿè¦æˆåŠŸæŠŠå‚³èªªä¸­çš„å½©è™¹è˜‹æœå¸¶å›å»ã€‚"
    ];

    const endstoryText = [
      "æœ€çµ‚ï¼Œ",
      "ä½ æˆ°å‹å·¨é·¹ã€å·¨èŸ’èˆ‡æƒ¡åŠ£å¤©å€™ï¼Œ",
      "æ‘˜ä¸‹å½©è™¹è˜‹æœï¼›è˜‹æœè¿¸ç™¼å…‰èŠ’ï¼Œ",
      "é‡å•Ÿå¤§åœ°ç”Ÿæ©Ÿã€‚",
      "ä½ å¸¶ç€å¥‡è¹Ÿæ­¸ä¾†ï¼Œ",
      "ï¼Œæˆç‚ºä¸–äººæ™¯ä»°çš„æ°¸æ†å‚³å¥‡ã€‚"

    ];

    class StoryScene extends Phaser.Scene {
      constructor() {
        super({ key: 'StoryScene' });
      }

      preload() {
        this.load.image('bg', 'asset/menu/bg.png');
      }

      create() {
        const { width, height } = this.sys.game.config;

        // èƒŒæ™¯åœ–
        this.add.image(width / 2, height / 2, 'bg')
          .setDisplaySize(width, height)
          .setAlpha(0.7);

        // çŸ©å½¢åƒæ•¸
        const rectWidth = width - 100;
        const rectHeight = height * 0.7;
        const rectX = width / 2;
        const rectY = height / 2;
        const padding = 5;

        // èƒŒæ™¯æ¡†ï¼ˆç½®ä¸­ï¼‰
        this.add.rectangle(rectX, rectY, rectWidth, rectHeight, 0x000000, 0.6)
          .setOrigin(0.5);

        // å»ºç«‹é®ç½©
        const maskG = this.make.graphics();
        maskG.fillRect(
          rectX - rectWidth / 2,
          rectY - rectHeight / 2,
          rectWidth,
          rectHeight
        );
        const mask = maskG.createGeometryMask();

        // å…¨æ–‡åˆä½µ
        this.fullText = storyText.join(' ');

        // æ–‡å­—ç‰©ä»¶
        this.text = this.add.text(
          rectX - rectWidth / 2 + padding,
          rectY - rectHeight / 2 + padding,
          '',
          {
            fontFamily: 'a',
            fontSize: '24px',
            color: '#ffffff',
            wordWrap: {
              width: rectWidth - padding * 2,
              useAdvancedWrap: true
            }
          }
        )
          .setOrigin(0, 0)
          .setMask(mask);

        // åº•éƒ¨æç¤ºæ–‡å­—
        this.add.text(width / 2, height - 20, 'æŒ‰ SPACE éµè·³é', {
          fontFamily: 'a',
          fontSize: '36px',
          color: '#ffffff'
        })
          .setOrigin(0.5, 1);

        // æ‰“å­—ç‰¹æ•ˆåˆå§‹åŒ–
        this.charIndex = 0;
        this.typeNextChar();

        // ç”¨ Space éµè·³é
        this.input.keyboard.on('keydown-SPACE', () => this.skipStory());
      }

      typeNextChar() {
        this.charIndex++;
        this.text.setText(this.fullText.substr(0, this.charIndex));

        if (this.charIndex < this.fullText.length) {
          this.time.delayedCall(40, () => this.typeNextChar());
        } else {
          this.time.delayedCall(1500, () => {
            this.scene.start('ModeScene');
          });
        }
      }

      skipStory() {
        // å–æ¶ˆæ‰€æœ‰å»¶é²äº‹ä»¶
        this.time.removeAllEvents();
        // ç›´æ¥é€²å…¥ä¸‹ä¸€å ´æ™¯
        this.scene.start('ModeScene');
      }
    }
    // æ¨¡å¼å ´æ™¯-------------------------------------------------------------------------------------------------------------------------------------
    class ModeScene extends Phaser.Scene {
      constructor() {
        super({ key: 'ModeScene' });
      }

      preload() {
        // åŠ è¼‰æŒ‰éˆ•é¸æ“‡éŸ³æ•ˆ
        this.load.audio('btnselect', 'asset/audio/select07.mp3');
        this.load.audio('clickselect', 'asset/audio/click.mp3');

        // åŠ è¼‰æŒ‰éˆ•ã€èƒŒæ™¯åœ–
        this.load.image('single', 'asset/menu/playmode/single.png');
        this.load.image('mulit', 'asset/menu/playmode/mulit.png');
        this.load.image('back', 'asset/back.png');
        this.load.image('modebg', 'asset/menu/modebg.jpeg');
      }

      create() {
        const W = this.scale.width;
        const H = this.scale.height;

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // 1) å…ˆæŠŠèƒŒæ™¯åœ–æ”¾åœ¨æœ€åº•å±¤ (depth = 0)ï¼Œä¸¦è¨­å®šå®ƒçš„é¡¯ç¤ºå¤§å°ç‚ºæ•´å€‹ç•«é¢
        this.add
          .image(W / 2, H / 2, 'modebg')
          .setDisplaySize(W, H)
          .setDepth(0);
        this.helpTexts = [
          // ç¬¬ä¸€æ®µï¼šP1 / P2 æ§åˆ¶æ–¹å¼
          'ã€ P1æ¨¡å¼ æ§åˆ¶æ–¹å¼ ã€‘\n\n' +
          'â† / â†’  â†â†’ ç§»å‹•\n' +
          'â†‘        è·³èº\n' +
          'â†“        è¶´ä¸‹\n\n' +
          'ã€  P2æ¨¡å¼ æ§åˆ¶æ–¹å¼ ã€‘\n\n' +
          'A / D  â†â†’ ç§»å‹•\n' +
          'W        è·³èº\n' +
          'S        è¶´ä¸‹\n\n' +
          'æŒ‰ä»»æ„éµæˆ–é»æ“Šï¼Œç¹¼çºŒä¸‹ä¸€æ®µèªªæ˜',

          // ç¬¬äºŒæ®µï¼šéŠæˆ²ç›®æ¨™ä»‹ç´¹ï¼ˆå¯è‡ªè¡Œèª¿æ•´å…§å®¹ï¼‰
          'ã€ éŠæˆ²ç›®æ¨™ ã€‘\n\n' +
          ' æ¯é—œå¡é™æ™‚60ç§’ \n\n' +
          'ã€ P1æ¨¡å¼ ã€‘éé—œæ¨™æº–åˆ†åˆ¥100ã€150ã€200 \n\n' +

          'ã€ P2æ¨¡å¼ ã€‘æ¯”èª°çš„åˆ†æ•¸æ¯”è¼ƒå¤š \n\n',
          // ç¬¬ä¸‰æ®µï¼šæ³¨æ„äº‹é …ï¼ˆæœ€å¾Œä¸€æ®µ â†’ æŒ‰ä¸‹å°±é–‹å§‹éŠæˆ²ï¼‰
          'ã€ æ³¨æ„äº‹é … ã€‘\n\n' +
          '1.ğŸçš„ç¨®é¡ä¸åŒæœƒåŠ åˆ†èˆ‡æ‰£åˆ†ã€‚\n\n' +
          '2.ğŸè¦éš¨æ™‚æ³¨æ„ç¶ ç¶ é•·é•·(-15)ã€‚\n\n' +
          '3.ğŸ¦…å°å¿ƒé£›éé ­ä¸Š(-20)ã€‚\n\n' +
          'æŒ‰ä»»æ„éµæˆ–é»æ“Šï¼Œé–‹å§‹éŠæˆ²ï½'
        ];

        // 2) è¨­å®šç›®å‰é¡¯ç¤ºåˆ°å“ªä¸€æ®µ
        this.currentHelpIndex = 0;

        // 3) å»ºç«‹å…¨è¢å¹•åŠé€æ˜é®ç½©
        this.overlay = this.add
          .rectangle(0, 0, W, H, 0x000000, 0.7)
          .setOrigin(0)
          .setDepth(1000);

        // 4) å»ºç«‹ç¬¬ä¸€æ®µèªªæ˜æ–‡å­—
        this.helpText = this.add
          .text(
            W / 2,
            H / 2,
            this.helpTexts[this.currentHelpIndex],
            {
              fontFamily: 'a',
              fontSize: '28px',
              color: '#ffffff',
              align: 'center',
              wordWrap: { width: W * 0.8, useAdvancedWrap: true }
            }
          )
          .setOrigin(0.5)
          .setDepth(1001);

        // 5) ç¶å®šä¸€æ¬¡æ€§çš„éµç›¤ï¼†é»æ“Šäº‹ä»¶ï¼šæ¯æŒ‰ä¸€æ¬¡å°±å‘¼å« showNextHelp()
        this.input.keyboard.once('keydown', () => {
          this.showNextHelp();
        });
        this.input.once('pointerdown', () => {
          this.showNextHelp();
        });
      }

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // å°‡ä½¿ç”¨è€…æŒ‰éµæˆ–é»æ“Šå¾Œï¼Œè¦é¡¯ç¤ºä¸‹ä¸€æ®µæ–‡å­—æˆ–é—œé–‰é®ç½©
      showNextHelp() {
        // å¢åŠ ç´¢å¼•ï¼ŒæŒ‡å‘ä¸‹ä¸€æ®µ
        this.currentHelpIndex++;

        // å¦‚æœé‚„æ²’åˆ°æœ€å¾Œä¸€æ®µï¼Œå°±æ›´æ–°æ–‡å­—ä¸¦é‡æ–°ç¶å®šä¸€æ¬¡æ€§äº‹ä»¶
        if (this.currentHelpIndex < this.helpTexts.length) {
          // æ›´æ–°æ–‡å­—å…§å®¹
          this.helpText.setText(this.helpTexts[this.currentHelpIndex]);

          // é‡æ–°ç¶å®šï¼šä¸‹ä¸€æ¬¡æŒ‰ä»»æ„éµæˆ–é»æ“Šé‚„æ˜¯å‘¼å« showNextHelp()
          this.input.keyboard.once('keydown', () => {
            this.showNextHelp();
          });
          this.input.once('pointerdown', () => {
            this.showNextHelp();
          });
        }
        // å¦‚æœå·²ç¶“è¶…éæœ€å¾Œä¸€æ®µï¼Œä»£è¡¨ä¸Šä¸€æ®µæŒ‰ä¸‹ä¹‹å¾Œå°±è¦é—œé–‰æ‰€æœ‰é®ç½©ï¼Œä¸¦é¡¯ç¤ºæŒ‰éˆ•
        else {
          // éŠ·æ¯€é®ç½©èˆ‡æ–‡å­—
          this.overlay.destroy();
          this.helpText.destroy();

          // å‘¼å«é¡¯ç¤ºæŒ‰éˆ•çš„æ–¹æ³•
          this.showModeButtons();
        }
      }

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // æ‰€æœ‰é®ç½©èªªæ˜å®Œæˆä¹‹å¾Œï¼Œæ‰è·‘é€™è£¡ï¼šé¡¯ç¤ºèƒŒæ™¯ã€æŒ‰éˆ•ï¼Œä»¥åŠè¨­å®šäº’å‹•è¡Œç‚ºï¼†éŸ³æ•ˆ
      showModeButtons() {
        const W = this.scale.width;
        const H = this.scale.height;

        // 1) åŠ è¼‰éŸ³æ•ˆï¼ˆæŠŠåŸå…ˆ preload çš„éŸ³æ•ˆå–å‡ºï¼‰
        const overSound = this.sound.add('btnselect');
        const clickSound = this.sound.add('clickselect');

        // 2) å…ˆé¡¯ç¤ºä¸€å¼µèƒŒæ™¯ï¼ˆåŠé€æ˜ï¼‰
        //    ä½ å¯ä»¥è‡ªè¡Œèª¿æ•´ä½ç½®èˆ‡å¤§å°
        const bgmodebg = this.add
          .image(W / 2, H / 2, 'modebg')
          .setDisplaySize(W, H)
          .setAlpha(0.7)
          .setDepth(0);

        // 3) ç•¶æ»‘é¼ ç§»åˆ°ä»»ä½•å¯äº’å‹• GameObject ä¸Šï¼Œå°±æ’­æ”¾ hover éŸ³æ•ˆ
        this.input.on('gameobjectover', (pointer, gameObject) => {
          overSound.play();
        });

        // 4) ç•¶æŒ‰ä¸‹ä»»ä½•å¯äº’å‹• GameObject æ™‚ï¼Œå°±æ’­æ”¾ click éŸ³æ•ˆ
        this.input.on('gameobjectdown', (pointer, gameObject) => {
          clickSound.play();
        });

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // 5) å»ºç«‹ã€Œè¿”å›ã€æŒ‰éˆ•
        const backButton = this.add
          .image(50, 50, 'back')
          .setOrigin(0.5)
          .setScale(0.075)
          .setInteractive({ useHandCursor: true });

        backButton.on('pointerover', () => {
          backButton.setScale(0.08);
          backButton.setAlpha(0.8);
        });
        backButton.on('pointerout', () => {
          backButton.setScale(0.075);
          backButton.setAlpha(1);
        });
        backButton.on('pointerdown', () => {
          // æŒ‰ä¸‹ã€Œè¿”å›ã€æ™‚ï¼Œè·³è½‰å› MenuScene
          this.scene.start('MenuScene');
        });

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // 6) å»ºç«‹ã€ŒSingleã€æŒ‰éˆ•
        const singleButton = this.add
          .image(W / 2, H / 2 - 50, 'single') // ä½ å¯ä»¥è‡ªè¡Œèª¿æ•´ Y åº§æ¨™
          .setOrigin(0.5)
          .setScale(0.35)
          .setInteractive({ useHandCursor: true });

        singleButton.on('pointerover', () => {
          singleButton.setScale(0.38);
          singleButton.setAlpha(0.8);
        });
        singleButton.on('pointerout', () => {
          singleButton.setScale(0.35);
          singleButton.setAlpha(1);
        });
        singleButton.on('pointerdown', () => {
          // æŒ‰ä¸‹ Single æ¨¡å¼ â†’ è·³åˆ° single_1Scene
          this.scene.start('single_1Scene');
        });

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // 7) å»ºç«‹ã€ŒMultiplayerã€æŒ‰éˆ•
        const mulitButton = this.add
          .image(W / 2, H / 2 + 100, 'mulit') // ä½ å¯ä»¥è‡ªè¡Œèª¿æ•´ Y åº§æ¨™
          .setOrigin(0.5)
          .setScale(0.37)
          .setInteractive({ useHandCursor: true });

        mulitButton.on('pointerover', () => {
          mulitButton.setScale(0.40);
          mulitButton.setAlpha(0.8);
        });
        mulitButton.on('pointerout', () => {
          mulitButton.setScale(0.37);
          mulitButton.setAlpha(1);
        });
        mulitButton.on('pointerdown', () => {
          // æŒ‰ä¸‹ Multiplayer æ¨¡å¼ â†’ è·³åˆ° MulitLevelSelectScene
          this.scene.start('MulitLevelSelectScene');
        });
      }
    }

    // å¤šäººé¸æ“‡é—œå¡å ´æ™¯--------------------------------------------------------------------------------------------------------------------------------------------------
    class MulitLevelSelectScene extends Phaser.Scene {
      constructor() {
        super({ key: 'MulitLevelSelectScene' });
      }
      preload() {
        this.load.image('level_select_bg', 'asset/menu/bg.jpg');
        // åŠ è¼‰éŸ³æ•ˆ
        this.load.audio('btnselect', 'asset/audio/select07.mp3');
        this.load.audio('clickselect', 'asset/audio/click.mp3');
      }
      create() {
        // éŸ³æ•ˆ
        const overSound = this.sound.add('btnselect');
        const clickSound = this.sound.add('clickselect');

        // åŠé€æ˜é®ç½©
        this.add.rectangle(400, 300, 800, 600, 0x000000, 0.7).setOrigin(0.5);

        // å¯åŠ ä¸€å€‹èƒŒæ™¯
        this.add.image(400, 300, 'level_select_bg').setDisplaySize(800, 600).setAlpha(0.4);

        // ä¸»æ¨™é¡Œ
        this.add.text(400, 100, 'é¸æ“‡å¤šäººé—œå¡', {
          fontFamily: 'a',
          fontSize: '48px',
          color: '#ffff00'
        }).setOrigin(0.5);

        // é—œå¡æŒ‰éˆ•å€‘
        const buttonData = [
          { y: 220, label: 'é—œå¡ 1', scene: 'Level1Scene_mulit' },
          { y: 330, label: 'é—œå¡ 2', scene: 'Level2Scene_mulit' },
          { y: 440, label: 'é—œå¡ 3', scene: 'Level3Scene_mulit' }
        ];
        buttonData.forEach(({ y, label, scene }) => {
          const btn = this.add.rectangle(400, y, 300, 80, 0xffffff, 1)
            .setStrokeStyle(4, 0xff0000)
            .setInteractive({ useHandCursor: true });
          const text = this.add.text(400, y, label, {
            fontFamily: 'a',
            fontSize: '36px',
            color: '#000'
          }).setOrigin(0.5);

          btn.on('pointerover', () => {
            btn.setFillStyle(0xffcc00, 1);
            btn.setStrokeStyle(6, 0xff6600);
            overSound.play();
          });
          btn.on('pointerout', () => {
            btn.setFillStyle(0xffffff, 1);
            btn.setStrokeStyle(4, 0xff0000);
          });
          btn.on('pointerdown', () => {
            clickSound.play();
            this.scene.start(scene);
          });
        });

        // è¿”å›éˆ•
        const backBtn = this.add.text(400, 540, 'è¿”å›', {
          fontFamily: 'a',
          fontSize: '28px',
          color: '#ff0000',
          backgroundColor: '#fff'
        }).setOrigin(0.5).setPadding(20, 8, 20, 8).setInteractive({ useHandCursor: true });

        backBtn.on('pointerover', () => {
          backBtn.setStyle({ backgroundColor: '#ffc' });
          overSound.play();
        });
        backBtn.on('pointerout', () => backBtn.setStyle({ backgroundColor: '#fff' }));
        backBtn.on('pointerdown', () => {
          clickSound.play();
          this.scene.start('ModeScene');
        });
      }
    }












    // å–®æ©Ÿé—œå¡å…±ç”¨é‚è¼¯-----------------------------------------------------------------------------
    class BaseLevelScene extends Phaser.Scene {
      constructor(key, config) {
        super({ key });
        this.levelConfig = Object.assign({
          backgroundKey: '',
          timeLimit: 60,
          passScore: 0,
          nextScene: null,
          showSnake: false,
          showEagle: false
        }, config);
      }

      preload() {
        // å…±ç”¨è³‡æº
        this.load.image('gr', 'asset/ground.png');
        this.load.image('black', 'asset/fruits/black.png');
        this.load.image('red', 'asset/fruits/red.png');
        this.load.image('gold', 'asset/fruits/gold.png');
        this.load.image('colorful', 'asset/fruits/colorful.png');
        this.load.spritesheet('player1', 'asset/player1.png', { frameWidth: 900, frameHeight: 472 });

        this.load.image('btnRestart', 'asset/reset.png');
        this.load.image('btnReturn', 'asset/home.png');
        this.load.image('btnNext', 'asset/next.png');
        this.load.audio('btnselect1', 'asset/audio/select07.mp3');
        this.load.audio('clickselect1', 'asset/audio/click.mp3');
        this.load.audio('eatapple', 'asset/audio/eatapple.mp3');
      }

      init(data) {
        // single æˆ– multi
        this.mode = data.mode || 'single';
      }

      create() {

        this.btnSelectSound = this.sound.add('btnselect1');
        this.clickSelectSound = this.sound.add('clickselect1');

        this.eatapple = this.sound.add('eatapple', { volume: this.game.sound.volume });

        // é‡ç½®éŠæˆ²ç‹€æ…‹ï¼Œè®“å¤šæ¬¡å¤±æ•—éƒ½èƒ½å†æ¬¡é¡¯ç¤ºçµæŸç•«é¢
        this.isGameOver = false;
        // ç¢ºä¿è¼¸å…¥é‡æ–°å•Ÿç”¨ï¼ˆç‰¹åˆ¥æ˜¯éµç›¤èˆ‡æ»‘é¼ ï¼‰
        this.input.enabled = true;
        // èƒŒæ™¯
        this.add.image(400, 300, this.levelConfig.backgroundKey).setDisplaySize(800, 600);

        // åœ°é¢
        this.ground = this.physics.add.staticImage(
          this.scale.width / 2,
          this.scale.height - 1,
          'gr'
        )
          .setDisplaySize(this.scale.width, 40)
          .setOrigin(0.5, 1)
          .refreshBody();

        // 2. å»ºè§’è‰²ï¼ŒåŸé»æ”¹æˆä¸­é–“ä¸‹æ–¹ (0.5, 1)
        this.player = this.physics.add
          .sprite(400, 0, 'player1')
          .setScale(0.3)
          .setOrigin(0.5, 1)               // â† æŠŠåŸé»è¨­åœ¨è…³åº•
          .setCollideWorldBounds(true);

        // 3. æŠŠè§’è‰² y æŠ“åˆ°åœ°æ¿é ‚ç«¯ä½ç½®
        //    ground.y å°±æ˜¯åœ°æ¿åº•é‚Š (å› ç‚º origin.y = 1)ï¼Œ
        //    å†å¾€ä¸Š 40pxï¼ˆåœ°æ¿é«˜åº¦ï¼‰å°±æ˜¯åœ°æ¿ã€Œé ‚ç«¯ã€ã€‚
        //    ç”¨é€™å€‹å€¼ç›´æ¥ç•¶è…³åº• y
        this.player.y = this.ground.y - this.ground.displayHeight;



        // 5. åŠ å…¥ç¢°æ’
        this.physics.add.collider(this.player, this.ground);

        // èª¿æ•´ç©å®¶ç¢°æ’å€åŸŸ
        this.player.body.setSize(260, 0);
        this.player.body.setOffset(380, 0); // æ ¹æ“šç¸®æ”¾å¾Œçš„å°ºå¯¸èª¿æ•´











        this.cursors = this.input.keyboard.createCursorKeys();
        this.createAnimations();

        // åˆ†æ•¸èˆ‡æ™‚é–“
        this.score = 0;
        this.timeLeft = this.levelConfig.timeLimit;
        this.rainbowDropped = false;
        this.scoreText = this.add.text(16, 16, 'Score: 0', {
          fontFamily: 'a',
          fontSize: '36px',
          color: '#ff0000',
          strokeThickness: 2
        });
        this.timerText = this.add.text(650, 16, 'Time: ' + this.timeLeft, {
          fontFamily: 'a',
          fontSize: '36px',
          color: '#ffa500',
          strokeThickness: 2
        });
        this.timer = this.time.addEvent({ delay: 1000, callback: this.updateTimer, callbackScope: this, loop: true });

        // æ‰è½ç‰©
        this.fruits = this.physics.add.group();
        this.spawnEvent = this.time.addEvent({ delay: 800, callback: this.spawnFruit, callbackScope: this, loop: true });
        this.physics.add.overlap(this.player, this.fruits, this.collectFruit, null, this);

        // è€é·¹
        if (this.levelConfig.showEagle) {
          this.eagles = this.physics.add.group();
          this.time.addEvent({ delay: 10000, callback: this.spawnEagle, callbackScope: this, loop: true });
          this.physics.add.overlap(this.player, this.eagles, this.hitEagle, null, this);
        }

        // è›‡
        if (this.levelConfig.showSnake) {
          this.isSnakeActive = false;
          this.time.delayedCall(10000, this.spawnSnake, null, this);
        }

        this.isPaused = false;
        this.pauseOverlay = null;

        this.input.keyboard.on('keydown-ESC', () => {
          this.isPaused ? this.resumeGame() : this.pauseGame();
        });







      }

      update() {

        if (this.isPaused) return;

        if (Phaser.Input.Keyboard.JustDown(this.cursors.up) && this.player.body.blocked.down) {
          this.player.setVelocityY(-350);       // èª¿æ•´è·³èºåŠ›é“
          // è·³éå¾Œé¢å·¦å³/è¹²ä¸‹é‚è¼¯
        }

        // 2ï¸âƒ£ å…ˆæŠŠæ°´å¹³é€Ÿåº¦æ­¸é›¶
        this.player.setVelocityX(0);




        const speed = 300 * (this.player.isSlowed ? 0.6 : 1);

        // 1. å…ˆè™•ç†å·¦å³ç§»å‹•ï¼Œä¸¦è¨˜éŒ„æœ€å¾Œä¸€æ¬¡æŒ‰çš„æ–¹å‘
        if (this.cursors.left.isDown) {
          this.player.setVelocityX(-speed);
          this.lastDirection = 'left';
        } else if (this.cursors.right.isDown) {
          this.player.setVelocityX(speed);
          this.lastDirection = 'right';
        } else {
          this.player.setVelocityX(0);
        }

        // 2. è‹¥æ­£åœ¨æŒ‰ã€Œä¸‹ã€å°±å„ªå…ˆåšè¹²ä¸‹
        if (this.cursors.down.isDown) {
          // åœæ­¢æ°´å¹³ç§»å‹•
          this.player.setVelocityX(0);
          // æ’­ lie å‹•ç•«
          this.player.anims.play('lie', true);
          // æ ¹æ“šæœ€å¾Œæ–¹å‘æ°´å¹³ç¿»è½‰
          this.player.setFlipX(this.lastDirection === 'left');
          return;    // ä¸å†åŸ·è¡Œå¾Œé¢çš„èµ°è·¯/å¾…æ©Ÿå‹•ç•«
        }

        // 3. èµ°è·¯ / å¾…æ©Ÿ
        if (this.player.body.velocity.x < 0) {
          // å¾€å·¦èµ°
          this.player.anims.play('walk_left', true);
          this.player.setFlipX(false);  // walk_left å·²ç¶“æ˜¯å·¦å‘ï¼Œä¸éœ€è¦å†ç¿»
        }
        else if (this.player.body.velocity.x > 0) {
          // å¾€å³èµ°
          this.player.anims.play('walk_right', true);
          this.player.setFlipX(false);
        }
        else {
          // å¾…æ©Ÿ
          this.player.anims.play('ready', true);
          // å¾…æ©Ÿè²¼åœ–ä¹Ÿè¦è·Ÿæ–¹å‘ä¸€è‡´
          this.player.setFlipX(this.lastDirection === 'left');
        }



        // è›‡é‚Šç•Œåå½ˆ
        // æ ¹æ“šæ°´å¹³é€Ÿåº¦ç¿»è½‰è›‡çš„è²¼åœ–
        if (this.snake && this.snake.body && this.snake.body.velocity) {
          if (this.snake.body.velocity.x > 0) {
            this.snake.setFlipX(true);
          } else if (this.snake.body.velocity.x < 0) {
            this.snake.setFlipX(false);
          }
        }


        // æ¸…ç†é£›å‡ºç•«é¢è€é·¹
        if (this.eagles) {
          this.eagles.getChildren().forEach(eagle => {
            if (eagle.x < -50 || eagle.x > this.scale.width + 50) {
              eagle.destroy();
            }
          });
        }
      }

      createAnimations() {
        this.anims.create({ key: 'walk_left', frames: this.anims.generateFrameNumbers('player1', { start: 0, end: 3 }), frameRate: 8, repeat: -1 });
        this.anims.create({ key: 'ready', frames: [{ key: 'player1', frame: 4 }], frameRate: 1, repeat: -1 });
        this.anims.create({ key: 'walk_right', frames: this.anims.generateFrameNumbers('player1', { start: 5, end: 8 }), frameRate: 8, repeat: -1 });
        this.anims.create({ key: 'lie', frames: this.anims.generateFrameNumbers('player1', { start: 9, end: 9 }), frameRate: 8, repeat: -1 });

        if (this.levelConfig.showEagle) {
          this.anims.create({ key: 'eagle', frames: this.anims.generateFrameNumbers('eagle', { start: 0, end: 8 }), frameRate: 9, repeat: -1 });
        }
        if (this.levelConfig.showSnake) {
          this.anims.create({ key: 'snake_move', frames: this.anims.generateFrameNumbers('snake', { start: 0, end: 4 }), frameRate: 6, repeat: -1 });
        }


      }

      updateTimer() {
        this.timeLeft--;
        this.timerText.setText('Time: ' + this.timeLeft);
        if (this.timeLeft <= 0) {
          this.timer.remove(false);
          this.spawnEvent.remove(false);
          this.endLevel();
        }
      }

      spawnFruit() {
        const x = Phaser.Math.Between(50, 750);
        const rand = Math.random();
        let type;
        if (rand < 0.5) type = 'red';
        else if (rand < 0.7) type = 'black';
        else if (rand < 0.95) type = 'gold';
        else if (!this.rainbowDropped) { type = 'colorful'; this.rainbowsDropped = true; }
        else type = 'red';
        const fruit = this.fruits.create(x, 0, type).setScale(0.05);
        fruit.type = type;
        fruit.setVelocityY(150);
      }

      collectFruit(player, fruit) {
        fruit.destroy();

        this.eatapple.play({ volume: this.game.sound.volume });
        switch (fruit.type) {
          case 'red': this.score += 2; break;
          case 'gold': this.score += 10; break;
          case 'colorful': this.score += 100; break;
          case 'black': this.score -= 10; break;
        }
        this.scoreText.setText('Score: ' + this.score);
      }

      spawnEagle() {
        const { width } = this.scale;
        const y = 400;
        const fromLeft = Phaser.Math.Between(0, 1) === 0;
        const x = fromLeft ? -50 : width + 50;
        const speed = 200 * (fromLeft ? 1 : -1);
        const eagle = this.eagles.create(x, y, 'eagle').setOrigin(0.5).setScale(1).setDepth(50);
        eagle.body.allowGravity = false;
        eagle.setVelocityX(speed);
        eagle.setFlipX(!fromLeft);
        eagle.play('eagle');
      }

      spawnSnake() {
        this.snake = this.physics.add
          .sprite(50, 0, 'snake')
          .setOrigin(0.5, 1)
          .setScale(0.35)
          .setCollideWorldBounds(true)   // å•Ÿç”¨ä¸–ç•Œé‚Šç•Œç¢°æ’
          .setBounce(1, 0);              // æ°´å¹³å½ˆåŠ› 1ï¼Œå‚ç›´å½ˆåŠ› 0

        const floorTopY = this.ground.y - this.ground.displayHeight;
        this.snake.y = floorTopY;
        this.snake.body.setSize(300, 80);
        this.snake.body.setOffset(-this.snake.displayWidth / 2 + 100, -this.snake.displayHeight + 100);

        this.physics.add.collider(this.snake, this.ground);
        this.snake.play('snake_move');
        this.snake.setVelocityX(100);
        this.snake.setFlipX(false);
        this.physics.add.overlap(this.player, this.snake, this.hitSnake, null, this);


      }

      hitSnake(player, snake) {
        if (this.isHit) return;
        this.isHit = true;
        player.setTint(0xff0000);
        this.time.delayedCall(1000, () => {
          this.score -= 15;
          this.scoreText.setText('Score: ' + this.score);
          player.clearTint();
          this.isHit = false;
        });
      }

      hitEagle(player, eagle) {
        // å¦‚æœç©å®¶è¶´ä¸‹ï¼Œå°±ä¸ç®—ç¢°æ’
        if (this.cursors.down.isDown) {
          return;
        }

        eagle.destroy();
        this.score -= 20;
        this.scoreText.setText('Score: ' + this.score);
        player.setTint(0x4b0082);
        this.time.delayedCall(200, () => player.clearTint());
      }

      endLevel() {
        console.log('åŸ·è¡Œ endLevel()');
        if (this.isGameOver) return;
        this.isGameOver = true;

        // æš«åœç‰©ç†ä¸–ç•Œã€å‹•ç•«ã€é›¨æ»´â€¦
        this.physics.pause();
        if (this.rainEmitter) this.rainEmitter.stop();
        if (this.player?.anims) this.player.anims.stop();
        this.eagles?.getChildren().forEach(e => e.anims.stop());
        this.snake?.anims.stop();

        const W = this.scale.width;
        const H = this.scale.height;

        // åŠé€æ˜é®ç½©
        this.add.rectangle(0, 0, W, H, 0x000000, 0.7)
          .setOrigin(0)
          .setDepth(100);

        // é/å¤±æ•—ä¸»è¨Šæ¯
        const passed = this.score >= this.levelConfig.passScore;
        const msg = passed ? 'é é—œ ï¼' : 'å¤± æ•— ï¼';
        const color = passed ? '#00ff00' : '#ff0000';
        this.add.text(W / 2, H / 2 - 120, msg, {
          fontFamily: 'a',
          fontSize: '64px',
          color,
          stroke: '#000',
          strokeThickness: 4
        })
          .setOrigin(0.5)
          .setDepth(101);

        // â€”â€” æ–°å¢ï¼šåœ¨å³é‚Šé¡¯ç¤ºæœ€çµ‚åˆ†æ•¸ â€”â€”
        this.add.text(W / 2, H / 2 - 40, `æœ€çµ‚åˆ†æ•¸ï¼š${this.score}`, {
          fontFamily: 'a',
          fontSize: '32px',
          color: '#ffffff',
          stroke: '#000',
          strokeThickness: 2
        })
          .setOrigin(0.5)
          .setDepth(101);

        // æŒ‰éˆ•ç¾¤
        const btnY = H / 2 + 100;
        const gap = 200;
        const restart = this.add.image(W / 2 - gap, btnY, 'btnRestart')
          .setInteractive({ useHandCursor: true })
          .setScale(0.1)
          .setDepth(101);


        restart
          .on('pointerover', () => {
            restart.setScale(0.15);
            this.btnSelectSound.play();   // â–¶ æ’­æ”¾ã€Œhoverã€éŸ³æ•ˆ
            restart.setAlpha(0.8);
          })
          .on('pointerout', () => {
            restart.setScale(0.1);
            restart.setAlpha(1);
          })
          .on('pointerdown', () => {
            this.clickSelectSound.play(); // â–¶ æ’­æ”¾ã€Œclickã€éŸ³æ•ˆ
            this.scene.restart();
          });

        // â€”â€” Return éˆ• â€”â€”  
        const ret = this.add.image(W / 2, btnY, 'btnReturn')
          .setInteractive({ useHandCursor: true })
          .setScale(0.1)
          .setDepth(101);

        ret
          .on('pointerover', () => {
            this.btnSelectSound.play();
            ret.setScale(0.15);
            ret.setAlpha(0.8);
          })
          .on('pointerout', () => {
            ret.setScale(0.1);
            ret.setAlpha(1);
          })
          .on('pointerdown', () => {
            this.clickSelectSound.play();
            this.scene.start('MenuScene');
          });

        // â€”â€” Next éˆ• â€”â€”  
        if (passed && this.levelConfig.nextScene) {
          const next = this.add.image(W / 2 + gap, btnY, 'btnNext')
            .setInteractive({ useHandCursor: true })
            .setScale(0.1)
            .setDepth(101);

          next
            .on('pointerover', () => {
              this.btnSelectSound.play();
              next.setScale(0.15);
              next.setAlpha(0.8);
            })
            .on('pointerout', () => {
              next.setScale(0.1);
              next.setAlpha(1);
            })
            .on('pointerdown', () => {
              this.clickSelectSound.play();
              this.scene.start(this.levelConfig.nextScene);
            });
        }

      }

      pauseGame() {
        if (this.isPaused) return;
        this.sound.pauseAll();

        this.isPaused = true;
        this.physics.world.pause();
        this.timer.paused = true;
        this.spawnEvent.paused = true;
        this.player.anims.pause();
        if (this.player2) this.player2.anims.pause();
        if (this.eagles) this.eagles.getChildren().forEach(e => e.anims.pause());
        if (this.snake) this.snake.anims.pause();
        if (this.rainEmitter) this.rainEmitter.pause();

        // åŠé€æ˜é®ç½©
        this.pauseOverlay = this.add.rectangle(0, 0, this.scale.width, this.scale.height, 0x000000, 0.7)
          .setOrigin(0)
          .setDepth(200);

        // æ–‡å­—
        this.add.text(this.scale.width / 2, this.scale.height / 2 - 120, 'éŠæˆ²æš«åœ', {
          fontFamily: 'a',
          fontSize: '64px',
          color: '#ffff00',
          stroke: '#000',
          strokeThickness: 4
        })
          .setOrigin(0.5)
          .setDepth(201)
          .setName('pauseText');

        // ä¸»ç•«é¢ã€é‡ä¾†ã€ç¹¼çºŒ
        const btnY = this.scale.height / 2 + 20;
        const gap = 200;
        // ä¸»ç•«é¢
        const btnHome = this.add.image(this.scale.width / 2 - gap, btnY, 'btnReturn')
          .setInteractive({ useHandCursor: true }).setScale(0.12).setDepth(201).setName('pauseBtnHome');



        btnHome
          .on('pointerover', () => {
            btnHome.setScale(0.15);
            btnHome.setAlpha(0.8);
            this.btnSelectSound.play(); // hover éŸ³æ•ˆ
          })
          .on('pointerout', () => {
            btnHome.setScale(0.12);
            btnHome.setAlpha(1);
          })
          .on('pointerdown', () => {
            this.clickSelectSound.play(); // click éŸ³æ•ˆ
            this.resumeGame();
            this.scene.start('MenuScene');
          });

        // é‡ä¾†
        const btnRestart = this.add.image(this.scale.width / 2, btnY, 'btnRestart')
          .setInteractive({ useHandCursor: true }).setScale(0.12).setDepth(201).setName('pauseBtnRestart');
        btnRestart
          .on('pointerover', () => {
            btnRestart.setScale(0.15);
            btnRestart.setAlpha(0.8);
            this.btnSelectSound.play();
          })
          .on('pointerout', () => {
            btnRestart.setScale(0.12);
            btnRestart.setAlpha(1);
          })
          .on('pointerdown', () => {
            this.clickSelectSound.play();
            this.resumeGame();
            this.scene.restart();
          });

        // ç¹¼çºŒ
        const btnContinue = this.add.image(this.scale.width / 2 + gap, btnY, 'btnNext')
          .setInteractive({ useHandCursor: true }).setScale(0.12).setDepth(201).setName('pauseBtnContinue');
        btnContinue
          .on('pointerover', () => {
            btnContinue.setScale(0.15);
            btnContinue.setAlpha(0.8);
            this.btnSelectSound.play();
          })
          .on('pointerout', () => {
            btnContinue.setScale(0.12);
            btnContinue.setAlpha(1);
          })
          .on('pointerdown', () => {
            this.clickSelectSound.play();
            this.resumeGame();
          });
      }

      resumeGame() {
        if (!this.isPaused) return;
        this.sound.resumeAll();
        this.isPaused = false;
        this.physics.world.resume();
        this.timer.paused = false;
        this.spawnEvent.paused = false;
        this.player.anims.resume();
        if (this.player2) this.player2.anims.resume();
        if (this.eagles) this.eagles.getChildren().forEach(e => e.anims.resume());
        if (this.snake) this.snake.anims.resume();
        if (this.rainEmitter) this.rainEmitter.resume();

        // ç§»é™¤æ‰€æœ‰æš«åœUI
        this.children.getAll().forEach(child => {
          if (child.depth >= 200) child.destroy();
        });
      }






    }
    //---------------------------------------------------------------------------------------------

    // å–®æ©Ÿé›™é€£é—œå¡å…±ç”¨é‚è¼¯
    class BaseLevelScene_mulit extends Phaser.Scene {
      constructor(key, config) {
        super({ key });
        this.levelConfig = Object.assign({ backgroundKey: '', timeLimit: 60, passScore: 0, nextScene: null, showSnake: false, showEagle: false }, config);
      }
      preload() {
        // å…±ç”¨è³‡æºâ€¦
        this.load.image('gr', 'asset/ground.png');
        this.load.image('black', 'asset/fruits/black.png');
        this.load.image('red', 'asset/fruits/red.png');
        this.load.image('gold', 'asset/fruits/gold.png');
        this.load.image('colorful', 'asset/fruits/colorful.png');
        this.load.spritesheet('player1', 'asset/player1.png', { frameWidth: 900, frameHeight: 472 });
        this.load.spritesheet('player2', 'asset/player2.png', { frameWidth: 900, frameHeight: 472 });
        this.load.image('btnRestart', 'asset/reset.png');
        this.load.image('btnReturn', 'asset/home.png');
        this.load.image('btnNext', 'asset/next.png');
        this.load.audio('btnselect1', 'asset/audio/select07.mp3');
        this.load.audio('clickselect1', 'asset/audio/click.mp3');
        this.load.audio('eatapple', 'asset/audio/eatapple.mp3');
        this.load.audio('eatapple_p2', 'asset/audio/eatapple_p2.mp3');


      }
      init(data) { this.mode = data.mode || 'single'; }
      create() {

        this.eatapple = this.sound.add('eatapple', { volume: this.game.sound.volume });

        // å¦‚æœä½ å¯¹ P2 ä¹Ÿæœ‰ä¸“é—¨çš„éŸ³æ•ˆï¼š
        this.eatapple_p2 = this.sound.add('eatapple_p2', { volume: this.game.sound.volume });

        this.btnSelectSound = this.sound.add('btnselect1');
        this.clickSelectSound = this.sound.add('clickselect1');
        this.isGameOver = false;
        this.input.enabled = true;
        this.add.image(400, 300, this.levelConfig.backgroundKey).setDisplaySize(800, 600);
        this.ground = this.physics.add.staticImage(this.scale.width / 2, this.scale.height - 1, 'gr')
          .setDisplaySize(this.scale.width, 40).setOrigin(0.5, 1).refreshBody();
        // P1
        this.player = this.physics.add.sprite(400, 0, 'player1').setScale(0.3).setOrigin(0.5, 1).setCollideWorldBounds(true);
        this.player.y = this.ground.y - this.ground.displayHeight;
        this.physics.add.collider(this.player, this.ground);
        this.player.body.setSize(260, 0).setOffset(380, 0);
        // P2
        this.player2 = this.physics.add.sprite(200, 0, 'player2').setScale(0.3).setOrigin(0.5, 1).setCollideWorldBounds(true);
        this.player2.y = this.ground.y - this.ground.displayHeight;
        this.physics.add.collider(this.player2, this.ground);
        this.player2.body.setSize(260, 0).setOffset(380, 0);

        this.wasd = this.input.keyboard.addKeys({ up: Phaser.Input.Keyboard.KeyCodes.W, left: Phaser.Input.Keyboard.KeyCodes.A, down: Phaser.Input.Keyboard.KeyCodes.S, right: Phaser.Input.Keyboard.KeyCodes.D });
        this.cursors = this.input.keyboard.createCursorKeys();
        this.createAnimations();

        // åˆ†æ•¸
        this.score = 0; this.score_p2 = 0;
        this.scoreText = this.add.text(16, 16, 'P1: 0', { fontFamily: 'a', fontSize: '36px', color: '#ff0000', strokeThickness: 2 });
        this.scoreText_p2 = this.add.text(16, 56, 'P2: 0', { fontFamily: 'a', fontSize: '36px', color: '#0000ff', strokeThickness: 2 });
        this.timeLeft = this.levelConfig.timeLimit;
        this.timerText = this.add.text(650, 16, 'Time: ' + this.timeLeft, { fontFamily: 'a', fontSize: '36px', color: '#ffa500', strokeThickness: 2 });
        this.timer = this.time.addEvent({ delay: 1000, callback: this.updateTimer, callbackScope: this, loop: true });

        // æ‰è½ç‰©
        this.fruits = this.physics.add.group();
        this.spawnEvent = this.time.addEvent({ delay: 800, callback: this.spawnFruit, callbackScope: this, loop: true });
        this.physics.add.overlap(this.player, this.fruits, this.collectFruit, null, this);
        this.physics.add.overlap(this.player2, this.fruits, this.collectFruitP2, null, this);

        // é·¹ã€è›‡ã€ç©æ°´ ä¹Ÿç¶çµ¦ P2
        if (this.levelConfig.showEagle) {
          this.eagles = this.physics.add.group();
          this.time.addEvent({ delay: 10000, callback: this.spawnEagle, callbackScope: this, loop: true });
          this.physics.add.overlap(this.player, this.eagles, this.hitEagle, null, this);
          this.physics.add.overlap(this.player2, this.eagles, this.hitEagle, null, this);
        }
        if (this.levelConfig.showSnake) {
          // å»¶è¿Ÿ 10 ç§’åï¼ˆæˆ–æ”¹æˆä½ æƒ³è¦çš„æ—¶æœºï¼‰ç”Ÿæˆè›‡
          this.time.delayedCall(10000, this.spawnSnake, null, this);
        }


        this.isHitP1 = false;
        this.isHitP2 = false;
        this.isPaused = false;
        this.pauseOverlay = null;
        this.input.keyboard.on('keydown-ESC', () => {
          this.isPaused ? this.resumeGame() : this.pauseGame();
        });






      }


      update() {


        if (this.isPaused) return;

        if (Phaser.Input.Keyboard.JustDown(this.cursors.up) && this.player.body.blocked.down) {
          this.player.setVelocityY(-350);       // èª¿æ•´è·³èºåŠ›é“
          // è·³éå¾Œé¢å·¦å³/è¹²ä¸‹é‚è¼¯
        }

        // 2ï¸âƒ£ å…ˆæŠŠæ°´å¹³é€Ÿåº¦æ­¸é›¶
        this.player.setVelocityX(0);




        const speed = 300 * (this.player.isSlowed ? 0.6 : 1);

        // 1. å…ˆè™•ç†å·¦å³ç§»å‹•ï¼Œä¸¦è¨˜éŒ„æœ€å¾Œä¸€æ¬¡æŒ‰çš„æ–¹å‘
        if (this.cursors.left.isDown) {
          this.player.setVelocityX(-speed);
          this.lastDirection = 'left';
        } else if (this.cursors.right.isDown) {
          this.player.setVelocityX(speed);
          this.lastDirection = 'right';
        } else {
          this.player.setVelocityX(0);
        }

        // 2. è‹¥æ­£åœ¨æŒ‰ã€Œä¸‹ã€å°±å„ªå…ˆåšè¹²ä¸‹
        if (this.cursors.down.isDown) {
          // åœæ­¢æ°´å¹³ç§»å‹•
          this.player.setVelocityX(0);
          // æ’­ lie å‹•ç•«
          this.player.anims.play('lie', true);
          // æ ¹æ“šæœ€å¾Œæ–¹å‘æ°´å¹³ç¿»è½‰
          this.player.setFlipX(this.lastDirection === 'left');
          return;    // ä¸å†åŸ·è¡Œå¾Œé¢çš„èµ°è·¯/å¾…æ©Ÿå‹•ç•«
        }

        // 3. èµ°è·¯ / å¾…æ©Ÿ
        if (this.player.body.velocity.x < 0) {
          // å¾€å·¦èµ°
          this.player.anims.play('walk_left', true);
          this.player.setFlipX(false);  // walk_left å·²ç¶“æ˜¯å·¦å‘ï¼Œä¸éœ€è¦å†ç¿»
        }
        else if (this.player.body.velocity.x > 0) {
          // å¾€å³èµ°
          this.player.anims.play('walk_right', true);
          this.player.setFlipX(false);
        }
        else {
          // å¾…æ©Ÿ
          this.player.anims.play('ready', true);
          // å¾…æ©Ÿè²¼åœ–ä¹Ÿè¦è·Ÿæ–¹å‘ä¸€è‡´
          this.player.setFlipX(this.lastDirection === 'left');
        }



        //-----------------
        // 1ï¸âƒ£ ä½¿ç”¨ W ä¾†è·³èºï¼ˆå° player1ï¼‰
        if (Phaser.Input.Keyboard.JustDown(this.wasd.up) && this.player2.body.blocked.down) {
          this.player2.setVelocityY(-350);
          // è·³éå¾Œé¢å·¦å³/è¹²ä¸‹é‚è¼¯
          return;
        }

        // 2ï¸âƒ£ å…ˆæŠŠæ°´å¹³é€Ÿåº¦æ­¸é›¶
        this.player2.setVelocityX(0);

        // 3ï¸âƒ£ æ°´å¹³ç§»å‹•ï¼ˆA / D æ§åˆ¶ player2ï¼‰
        const speed2 = 300 * (this.player2.isSlowed ? 0.6 : 1);
        if (this.wasd.left.isDown) {
          this.player2.setVelocityX(-speed2);
          this.lastDir2 = 'left';
        } else if (this.wasd.right.isDown) {
          this.player2.setVelocityX(speed2);
          this.lastDir2 = 'right';
        } else {
          this.player2.setVelocityX(0);
        }

        // 4ï¸âƒ£ è¹²ä¸‹ï¼ˆS éµå„ªå…ˆï¼‰
        if (this.wasd.down.isDown) {
          this.player2.setVelocityX(0);
          this.player2.anims.play('lie2', true);
          this.player2.setFlipX(this.lastDir2 === 'left');
          return;
        }

        // 5ï¸âƒ£ èµ°è·¯ / å¾…æ©Ÿ å‹•ç•«
        if (this.player2.body.velocity.x < 0) {
          this.player2.anims.play('walk_left2', true);
          this.player2.setFlipX(false);
        }
        else if (this.player2.body.velocity.x > 0) {
          this.player2.anims.play('walk_right2', true);
          this.player2.setFlipX(false);
        }
        else {
          this.player2.anims.play('ready2', true);
          this.player2.setFlipX(this.lastDir2 === 'left2');
        }



        // è›‡é‚Šç•Œåå½ˆ
        // æ ¹æ“šæ°´å¹³é€Ÿåº¦ç¿»è½‰è›‡çš„è²¼åœ–
        if (this.snake && this.snake.body && this.snake.body.velocity) {
          if (this.snake.body.velocity.x > 0) {
            this.snake.setFlipX(true);
          } else if (this.snake.body.velocity.x < 0) {
            this.snake.setFlipX(false);
          }
        }


        // æ¸…ç†é£›å‡ºç•«é¢è€é·¹
        if (this.eagles) {
          this.eagles.getChildren().forEach(eagle => {
            if (eagle.x < -50 || eagle.x > this.scale.width + 50) {
              eagle.destroy();
            }
          });
        }
      }

      createAnimations() {
        this.anims.create({ key: 'walk_left', frames: this.anims.generateFrameNumbers('player1', { start: 0, end: 3 }), frameRate: 8, repeat: -1 });
        this.anims.create({ key: 'ready', frames: [{ key: 'player1', frame: 4 }], frameRate: 1, repeat: -1 });
        this.anims.create({ key: 'walk_right', frames: this.anims.generateFrameNumbers('player1', { start: 5, end: 8 }), frameRate: 8, repeat: -1 });
        this.anims.create({ key: 'lie', frames: this.anims.generateFrameNumbers('player1', { start: 9, end: 9 }), frameRate: 8, repeat: -1 });

        //----------------------
        this.anims.create({ key: 'walk_left2', frames: this.anims.generateFrameNumbers('player2', { start: 0, end: 3 }), frameRate: 8, repeat: -1 });
        this.anims.create({ key: 'ready2', frames: [{ key: 'player2', frame: 4 }], frameRate: 1, repeat: -1 });
        this.anims.create({ key: 'walk_right2', frames: this.anims.generateFrameNumbers('player2', { start: 5, end: 8 }), frameRate: 8, repeat: -1 });
        this.anims.create({ key: 'lie2', frames: this.anims.generateFrameNumbers('player2', { start: 9, end: 9 }), frameRate: 8, repeat: -1 });

        if (this.levelConfig.showEagle) {
          this.anims.create({ key: 'eagle', frames: this.anims.generateFrameNumbers('eagle', { start: 0, end: 8 }), frameRate: 9, repeat: -1 });
        }
        if (this.levelConfig.showSnake) {
          this.anims.create({ key: 'snake_move', frames: this.anims.generateFrameNumbers('snake', { start: 0, end: 4 }), frameRate: 6, repeat: -1 });
        }


      }

      updateTimer() {
        this.timeLeft--;
        this.timerText.setText('Time: ' + this.timeLeft);
        if (this.timeLeft <= 0) {
          this.timer.remove(false);
          this.spawnEvent.remove(false);
          this.endLevel();
        }
      }

      spawnFruit() {
        const x = Phaser.Math.Between(50, 750);
        const rand = Math.random();
        let type;
        if (rand < 0.5) type = 'red';
        else if (rand < 0.7) type = 'black';
        else if (rand < 0.95) type = 'gold';
        else if (!this.rainbowDropped) { type = 'colorful'; this.rainbowsDropped = true; }
        else type = 'red';
        const fruit = this.fruits.create(x, 0, type).setScale(0.05);
        fruit.type = type;
        fruit.setVelocityY(150);
      }
      collectFruit(player, fruit) { fruit.destroy(); this.eatapple.play({ volume: this.game.sound.volume }); switch (fruit.type) { case 'red': this.score += 2; break; case 'gold': this.score += 10; break; case 'colorful': this.score += 100; break; case 'black': this.score -= 10; break; } this.scoreText.setText('P1: ' + this.score); }
      collectFruitP2(player2, fruit) { fruit.destroy(); this.eatapple_p2.play({ volume: this.game.sound.volume }); switch (fruit.type) { case 'red': this.score_p2 += 2; break; case 'gold': this.score_p2 += 10; break; case 'colorful': this.score_p2 += 100; break; case 'black': this.score_p2 -= 10; break; } this.scoreText_p2.setText('P2: ' + this.score_p2); }
      //------------------

      spawnEagle() {
        const { width } = this.scale;
        const y = 400;
        const fromLeft = Phaser.Math.Between(0, 1) === 0;
        const x = fromLeft ? -50 : width + 50;
        const speed = 200 * (fromLeft ? 1 : -1);
        const eagle = this.eagles.create(x, y, 'eagle').setOrigin(0.5).setScale(1).setDepth(50);
        eagle.body.allowGravity = false;
        eagle.setVelocityX(speed);
        eagle.setFlipX(!fromLeft);
        eagle.play('eagle');
      }

      spawnSnake() {
        this.snake = this.physics.add
          .sprite(50, 0, 'snake')
          .setOrigin(0.5, 1)
          .setScale(0.35)
          .setCollideWorldBounds(true)
          .setBounce(1, 0);

        const floorTopY = this.ground.y - this.ground.displayHeight;
        this.snake.y = floorTopY;
        this.snake.body.setSize(300, 80);
        this.snake.body.setOffset(
          -this.snake.displayWidth / 2 + 100,
          -this.snake.displayHeight + 100
        );

        this.physics.add.collider(this.snake, this.ground);
        this.snake.play('snake_move');
        this.snake.setVelocityX(100);

        // P1ã€P2 åŒæ—¶èƒ½æ’è›‡
        this.physics.add.overlap(this.player, this.snake, this.hitSnake, null, this);
        this.physics.add.overlap(this.player2, this.snake, this.hitSnake, null, this);
      }
      hitSnake(player, snake) {
        const isP1 = (player === this.player);
        const flag = isP1 ? 'isHitP1' : 'isHitP2';

        // å¦‚æœæ­£åœ¨å†·å´ï¼Œæˆ–è¶´ä¸‹æ— æ•Œï¼Œå°±ä¸å†æ‰£
        const downKey = isP1 ? this.cursors.down : this.wasd.down;
        if (this[flag] || downKey.isDown) return;

        // è¿›å…¥å†·å´
        this[flag] = true;

        // æ‰£åˆ†å¹¶æ›´æ–°å¯¹åº”æ–‡æœ¬
        if (isP1) {
          this.score -= 15;
          this.scoreText.setText('P1: ' + this.score);
        } else {
          this.score_p2 -= 15;
          this.scoreText_p2.setText('P2: ' + this.score_p2);
        }

        // æ’åˆ°çš„ç©å®¶é—ªçº¢
        player.setTint(0xff0000);
        this.time.delayedCall(500, () => player.clearTint());

        // å†·å´ç»“æŸåï¼Œå…è®¸å†æ¬¡æ‰£åˆ†
        this.time.delayedCall(1000, () => {
          this[flag] = false;
        });
      }

      hitEagle(player, eagle) {
        const isP1 = (player === this.player);

        // P1 ç”¨ cursors.downï¼ŒP2 ç”¨ wasd.S
        const isCrouching = isP1
          ? this.cursors.down.isDown
          : this.wasd.down.isDown;
        if (isCrouching) {
          return;
        }

        eagle.destroy();

        if (isP1) {
          this.score -= 20;
          this.scoreText.setText('P1: ' + this.score);
        } else {
          this.score_p2 -= 20;
          this.scoreText_p2.setText('P2: ' + this.score_p2);
        }

        // ç»™æ’åˆ°çš„é‚£ä¸ªç©å®¶ä¸Šè‰²
        player.setTint(0x4b0082);
        this.time.delayedCall(200, () => player.clearTint());
      }
      endLevel() {
        console.log('åŸ·è¡Œ endLevel()');
        if (this.isGameOver) return;
        this.isGameOver = true;

        // æš«åœä¸–ç•Œèˆ‡å‹•ç•«
        this.physics.pause();
        if (this.rainEmitter) this.rainEmitter.stop();
        this.player?.anims.stop();
        this.player2?.anims.stop();
        this.eagles?.getChildren().forEach(e => e.anims.stop());
        this.snake?.anims.stop();

        const W = this.scale.width;
        const H = this.scale.height;

        // åŠé€æ˜é®ç½©
        this.add.rectangle(0, 0, W, H, 0x000000, 0.7)
          .setOrigin(0)
          .setDepth(100);

        // åˆ¤æ–·å‹è² 
        let msg, color;
        if (this.score > this.score_p2) {
          msg = 'ç´…æ–¹å‹åˆ©ï¼';
          color = '#ff0000';
        } else if (this.score < this.score_p2) {
          msg = 'è—æ–¹å‹åˆ©ï¼';
          color = '#0000ff';
        } else {
          msg = 'å¹³ æ‰‹ ï¼';
          color = '#ffff00';
        }
        // ä¸»è¨Šæ¯
        this.add.text(W / 2, H / 2 - 120, msg, {
          fontFamily: 'a', fontSize: '64px', color, stroke: '#000', strokeThickness: 4
        }).setOrigin(0.5).setDepth(101);

        // é›™æ–¹æœ€çµ‚åˆ†æ•¸
        const scoreText = `ç´…æ–¹ï¼š${this.score}  |  è—æ–¹ï¼š${this.score_p2}`;
        this.add.text(W / 2, H / 2 - 40, scoreText, {
          fontFamily: 'a', fontSize: '32px', color: '#ffffff', stroke: '#000', strokeThickness: 2
        }).setOrigin(0.5).setDepth(101);

        // æŒ‰éˆ•ç¾¤ï¼ˆä¿æŒä¸è®Šï¼‰
        const btnY = H / 2 + 100;
        const gap = 200;
        const restart = this.add.image(W / 2 - gap, btnY, 'btnRestart')
          .setInteractive({ useHandCursor: true }).setScale(0.1).setDepth(101);
        restart
          .on('pointerover', () => { restart.setScale(0.15); this.btnSelectSound.play(); restart.setAlpha(0.8); })
          .on('pointerout', () => { restart.setScale(0.1); restart.setAlpha(1); })
          .on('pointerdown', () => { this.clickSelectSound.play(); this.scene.restart(); });

        const ret = this.add.image(W / 2, btnY, 'btnReturn')
          .setInteractive({ useHandCursor: true }).setScale(0.1).setDepth(101);
        ret
          .on('pointerover', () => { this.btnSelectSound.play(); ret.setScale(0.15); ret.setAlpha(0.8); })
          .on('pointerout', () => { ret.setScale(0.1); ret.setAlpha(1); })
          .on('pointerdown', () => { this.clickSelectSound.play(); this.scene.start('MenuScene'); });

        if (this.levelConfig.nextScene) {
          const next = this.add.image(W / 2 + gap, btnY, 'btnNext')
            .setInteractive({ useHandCursor: true }).setScale(0.1).setDepth(101);
          next
            .on('pointerover', () => { this.btnSelectSound.play(); next.setScale(0.15); next.setAlpha(0.8); })
            .on('pointerout', () => { next.setScale(0.1); next.setAlpha(1); })
            .on('pointerdown', () => { this.clickSelectSound.play(); this.scene.start(this.levelConfig.nextScene); });
        }
      }

      pauseGame() {
        if (this.isPaused) return;
        this.sound.pauseAll();
        this.isPaused = true;
        this.physics.world.pause();
        this.timer.paused = true;
        this.spawnEvent.paused = true;
        this.player.anims.pause();
        this.player2.anims.pause();
        if (this.eagles) this.eagles.getChildren().forEach(e => e.anims.pause());
        if (this.snake) this.snake.anims.pause();
        if (this.rainEmitter) this.rainEmitter.pause();

        // åŠé€æ˜é®ç½©
        this.pauseOverlay = this.add.rectangle(0, 0, this.scale.width, this.scale.height, 0x000000, 0.7)
          .setOrigin(0).setDepth(200);

        // æ–‡å­—
        this.add.text(this.scale.width / 2, this.scale.height / 2 - 120, 'éŠæˆ²æš«åœ', {
          fontFamily: 'a',
          fontSize: '64px',
          color: '#ffff00',
          stroke: '#000',
          strokeThickness: 4
        }).setOrigin(0.5).setDepth(201).setName('pauseText');

        const btnY = this.scale.height / 2 + 20;
        const gap = 200;

        // ä¸»ç•«é¢
        const btnHome = this.add.image(this.scale.width / 2 - gap, btnY, 'btnReturn')
          .setInteractive({ useHandCursor: true }).setScale(0.12).setDepth(201).setName('pauseBtnHome');
        btnHome
          .on('pointerover', () => {
            btnHome.setScale(0.15);
            btnHome.setAlpha(0.8);
            this.btnSelectSound.play();
          })
          .on('pointerout', () => {
            btnHome.setScale(0.12);
            btnHome.setAlpha(1);
          })
          .on('pointerdown', () => {
            this.clickSelectSound.play();
            this.resumeGame();
            this.scene.start('MenuScene');
          });

        // é‡ä¾†
        const btnRestart = this.add.image(this.scale.width / 2, btnY, 'btnRestart')
          .setInteractive({ useHandCursor: true }).setScale(0.12).setDepth(201).setName('pauseBtnRestart');
        btnRestart
          .on('pointerover', () => {
            btnRestart.setScale(0.15);
            btnRestart.setAlpha(0.8);
            this.btnSelectSound.play();
          })
          .on('pointerout', () => {
            btnRestart.setScale(0.12);
            btnRestart.setAlpha(1);
          })
          .on('pointerdown', () => {
            this.clickSelectSound.play();
            this.resumeGame();
            this.scene.restart();
          });

        // ç¹¼çºŒ
        const btnContinue = this.add.image(this.scale.width / 2 + gap, btnY, 'btnNext')
          .setInteractive({ useHandCursor: true }).setScale(0.12).setDepth(201).setName('pauseBtnContinue');
        btnContinue
          .on('pointerover', () => {
            btnContinue.setScale(0.15);
            btnContinue.setAlpha(0.8);
            this.btnSelectSound.play();
          })
          .on('pointerout', () => {
            btnContinue.setScale(0.12);
            btnContinue.setAlpha(1);
          })
          .on('pointerdown', () => {
            this.clickSelectSound.play();
            this.resumeGame();
          });
      }

      resumeGame() {
        if (!this.isPaused) return;
        this.sound.resumeAll();
        this.isPaused = false;
        this.physics.world.resume();
        this.timer.paused = false;
        this.spawnEvent.paused = false;
        this.player.anims.resume();
        this.player2.anims.resume();
        if (this.eagles) this.eagles.getChildren().forEach(e => e.anims.resume());
        if (this.snake) this.snake.anims.resume();
        if (this.rainEmitter) this.rainEmitter.resume();
        // åˆªé™¤ UI
        this.children.getAll().forEach(child => {
          if (child.depth >= 200) child.destroy();
        });
      }

    }
    //---------------------------------------------------------------------------------------------

    // å³æ™‚éŸ³é‡æ§åˆ¶-----------------------------------------------------------------------------------
    class SettingScene extends Phaser.Scene {
      constructor() {
        super({ key: 'SettingScene' });
      }
      preload() {
        this.load.image('setting_bg', 'asset/menu/bg.jpg');
        this.load.image('slider_bar', 'asset/slider_bar.png');
        this.load.image('slider_knob', 'asset/slider_knob.png');
        this.load.audio('btnselect', 'asset/audio/select07.mp3');
        this.load.audio('clickselect', 'asset/audio/click.mp3');
      }
      create() {
        // èƒŒæ™¯èˆ‡æ¨™é¡Œ
        this.add.image(400, 300, 'setting_bg').setDisplaySize(800, 600).setAlpha(0.4);
        this.add.text(400, 100, 'è¨­å®š', { fontFamily: 'a', fontSize: '48px', color: '#ffff00' })
          .setOrigin(0.5);

        // éŸ³æ•ˆéŸ³é‡æ¨™ç±¤
        this.add.text(300, 200, 'éŸ³é‡', { fontFamily: 'a', fontSize: '28px', color: '#fff' })
          .setOrigin(1, 0.5);

        // 1. å…ˆåˆ›å»ºç¤ºä¾‹éŸ³æ•ˆï¼Œå¸¦ä¸Šå½“å‰å…¨å±€éŸ³é‡
        const sampleSound = this.sound.add('btnselect', { volume: game.sound.volume });

        // 2. æ»‘æ†åº•ä¸ knob åŒä¹‹å‰
        this.add.image(420, 200, 'slider_bar').setOrigin(0, 0.5);
        const knob = this.add.image(420 + game.sound.volume * 220, 200, 'slider_knob')
          .setOrigin(0.5)
          .setInteractive({ draggable: true });
        this.input.setDraggable(knob);

        // 3. ç™¾åˆ†æ¯”æ–‡å­—
        const volText = this.add.text(650, 200, Math.round(game.sound.volume * 100) + '%', {
          fontFamily: 'a', fontSize: '24px', color: '#ffff00'
        }).setOrigin(0, 0.5);

        // æ‹–æ‹½å¼€å§‹ï¼šä»¥å½“å‰éŸ³é‡æ’­æ”¾ç¤ºä¾‹éŸ³
        knob.on('dragstart', () => {
          sampleSound.play({ loop: true, volume: game.sound.volume });
        });

        // æ‹–æ‹½ä¸­ï¼šæ›´æ–°éŸ³é‡å¹¶åŒæ­¥åˆ°ç¤ºä¾‹éŸ³
        knob.on('drag', (_pointer, dragX) => {
          dragX = Phaser.Math.Clamp(dragX, 420, 640);
          knob.x = dragX;
          const vol = (dragX - 420) / 220;
          game.sound.volume = vol;
          volText.setText(Math.round(vol * 100) + '%');
          sampleSound.setVolume(vol);
        });

        // æ‹–æ‹½ç»“æŸï¼šåœç¤ºä¾‹éŸ³å¹¶æ’­æ”¾ click æ•ˆæœ
        knob.on('dragend', () => {
          sampleSound.stop();
          this.sound.play('clickselect', { volume: game.sound.volume });
        });
        // è¿”å›ä¸»é¸å–®æŒ‰éˆ•
        const backBtn = this.add.text(400, 450, 'è¿”å›ä¸»é¸å–®', {
          fontFamily: 'a', fontSize: '32px', color: '#ff0000', backgroundColor: '#fff'
        }).setOrigin(0.5).setPadding(20, 8, 20, 8)
          .setInteractive({ useHandCursor: true });

        backBtn.on('pointerover', () => {
          backBtn.setStyle({ backgroundColor: '#ffc' });
          this.sound.play('btnselect');
        });
        backBtn.on('pointerout', () => backBtn.setStyle({ backgroundColor: '#fff' }));
        backBtn.on('pointerdown', () => {
          this.sound.play('clickselect');
          this.scene.start('MenuScene');
        });
      }
    }
    //---------------------------------------------------------------------------------------------





    // å–®æ©Ÿé—œå¡1å ´æ™¯---------------------------------------------------------------------------------
    class Level1Scene extends BaseLevelScene {
      constructor() {
        super('single_1Scene', {
          backgroundKey: 'level1',
          timeLimit: 60,
          passScore: 100,
          nextScene: 'single_2Scene',
          showSnake: false,
          showEagle: false
        });
      }

      preload() {
        super.preload();
        this.load.image('level1', 'asset/menu/sence/level1.jpg');

      }
      update() {
        super.update();
      }
    }
    //---------------------------------------------------------------------------------------------

    // å–®æ©Ÿé—œå¡2å ´æ™¯
    class Level2Scene extends BaseLevelScene {
      constructor() {
        super('single_2Scene', {
          backgroundKey: 'level2',
          timeLimit: 60,
          passScore: 150,
          nextScene: 'single_3Scene',
          showSnake: true,
          showEagle: true
        });
      }

      preload() {
        super.preload();
        this.load.image('level2', 'asset/menu/sence/level2.jpg');
        this.load.spritesheet('snake', 'asset/snake.png', { frameWidth: 330, frameHeight: 136 });
        this.load.spritesheet('eagle', 'asset/engle.png', { frameWidth: 68, frameHeight: 115 });
        // ä¸å†è¼‰å…¥ raindropã€puddle
      }

      create() {
        super.create();
        // ç¾åœ¨é€™è£¡ä¸åšä»»ä½•ä¸‹é›¨æˆ– puddle çš„è¨­å®š
        this.lastDirection = 'right';
      }

      update() {
        super.update();
        // ï¼ˆå¦‚æœ‰éœ€è¦ï¼Œå¯ä»¥åœ¨é€™è£¡åš puddle å½±éŸ¿çµæŸå¾Œçš„é‚„åŸï¼‰
      }
    }
    //---------------------------------------------------------------------------------------------

    // å–®æ©Ÿé—œå¡3å ´æ™¯ ------------------------------------------------------------------------------------------------------
    class Level3Scene extends BaseLevelScene {
      constructor() {
        super('single_3Scene', {
          backgroundKey: 'level3',
          timeLimit: 60,
          passScore: 200,
          nextScene: 'EndStoryScene',
          showSnake: true,
          showEagle: true
        });
      }

      preload() {
        super.preload();
        this.load.image('level3', 'asset/menu/sence/level3.jpg');
        this.load.spritesheet('snake', 'asset/snake.png', { frameWidth: 330, frameHeight: 136 });
        this.load.spritesheet('eagle', 'asset/engle.png', { frameWidth: 68, frameHeight: 115 });
        // ä¸‹é›¨æ‰€éœ€è³‡æº
        this.load.image('raindrop', 'asset/raindrop.png');
        this.load.image('puddle', 'asset/puddle.png');
      }

      create() {
        super.create();

        // â€”â€” ä¸‹é›¨ç²’å­æ•ˆæœ â€”â€” 
        const W = this.scale.width, H = this.scale.height;
        const rainParticles = this.add.particles('raindrop');
        this.rainEmitter = rainParticles.createEmitter({
          x: { min: 0, max: W },
          y: 0,
          lifespan: 2000,
          speedY: { min: 400, max: 600 },
          scale: { start: 0.02, end: 0.02 },
          quantity: 2,
          frequency: 50,
          blendMode: 'NORMAL'
        });
        rainParticles.setDepth(5);
        // æ­»å€ï¼šä¸€é€²åˆ°åœ°æ¿é ‚ç«¯ä»¥ä¸‹å°± kill
        const groundTopY = this.ground.y - this.ground.displayHeight;
        this.rainEmitter.setDeathZone({
          type: 'onEnter',
          source: new Phaser.Geom.Rectangle(0, groundTopY, W, H - groundTopY)
        });

        // puddles ç¾¤çµ„
        this.puddles = this.physics.add.staticGroup();


        // æ¯ 5 ç§’åˆ‡æ›ä¸€æ¬¡ spawn/remove puddles
        this.shouldSpawn = true;
        this.time.addEvent({
          delay: 5000,
          callback: this.togglePuddles,
          callbackScope: this,
          loop: true
        });

        this.lastDirection = 'right';
      }

      togglePuddles() {
        const groundTopY = this.ground.y - this.ground.displayHeight;
        if (this.shouldSpawn) {
          for (let i = 0; i < 2; i++) {
            const x = Phaser.Math.Between(50, this.scale.width - 50);
            this.puddles.create(x, groundTopY, 'puddle')
              .setOrigin(0.5, 0.5)
              .setScale(0.08)
              .refreshBody();
          }
        } else {
          const children = this.puddles.getChildren();
          for (let i = 0; i < 2 && children.length > 0; i++) {
            children[0].destroy();
          }
        }
        this.shouldSpawn = !this.shouldSpawn;
      }

      update() {
        super.update();
        // é€™è£¡å¦‚æœè¦åœ¨ player é›¢é–‹ puddle å¾Œå–æ¶ˆ slowï¼Œå¯ä»¥åŠ é‚„åŸé‚è¼¯
        if (this.puddles) {
          let isOnPuddle = false;
          this.puddles.getChildren().forEach(puddle => {
            if (Phaser.Geom.Intersects.RectangleToRectangle(this.player.getBounds(), puddle.getBounds())) {
              isOnPuddle = true;
            }
          });
          this.player.isSlowed = isOnPuddle;
        }
      }

    }

    //---------------------------------------------------------------------------------------------




    // å–®æ©Ÿé›™é€£é—œå¡1å ´æ™¯---------------------------------------------------------------------------------
    class Level1Scene_mulit extends BaseLevelScene_mulit {
      constructor() {
        super('Level1Scene_mulit', {
          backgroundKey: 'level1',
          timeLimit: 60,
          passScore: 1,
          nextScene: 'Level2Scene_mulit',
          showSnake: false,
          showEagle: false
        });
      }

      preload() {
        super.preload();
        this.load.image('level1', 'asset/menu/sence/level1.jpg');

      }
      update() {
        super.update();
      }
    }

    //---------------------------------------------------------------------------------------------


    // å–®æ©Ÿé›™é€£é—œå¡2å ´æ™¯---------------------------------------------------------------------------------
    class Level2Scene_mulit extends BaseLevelScene_mulit {
      constructor() {
        super('Level2Scene_mulit', {
          backgroundKey: 'level2',
          timeLimit: 60,
          passScore: 1,
          nextScene: 'Level3Scene_mulit',
          showSnake: true,
          showEagle: true
        });
      }

      preload() {
        super.preload();
        this.load.image('level2', 'asset/menu/sence/level2.jpg');
        this.load.spritesheet('snake', 'asset/snake.png', { frameWidth: 330, frameHeight: 136 });
        this.load.spritesheet('eagle', 'asset/engle.png', { frameWidth: 68, frameHeight: 115 });
        // ä¸å†è¼‰å…¥ raindropã€puddle
      }

      create() {
        super.create();
        // ç¾åœ¨é€™è£¡ä¸åšä»»ä½•ä¸‹é›¨æˆ– puddle çš„è¨­å®š
        this.lastDirection = 'right';
      }

      update() {
        super.update();
        // ï¼ˆå¦‚æœ‰éœ€è¦ï¼Œå¯ä»¥åœ¨é€™è£¡åš puddle å½±éŸ¿çµæŸå¾Œçš„é‚„åŸï¼‰
      }
    }
    //---------------------------------------------------------------------------------------------


    // å–®æ©Ÿé›™é€£é—œå¡2å ´æ™¯---------------------------------------------------------------------------------
    class Level3Scene_mulit extends BaseLevelScene_mulit {
      constructor() {
        super('Level3Scene_mulit', {
          backgroundKey: 'level3',
          timeLimit: 60,
          passScore: 0,
          nextScene: false,
          showSnake: true,
          showEagle: true
        });
      }

      preload() {
        super.preload();
        this.load.image('level3', 'asset/menu/sence/level3.jpg');
        this.load.spritesheet('snake', 'asset/snake.png', { frameWidth: 330, frameHeight: 136 });
        this.load.spritesheet('eagle', 'asset/engle.png', { frameWidth: 68, frameHeight: 115 });
        // ä¸‹é›¨æ‰€éœ€è³‡æº
        this.load.image('raindrop', 'asset/raindrop.png');
        this.load.image('puddle', 'asset/puddle.png');
      }

      create() {
        super.create();

        // â€”â€” ä¸‹é›¨ç²’å­æ•ˆæœ â€”â€” 
        const W = this.scale.width, H = this.scale.height;
        const rainParticles = this.add.particles('raindrop');
        this.rainEmitter = rainParticles.createEmitter({
          x: { min: 0, max: W },
          y: 0,
          lifespan: 2000,
          speedY: { min: 400, max: 600 },
          scale: { start: 0.02, end: 0.02 },
          quantity: 2,
          frequency: 50,
          blendMode: 'NORMAL'
        });
        rainParticles.setDepth(5);

        const groundTopY = this.ground.y - this.ground.displayHeight;
        this.rainEmitter.setDeathZone({
          type: 'onEnter',
          source: new Phaser.Geom.Rectangle(0, groundTopY, W, H - groundTopY)
        });

        // puddles ç¾¤çµ„
        this.puddles = this.physics.add.staticGroup();


        this.shouldSpawn = true;
        this.time.addEvent({
          delay: 5000,
          callback: this.togglePuddles,
          callbackScope: this,
          loop: true
        });

        this.lastDirection = 'right';
      }

      // è£œä¸€å€‹ togglePuddles åˆ° Level3Scene_mulit class
      togglePuddles() {
        const groundTopY = this.ground.y - this.ground.displayHeight;
        if (this.shouldSpawn) {
          for (let i = 0; i < 2; i++) {
            const x = Phaser.Math.Between(50, this.scale.width - 50);
            this.puddles.create(x, groundTopY, 'puddle')
              .setOrigin(0.5, 0.5)
              .setScale(0.08)
              .refreshBody();
          }
        } else {
          const children = this.puddles.getChildren();
          for (let i = 0; i < 2 && children.length > 0; i++) {
            children[0].destroy();
          }
        }
        this.shouldSpawn = !this.shouldSpawn;
      }
      update() {
        super.update();
        // puddle æª¢æŸ¥
        let isOnPuddle1 = false, isOnPuddle2 = false;
        if (this.puddles) {
          this.puddles.getChildren().forEach(puddle => {
            if (Phaser.Geom.Intersects.RectangleToRectangle(this.player.getBounds(), puddle.getBounds())) {
              isOnPuddle1 = true;
            }
            if (Phaser.Geom.Intersects.RectangleToRectangle(this.player2.getBounds(), puddle.getBounds())) {
              isOnPuddle2 = true;
            }
          });
        }
        this.player.isSlowed = isOnPuddle1;
        this.player2.isSlowed = isOnPuddle2;


      }





    }

    class EndStoryScene extends Phaser.Scene {
      constructor() { super({ key: 'EndStoryScene' }); }
      preload() {
        this.load.image('level3', 'asset/menu/sence/level3.jpg');
      }
      create() {
        const bg = this.add.image(400, 300, 'level3').setDisplaySize(800, 600).setAlpha(0.7);
        const { width, height } = this.sys.game.config;
        const rectW = width - 100, rectH = height * 0.7;
        const rectX = width / 2, rectY = height / 2, pad = 5;
        this.add.rectangle(rectX, rectY, rectW, rectH, 0x000000, 0.6).setOrigin(0.5);
        const maskG = this.make.graphics();
        maskG.fillRect(rectX - rectW / 2, rectY - rectH / 2, rectW, rectH);
        const mask = maskG.createGeometryMask();
        this.fullText = endstoryText.join(' ');
        this.text = this.add.text(rectX - rectW / 2 + pad, rectY - rectH / 2 + pad, '', {
          fontFamily: 'a', fontSize: '24px', color: '#ffffff', align: 'left',
          wordWrap: { width: rectW - pad * 2, useAdvancedWrap: true },
          lineSpacing: 30
        }).setOrigin(0).setMask(mask);
        this.charIndex = 0;
        this.typeNextChar();
      }
      typeNextChar() {
        this.charIndex++;
        this.text.setText(this.fullText.substr(0, this.charIndex));
        if (this.charIndex < this.fullText.length) {
          this.time.delayedCall(40, this.typeNextChar, [], this);
        } else {
          this.time.delayedCall(500, () => this.scene.start('CreditScene'));
        }
      }
    }

    // æ–°å¢è£½ä½œåœ˜éšŠå ´æ™¯ï¼šCreditScene
    class CreditScene extends Phaser.Scene {
      constructor() { super({ key: 'CreditScene' }); }
      preload() {
        this.load.image('level3', 'asset/menu/sence/level3.jpg');
      }



      create() {
        const bg = this.add.image(400, 300, 'level3').setDisplaySize(800, 600).setAlpha(0.7);
        const W = this.scale.width, H = this.scale.height;
        const credits = [
          'è£½ä½œåœ˜éšŠ',
          'è£½ä½œäººï¼š\né™³æŸç¿Ray\n è‘‰ä¿¡å®Yeah\næé•·è»’Sherwin\nå³ç´˜ç¿Henry',
          'è…³æœ¬ï¼š\né™³æŸç¿Ray\n è‘‰ä¿¡å®Yeah\næé•·è»’Sherwin\nå³ç´˜ç¿Henry',
          'ç¨‹å¼ï¼š\né™³æŸç¿Ray',
          'ç¾è¡“ï¼š\né™³æŸç¿Ray\n è‘‰ä¿¡å®Yeah',
          'éŸ³æ•ˆï¼š\né™³æŸç¿Ray\nOpen Game Artâ„¢',
          'æ„Ÿè¬éŠç©ï¼'
        ];
        const creditText = this.add.text(W / 2, H + 20, credits.join('\n'), {
          fontFamily: 'a', fontSize: '32px', color: '#ffffff', align: 'center', lineSpacing: 32
        }).setOrigin(0.5, 0);
        const maskG = this.make.graphics();
        maskG.fillRect(50, 50, W - 100, H - 100);
        const mask = maskG.createGeometryMask();
        creditText.setMask(mask);
        const totalHeight = creditText.height + 100;
        this.tweens.add({
          targets: creditText,
          y: -totalHeight,
          ease: 'Linear',
          duration: totalHeight * 20,
          onComplete: () => {
            this.input.on('wheel', (_p, _g, _dx, dy) => {
              creditText.y -= dy;
              const minY = H - creditText.height - 50;
              const maxY = 50;
              if (creditText.y < minY) creditText.y = minY;
              if (creditText.y > maxY) creditText.y = maxY;
            });
            // é¡¯ç¤ºä¸»ç•«é¢æŒ‰éˆ•
            const btn = this.add.text(W - 20, H - 20, 'ä¸»ç•«é¢', {
              fontFamily: 'a', fontSize: '24px', color: '#ffff00', backgroundColor: '#000', padding: { x: 10, y: 5 }
            }).setOrigin(1, 1).setInteractive({ useHandCursor: true });
            btn.on('pointerdown', () => this.scene.start('MenuScene'));
          }
        });
      }
    }

    //---------------------------------------------------------------------------------------------





    // æ›´æ–°éŠæˆ²é…ç½®----------------------------------------------------------------------------------------------
    const config = {
      type: Phaser.AUTO,
      width: 800,
      height: 600,
      backgroundColor: '#2d2d2d',
      pixelArt: true,
      physics: {
        default: 'arcade',
        arcade: { gravity: { y: 500 }, debug: false, debugShowBody: false, debugShowVelocity: false }
      },
      scene: [BootScene, MenuScene, StoryScene, ModeScene, Level1Scene, Level2Scene, Level3Scene, Level1Scene_mulit, Level2Scene_mulit, Level3Scene_mulit, MulitLevelSelectScene, SettingScene, EndStoryScene, CreditScene]
    };

    // åˆå§‹åŒ–éŠæˆ²
    const game = new Phaser.Game(config);

  </script>
</body>

</html>
<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <title>Phaser UI Example</title>
  <script src="./asset/phaser@3.55.2.min.js"></script>
  //
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fontfaceobserver/2.1.0/fontfaceobserver.standalone.js"></script>
  <!-- å¼•å…¥ FontFaceObserver -->
  <!-- <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js"></script> -->
</head>

<body>

  <style>
    @font-face {
      font-family: 'a';
      src: url('asset/fonts/Cubic_11.woff') format('woff');

    }

    /* è®“æ•´å€‹é é¢ä½”æ»¿è¦–çª—ï¼Œä¸¦ç§»é™¤æ»¾å‹•æ¢ */
    html,
    body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background-color: #000;
      overflow: hidden;
    }

    /* Phaser æœƒè‡ªå‹•æ’å…¥ <canvas>ï¼Œè®“å®ƒä¸ç•™ç©ºéš™ */
    canvas {
      display: block;
    }
  </style>

  <script>
    // -------------------------------------------------------
    // BootSceneï¼šåªè² è²¬æ’­æ”¾èƒŒæ™¯éŸ³æ¨‚ä¸¦å•Ÿå‹• MenuScene
    // -------------------------------------------------------
    class BootScene extends Phaser.Scene {
      constructor() {
        super({ key: 'BootScene', active: true });
      }

      preload() {
        this.load.audio('bgm', 'asset/audio/bgm.mp3');
      }

      create() {

        this.sound.play('bgm', { loop: true, volume: 1 });
        this.scene.launch('MenuScene');
      }
    }

    // -------------------------------------------------------
    // MenuSceneï¼šå«èƒŒæ™¯å½±ç‰‡ã€æŒ‰éˆ•ã€å­—é«”è¼‰å…¥
    // -------------------------------------------------------
    class MenuScene extends Phaser.Scene {
      constructor() {
        super({ key: 'MenuScene' });
      }

      preload() {
        // å¤§å»³ BGM ï¼ˆå¦‚æœä½ åœ¨ BootScene å·²è¼‰å…¥ï¼Œä¹Ÿå¯ä»¥ä¸é‡è¤‡è¼‰ï¼‰
        // this.load.audio('bgm', 'asset/audio/bgm.mp3');

        // UI éŸ³æ•ˆ
        this.load.audio('btnselect', 'asset/audio/select07.mp3');
        this.load.audio('clickselect', 'asset/audio/click.mp3');

        // èƒŒæ™¯å½±ç‰‡ + å‚™ç”¨èƒŒæ™¯
        this.load.video('home', 'asset/video/home.mp4', 'loadeddata', false, true);
        this.load.image('bg', 'asset/menu/bg.jpg');

        // æŒ‰éˆ•ç´ æ
        this.load.image('btn_start', 'asset/menu/btn_start.png');
        this.load.image('btn_setting', 'asset/menu/btn_setting.png');
        this.load.image('btn_exit', 'asset/menu/btn_exit.png');

        // ï¼ˆå¯é¸ï¼‰å­—é«”è¼‰å…¥è…³æœ¬
        // this.load.script('fontface', 'https://cdnjs.cloudflare.com/.../fontfaceobserver.standalone.js');
      }

      create() {
        const W = this.scale.width;
        const H = this.scale.height;
        this.sound.stopAll();

        // 1. ç¢ºä¿å¤§å»³ BGM æ­£åœ¨æ’­
        const bgmSound = this.sound.get('bgm');
        if (!bgmSound || !bgmSound.isPlaying) {
          this.sound.play('bgm', { loop: true, volume: 1 });
        }

        // 2. èƒŒæ™¯å½±ç‰‡
        const homeVideo = this.add.video(W / 2, H / 2, 'home')
          .setDisplaySize(W, H)
          .setDepth(0)
          .setMute(true);

        const raw = homeVideo.video;
        let revInt = null;
        const startReverse = () => {
          raw.pause();
          setTimeout(() => {
            revInt = setInterval(() => {
              if (raw.currentTime <= 0.04) {
                clearInterval(revInt);
                setTimeout(() => { raw.currentTime = 0.01; raw.play(); }, 500);
              } else {
                raw.currentTime -= 1 / 45;
              }
            }, 1000 / 45);
          }, 500);
        };
        raw.addEventListener('ended', startReverse);
        raw.currentTime = 0.01;
        homeVideo.play(false);
        this.events.on('shutdown', () => {
          if (revInt) clearInterval(revInt);
          raw.removeEventListener('ended', startReverse);
        });

        // 3. éœæ…‹å‚™ç”¨èƒŒæ™¯
        this.add.image(W / 2, H / 2, 'bg')
          .setDisplaySize(W, H)
          .setDepth(-1);

        // 4. UI éŸ³æ•ˆå›é¥‹
        const overSound = this.sound.add('btnselect');
        const clickSound = this.sound.add('clickselect');
        this.input.on('gameobjectover', () => overSound.play());
        this.input.on('gameobjectdown', () => clickSound.play());

        // 5. æ¨™é¡Œæ–‡å­—ï¼ˆFontFaceObserver å¯é¸ï¼‰
        if (window.FontFaceObserver) {
          new FontFaceObserver('a').load().then(() => {
            const spaced = 'çµäºº\u200AX\u200Aè˜‹æœ'.split('').join('\u200A');
            this.add.text(W / 2, H * 0.15, spaced, {
              fontFamily: 'a',
              fontSize: '100px'
            })
              .setOrigin(0.5)
              .setTintFill(0xff0000, 0xffff00, 0xff6600, 0xffffff);
          }).catch(() => {
            this.add.text(W / 2, H * 0.15, 'çµäººXè˜‹æœ', {
              fontFamily: 'Arial', fontSize: '64px', color: '#fff'
            }).setOrigin(0.5);
          });
        } else {
          this.add.text(W / 2, H * 0.15, 'çµäººXè˜‹æœ', {
            fontFamily: 'Arial', fontSize: '64px', color: '#fff'
          }).setOrigin(0.5);
        }

        // 6. START æŒ‰éˆ•
        const startBtn = this.add.image(W / 2, H * 0.417, 'btn_start')
          .setOrigin(0.5).setScale(0.35)
          .setInteractive({ useHandCursor: true });
        startBtn
          .on('pointerover', () => startBtn.setScale(0.38).setAlpha(0.8))
          .on('pointerout', () => startBtn.setScale(0.35).setAlpha(1))
          .on('pointerdown', () => {
            clickSound.play();
            this.scene.start('StoryScene');
          });

        // 7. SETTING æŒ‰éˆ•
        const setBtn = this.add.image(W / 2, H * 0.667, 'btn_setting')
          .setOrigin(0.5).setScale(0.35)
          .setInteractive({ useHandCursor: true });
        setBtn
          .on('pointerover', () => setBtn.setScale(0.38).setAlpha(0.8))
          .on('pointerout', () => setBtn.setScale(0.35).setAlpha(1))
          .on('pointerdown', () => {
            clickSound.play();
            this.scene.start('SettingScene');
          });

        // 8. EXIT æŒ‰éˆ•
        const exitBtn = this.add.image(W / 2, H * 0.917, 'btn_exit')
          .setOrigin(0.5).setScale(0.35)
          .setInteractive({ useHandCursor: true });
        exitBtn
          .on('pointerover', () => exitBtn.setScale(0.38).setAlpha(0.8))
          .on('pointerout', () => exitBtn.setScale(0.35).setAlpha(1))
          .on('pointerdown', () => window.close());
      }

      update() {
        // MenuScene ä¸éœ€è¦æ¯å¹€æ›´æ–°
      }
    }


    // -------------------------------------------------------
    // StorySceneï¼šé¡¯ç¤ºæ•…äº‹æ–‡å­—ï¼Œæ‰“å­—ç‰¹æ•ˆï¼Œå¯è·³é
    // -------------------------------------------------------
    const storyText = [
      "åœ¨é™é çš„æ£®æ—æ·±è™•ï¼Œæœ‰ä¸€æ£µå·¨å¤§çš„è˜‹æœæ¨¹ï¼Œé€™æ£µå·¨æ¨¹è³ç«‹åœ¨è¬å¹´å¤æ—ä¸­ã€‚",
      "æ¯ç•¶è˜‹æœæˆç†Ÿæ™‚ï¼Œæ¨¹ä¸Šæœƒæ‰è½é–ƒäº®çš„é‡‘è‰²è˜‹æœï¼Œå‚³èå®ƒçš„æœå¯¦æ¯åƒä¸€é¡†å°±èƒ½å»¶å£½ä¸€å¹´ã€‚",
      "é‹æ°£å¥½ç”šè‡³å¯èƒ½æœƒé‡è¦‹æ›´ç¨€æœ‰çš„å½©è™¹è˜‹æœï¼Œåƒä¸‹å»èƒ½å¾—æ°¸ç”Ÿã€‚",
      "é€™äº›è˜‹æœå¸å¼•äº†ç„¡æ•¸å†’éšªè€…å’Œå°‹å¯¶çµäººçš„ç›®å…‰ã€‚",
      "ä½ æ˜¯ä¸€åå¹´è¼•çš„å°‹å¯¶çµäººï¼Œæ±ºå®šæ·±å…¥æ£®æ—ï¼Œå†’éšªå°‹æ‰¾é€™æ£µç¥å¥‡çš„è˜‹æœæ¨¹ã€‚",
      "ç•¶ä½ é‹æ°£å¥½æˆåŠŸæ‰¾åˆ°äº†ï¼Œæ­£æƒ³ä¾é å®ƒç™¼å®¶è‡´å¯Œæ™‚",
      "å»é­é‡è¨±å¤šå±æ©Ÿ",
      "æœ‰å¤§è€é·¹å¾ˆèŸ’è›‡ç­‰è‘—ä½ ï¼Œç”šè‡³æ˜¯æƒ¡åŠ£çš„å¤©æ°£",
      "ä½ å†’è‘—ç”Ÿå‘½å±éšªé—–å…¥æ£®æ—æ·±è™•ï¼Œæ˜¯æ­»ä¹Ÿè¦æˆåŠŸæŠŠå‚³èªªä¸­çš„å½©è™¹è˜‹æœå¸¶å›å»ã€‚"
    ];

    class StoryScene extends Phaser.Scene {
      constructor() {
        super({ key: 'StoryScene' });
      }

      preload() {
        this.load.image('bg', 'asset/menu/bg.png');
      }

      create() {
        const W = this.scale.width;
        const H = this.scale.height;

        // èƒŒæ™¯åœ–
        this.add.image(W / 2, H / 2, 'bg')
          .setDisplaySize(W, H)
          .setAlpha(0.7);

        // çŸ©å½¢æ¡†å°ºå¯¸
        const rectWidth = W - 100;
        const rectHeight = H * 0.7;
        const rectX = W / 2;
        const rectY = H / 2;
        const padding = 5;

        // èƒŒæ™¯æ¡†ï¼ˆåŠé€æ˜é»‘ï¼‰
        this.add.rectangle(rectX, rectY, rectWidth, rectHeight, 0x000000, 0.6)
          .setOrigin(0.5);

        // å»ºç«‹é®ç½©
        const maskG = this.make.graphics();
        maskG.fillRect(
          rectX - rectWidth / 2,
          rectY - rectHeight / 2,
          rectWidth,
          rectHeight
        );
        const mask = maskG.createGeometryMask();

        // å…¨æ–‡åˆä½µ
        this.fullText = storyText.join(' ');

        // æ–‡å­—ç‰©ä»¶ï¼ˆæ‰“å­—å€åŸŸï¼‰
        this.text = this.add.text(
          rectX - rectWidth / 2 + padding,
          rectY - rectHeight / 2 + padding,
          '',
          {
            fontFamily: 'a',
            fontSize: '24px',
            color: '#ffffff',
            wordWrap: {
              width: rectWidth - padding * 2,
              useAdvancedWrap: true
            }
          }
        )
          .setOrigin(0, 0)
          .setMask(mask);

        // åº•éƒ¨æç¤ºæ–‡å­—
        this.add.text(W / 2, H - 20, 'æŒ‰ SPACE éµè·³é', {
          fontFamily: 'a',
          fontSize: '36px',
          color: '#ffffff'
        })
          .setOrigin(0.5, 1);

        // æ‰“å­—ç‰¹æ•ˆåˆå§‹åŒ–
        this.charIndex = 0;
        this.typeNextChar();

        // æŒ‰ SPACE è·³é
        this.input.keyboard.on('keydown-SPACE', () => this.skipStory());
      }

      typeNextChar() {
        this.charIndex++;
        this.text.setText(this.fullText.substr(0, this.charIndex));

        if (this.charIndex < this.fullText.length) {
          this.time.delayedCall(40, () => this.typeNextChar());
        } else {
          this.time.delayedCall(1500, () => {
            this.scene.start('ModeScene');
          });
        }
      }

      skipStory() {
        this.time.removeAllEvents();
        this.scene.start('ModeScene');
      }
    }

    // -------------------------------------------------------
    // ModeSceneï¼šé¡¯ç¤ºæ“ä½œèªªæ˜ï¼Œå®Œæˆå¾Œé¡¯ç¤ºæŒ‰éˆ•
    // -------------------------------------------------------
    class ModeScene extends Phaser.Scene {
      constructor() {
        super({ key: 'ModeScene' });
      }

      preload() {
        this.load.audio('btnselect', 'asset/audio/select07.mp3');
        this.load.audio('clickselect', 'asset/audio/click.mp3');
        this.load.image('single', 'asset/menu/playmode/single.png');
        this.load.image('mulit', 'asset/menu/playmode/mulit.png');
        this.load.image('back', 'asset/back.png');
        this.load.image('modebg', 'asset/menu/modebg.jpeg');
      }

      create() {
        const W = this.scale.width;
        const H = this.scale.height;

        // 1) èƒŒæ™¯åœ–ï¼ˆåŠé€æ˜ï¼‰
        this.add
          .image(W / 2, H / 2, 'modebg')
          .setDisplaySize(W, H)
          .setDepth(0);

        this.helpTexts = [
          'ã€ P1æ¨¡å¼ æ§åˆ¶æ–¹å¼ ã€‘\n\n' +
          'â† / â†’  â†â†’ ç§»å‹•\n' +
          'â†‘        è·³èº\n' +
          'â†“        è¶´ä¸‹\n\n' +
          'ã€  P2æ¨¡å¼ æ§åˆ¶æ–¹å¼ ã€‘\n\n' +
          'A / D  â†â†’ ç§»å‹•\n' +
          'W        è·³èº\n' +
          'S        è¶´ä¸‹\n\n' +
          'æŒ‰ä»»æ„éµæˆ–é»æ“Šï¼Œç¹¼çºŒä¸‹ä¸€æ®µèªªæ˜',

          'ã€ éŠæˆ²ç›®æ¨™ ã€‘\n\n' +
          ' æ¯é—œå¡é™æ™‚60ç§’ \n\n' +
          'ã€ P1æ¨¡å¼ ã€‘éé—œæ¨™æº–åˆ†åˆ¥100ã€150ã€200 \n\n' +
          'ã€ P2æ¨¡å¼ ã€‘æ¯”èª°çš„åˆ†æ•¸æ¯”è¼ƒå¤š \n\n',

          'ã€ æ³¨æ„äº‹é … ã€‘\n\n' +
          '1.ğŸçš„ç¨®é¡ä¸åŒæœƒåŠ åˆ†èˆ‡æ‰£åˆ†ã€‚\n\n' +
          '2.ğŸè¦éš¨æ™‚æ³¨æ„ç¶ ç¶ é•·é•·(-15)ã€‚\n\n' +
          '3.ğŸ¦…å°å¿ƒé£›éé ­ä¸Š(-20)ã€‚\n\n' +
          'æŒ‰ä»»æ„éµæˆ–é»æ“Šï¼Œé–‹å§‹éŠæˆ²ï½'
        ];

        this.currentHelpIndex = 0;

        // é®ç½©
        this.overlay = this.add
          .rectangle(0, 0, W, H, 0x000000, 0.7)
          .setOrigin(0)
          .setDepth(1000);

        // èªªæ˜æ–‡å­—
        this.helpText = this.add
          .text(
            W / 2,
            H / 2,
            this.helpTexts[this.currentHelpIndex],
            {
              fontFamily: 'a',
              fontSize: '28px',
              color: '#ffffff',
              align: 'center',
              wordWrap: { width: W * 0.8, useAdvancedWrap: true }
            }
          )
          .setOrigin(0.5)
          .setDepth(1001);

        // ä¸€æ¬¡æ€§æŒ‰éµæˆ–é»æ“Šäº‹ä»¶
        this.input.keyboard.once('keydown', () => {
          this.showNextHelp();
        });
        this.input.once('pointerdown', () => {
          this.showNextHelp();
        });
      }

      showNextHelp() {
        this.currentHelpIndex++;

        if (this.currentHelpIndex < this.helpTexts.length) {
          this.helpText.setText(this.helpTexts[this.currentHelpIndex]);

          this.input.keyboard.once('keydown', () => {
            this.showNextHelp();
          });
          this.input.once('pointerdown', () => {
            this.showNextHelp();
          });
        } else {
          // ç§»é™¤é®ç½©èˆ‡æ–‡å­—
          this.overlay.destroy();
          this.helpText.destroy();
          this.showModeButtons();
        }
      }

      showModeButtons() {
        const W = this.scale.width;
        const H = this.scale.height;
        const overSound = this.sound.add('btnselect');
        const clickSound = this.sound.add('clickselect');

        // å†é¡¯ç¤ºä¸€å¼µåŠé€æ˜èƒŒæ™¯
        this.add
          .image(W / 2, H / 2, 'modebg')
          .setDisplaySize(W, H)
          .setAlpha(0.7)
          .setDepth(0);

        this.input.on('gameobjectover', () => {
          overSound.play();
        });
        this.input.on('gameobjectdown', () => {
          clickSound.play();
        });

        // è¿”å›æŒ‰éˆ•ï¼ˆæ”¾åœ¨å·¦ä¸Šè§’åä¸€é»ï¼‰
        const backButton = this.add
          .image(W * 0.05, H * 0.05, 'back')
          .setOrigin(0.5)
          .setScale(0.075)
          .setInteractive({ useHandCursor: true })
          .setDepth(1);

        backButton.on('pointerover', () => {
          backButton.setScale(0.08).setAlpha(0.8);
        });
        backButton.on('pointerout', () => {
          backButton.setScale(0.075).setAlpha(1);
        });
        backButton.on('pointerdown', () => {
          this.scene.start('MenuScene');
        });

        // Single æŒ‰éˆ•
        const singleButton = this.add
          .image(W / 2, H * 0.417, 'single')
          .setOrigin(0.5)
          .setScale(0.35)
          .setInteractive({ useHandCursor: true })
          .setDepth(1);

        singleButton.on('pointerover', () => {
          singleButton.setScale(0.38).setAlpha(0.8);
        });
        singleButton.on('pointerout', () => {
          singleButton.setScale(0.35).setAlpha(1);
        });
        singleButton.on('pointerdown', () => {
          this.scene.start('single_1Scene');
        });

        // Multiplayer æŒ‰éˆ•
        const mulitButton = this.add
          .image(W / 2, H * 0.667, 'mulit')
          .setOrigin(0.5)
          .setScale(0.37)
          .setInteractive({ useHandCursor: true })
          .setDepth(1);

        mulitButton.on('pointerover', () => {
          mulitButton.setScale(0.40).setAlpha(0.8);
        });
        mulitButton.on('pointerout', () => {
          mulitButton.setScale(0.37).setAlpha(1);
        });
        mulitButton.on('pointerdown', () => {
          this.scene.start('MulitLevelSelectScene');
        });
      }
    }

    // -------------------------------------------------------
    // MulitLevelSelectSceneï¼šå¤šäººé—œå¡é¸æ“‡
    // -------------------------------------------------------
    class MulitLevelSelectScene extends Phaser.Scene {
      constructor() {
        super({ key: 'MulitLevelSelectScene' });
      }

      preload() {
        this.load.image('level_select_bg', 'asset/menu/bg.jpg');
        this.load.audio('btnselect', 'asset/audio/select07.mp3');
        this.load.audio('clickselect', 'asset/audio/click.mp3');
      }

      create() {
        const W = this.scale.width;
        const H = this.scale.height;

        const overSound = this.sound.add('btnselect');
        const clickSound = this.sound.add('clickselect');

        // åŠé€æ˜é®ç½©
        this.add.rectangle(0, 0, W, H, 0x000000, 0.7).setOrigin(0);

        // èƒŒæ™¯
        this.add.image(W / 2, H / 2, 'level_select_bg')
          .setDisplaySize(W, H)
          .setAlpha(0.4);

        // ä¸»æ¨™é¡Œ
        this.add.text(W / 2, H * 0.167, 'é¸æ“‡å¤šäººé—œå¡', {
          fontFamily: 'a',
          fontSize: '48px',
          color: '#ffff00'
        }).setOrigin(0.5);

        const buttonData = [
          { relY: 0.3667, label: 'é—œå¡ 1', scene: 'Level1Scene_mulit' },
          { relY: 0.55, label: 'é—œå¡ 2', scene: 'Level2Scene_mulit' },
          { relY: 0.7333, label: 'é—œå¡ 3', scene: 'Level3Scene_mulit' }
        ];
        buttonData.forEach(({ relY, label, scene }) => {
          const btn = this.add.rectangle(W / 2, H * relY, W * 0.375, H * 0.133, 0xffffff, 1)
            .setStrokeStyle(4, 0xff0000)
            .setInteractive({ useHandCursor: true });
          const text = this.add.text(W / 2, H * relY, label, {
            fontFamily: 'a',
            fontSize: '36px',
            color: '#000'
          }).setOrigin(0.5);

          btn.on('pointerover', () => {
            btn.setFillStyle(0xffcc00, 1);
            btn.setStrokeStyle(6, 0xff6600);
            overSound.play();
          });
          btn.on('pointerout', () => {
            btn.setFillStyle(0xffffff, 1);
            btn.setStrokeStyle(4, 0xff0000);
          });
          btn.on('pointerdown', () => {
            clickSound.play();
            this.scene.start(scene);
          });
        });

        // è¿”å›æŒ‰éˆ•
        const backBtn = this.add.text(W / 2, H * 0.9, 'è¿”å›', {
          fontFamily: 'a',
          fontSize: '28px',
          color: '#ff0000',
          backgroundColor: '#fff'
        })
          .setOrigin(0.5)
          .setPadding(20, 8, 20, 8)
          .setInteractive({ useHandCursor: true });

        backBtn.on('pointerover', () => {
          backBtn.setStyle({ backgroundColor: '#ffc' });
          overSound.play();
        });
        backBtn.on('pointerout', () => backBtn.setStyle({ backgroundColor: '#fff' }));
        backBtn.on('pointerdown', () => {
          clickSound.play();
          this.scene.start('ModeScene');
        });
      }
    }

    // -------------------------------------------------------
    // BaseLevelSceneï¼šå–®æ©Ÿé—œå¡å…±ç”¨é‚è¼¯
    // -------------------------------------------------------
    class BaseLevelScene extends Phaser.Scene {
      constructor(key, config) {
        super({ key });
        this.levelConfig = Object.assign({
          backgroundKey: '',
          timeLimit: 60,
          passScore: 0,
          nextScene: null,
          showSnake: false,
          showEagle: false
        }, config);
      }

      preload() {
        // å…±ç”¨è³‡æº
        this.load.image('gr', 'asset/ground.png');
        this.load.image('black', 'asset/fruits/black.png');
        this.load.image('red', 'asset/fruits/red.png');
        this.load.image('gold', 'asset/fruits/gold.png');
        this.load.image('colorful', 'asset/fruits/colorful.png');
        this.load.spritesheet('player1', 'asset/player1.png', { frameWidth: 900, frameHeight: 472 });

        this.load.image('btnRestart', 'asset/reset.png');
        this.load.image('btnReturn', 'asset/home.png');
        this.load.image('btnNext', 'asset/next.png');
        this.load.audio('btnselect1', 'asset/audio/select07.mp3');
        this.load.audio('clickselect1', 'asset/audio/click.mp3');
        this.load.audio('eatapple', 'asset/audio/eatapple.mp3');
      }

      init(data) {
        this.mode = data.mode || 'single';
      }

      create() {
        const W = this.scale.width;
        const H = this.scale.height;

        this.btnSelectSound = this.sound.add('btnselect1');
        this.clickSelectSound = this.sound.add('clickselect1');
        this.eatapple = this.sound.add('eatapple', { volume: this.game.sound.volume });

        this.isGameOver = false;
        this.input.enabled = true;

        // èƒŒæ™¯åœ–
        this.add.image(W / 2, H / 2, this.levelConfig.backgroundKey)
          .setDisplaySize(W, H);

        // åœ°é¢
        this.ground = this.physics.add.staticImage(
          W / 2,
          H - 1,
          'gr'
        )
          .setDisplaySize(W, 40)
          .setOrigin(0.5, 1)
          .refreshBody();

        // è§’è‰²
        this.player = this.physics.add
          .sprite(W / 2, 0, 'player1')
          .setScale(0.45)
          .setOrigin(0.5, 1)
          .setCollideWorldBounds(true);

        this.player.y = this.ground.y - this.ground.displayHeight;
        this.physics.add.collider(this.player, this.ground);

        this.player.body.setSize(260, 0);
        this.player.body.setOffset(380, 0);

        this.cursors = this.input.keyboard.createCursorKeys();
        this.createAnimations();

        // åˆ†æ•¸èˆ‡æ™‚é–“
        this.score = 0;
        this.timeLeft = this.levelConfig.timeLimit;
        this.rainbowDropped = false;

        this.scoreText = this.add.text(16, 16,
          `Score: 0 / ${this.levelConfig.passScore}`, {
          fontFamily: 'a',
          fontSize: '36px',
          color: '#ff0000',
          strokeThickness: 2
        }
        );

        this.timerText = this.add.text(W * 0.8125, 16, 'Time: ' + this.timeLeft, {
          fontFamily: 'a',
          fontSize: '36px',
          color: '#ffa500',
          strokeThickness: 2
        });

        this.timer = this.time.addEvent({ delay: 1000, callback: this.updateTimer, callbackScope: this, loop: true });

        // æ‰è½ç‰©
        this.fruits = this.physics.add.group();
        this.spawnEvent = this.time.addEvent({ delay: 800, callback: this.spawnFruit, callbackScope: this, loop: true });
        this.physics.add.overlap(this.player, this.fruits, this.collectFruit, null, this);

        // è€é·¹
        if (this.levelConfig.showEagle) {
          this.eagles = this.physics.add.group();
          this.time.addEvent({ delay: 10000, callback: this.spawnEagle, callbackScope: this, loop: true });
          this.physics.add.overlap(this.player, this.eagles, this.hitEagle, null, this);
        }

        // è›‡
        if (this.levelConfig.showSnake) {
          this.isSnakeActive = false;
          this.time.delayedCall(10000, this.spawnSnake, null, this);
        }

        // æš«åœåŠŸèƒ½
        this.isPaused = false;
        this.pauseOverlay = null;
        this.input.keyboard.on('keydown-ESC', () => {
          this.isPaused ? this.resumeGame() : this.pauseGame();
        });
      }

      update() {
        if (this.isPaused) return;

        if (Phaser.Input.Keyboard.JustDown(this.cursors.up) && this.player.body.blocked.down) {
          this.player.setVelocityY(-350);
        }

        this.player.setVelocityX(0);
        const speed = 300 * (this.player.isSlowed ? 0.6 : 1);

        if (this.cursors.left.isDown) {
          this.player.setVelocityX(-speed);
          this.lastDirection = 'left';
        } else if (this.cursors.right.isDown) {
          this.player.setVelocityX(speed);
          this.lastDirection = 'right';
        } else {
          this.player.setVelocityX(0);
        }

        if (this.cursors.down.isDown) {
          this.player.setVelocityX(0);
          this.player.anims.play('lie', true);
          this.player.setFlipX(this.lastDirection === 'left');
          return;
        }

        if (this.player.body.velocity.x < 0) {
          this.player.anims.play('walk_left', true);
          this.player.setFlipX(false);
        } else if (this.player.body.velocity.x > 0) {
          this.player.anims.play('walk_right', true);
          this.player.setFlipX(false);
        } else {
          this.player.anims.play('ready', true);
          this.player.setFlipX(this.lastDirection === 'left');
        }

        // è›‡é‚Šç•Œåå½ˆï¼šå¦‚æœæœ‰è›‡
        if (this.snake && this.snake.body && this.snake.body.velocity) {
          if (this.snake.body.velocity.x > 0) {
            this.snake.setFlipX(true);
          } else if (this.snake.body.velocity.x < 0) {
            this.snake.setFlipX(false);
          }
        }

        // æ¸…ç†é£›å‡ºç•«é¢çš„è€é·¹
        if (this.eagles) {
          this.eagles.getChildren().forEach(eagle => {
            if (eagle.x < -50 || eagle.x > this.scale.width + 50) {
              eagle.destroy();
            }
          });
        }
      }

      createAnimations() {
        this.anims.create({
          key: 'walk_left',
          frames: this.anims.generateFrameNumbers('player1', { start: 0, end: 3 }),
          frameRate: 8,
          repeat: -1
        });
        this.anims.create({ key: 'ready', frames: [{ key: 'player1', frame: 4 }], frameRate: 1, repeat: -1 });
        this.anims.create({
          key: 'walk_right',
          frames: this.anims.generateFrameNumbers('player1', { start: 5, end: 8 }),
          frameRate: 8,
          repeat: -1
        });
        this.anims.create({ key: 'lie', frames: this.anims.generateFrameNumbers('player1', { start: 9, end: 9 }), frameRate: 8, repeat: -1 });

        if (this.levelConfig.showEagle) {
          this.anims.create({
            key: 'eagle',
            frames: this.anims.generateFrameNumbers('eagle', { start: 0, end: 8 }),
            frameRate: 9,
            repeat: -1
          });
        }
        if (this.levelConfig.showSnake) {
          this.anims.create({
            key: 'snake_move',
            frames: this.anims.generateFrameNumbers('snake', { start: 0, end: 4 }),
            frameRate: 6,
            repeat: -1
          });
        }
      }

      updateTimer() {
        this.timeLeft--;
        const H = this.scale.height;
        this.timerText.setText('Time: ' + this.timeLeft);
        if (this.timeLeft <= 0) {
          this.timer.remove(false);
          this.spawnEvent.remove(false);
          this.endLevel();
        }
      }

      spawnFruit() {
        const x = Phaser.Math.Between(50, this.scale.width - 50);
        const rand = Math.random();
        let type;
        if (rand < 0.5) type = 'red';
        else if (rand < 0.7) type = 'black';
        else if (rand < 0.95) type = 'gold';
        else if (!this.rainbowDropped) {
          type = 'colorful';
          this.rainbowDropped = true;
        } else type = 'red';
        const fruit = this.fruits.create(x, 0, type).setScale(0.085);
        fruit.type = type;
        fruit.setVelocityY(150);
      }

      collectFruit(player, fruit) {
        fruit.destroy();
        this.eatapple.play({ volume: this.game.sound.volume });
        switch (fruit.type) {
          case 'red':
            this.score += 2;
            break;
          case 'gold':
            this.score += 10;
            break;
          case 'colorful':
            this.score += 100;
            break;
          case 'black':
            this.score -= 10;
            break;
        }
        this.scoreText.setText(
          `Score: ${this.score} / ${this.levelConfig.passScore}`
        );
      }

      spawnEagle() {
        const W = this.scale.width;
        const y = 400 / 550 * this.scale.height; // ç›¸å°é«˜åº¦
        const fromLeft = Phaser.Math.Between(0, 1) === 0;
        const x = fromLeft ? -50 : W + 50;
        const speed = 200 * (fromLeft ? 1 : -1);
        const eagle = this.eagles.create(x, y, 'eagle').setOrigin(0.5).setScale(1.5).setDepth(50);
        eagle.body.allowGravity = false;
        eagle.setVelocityX(speed);
        eagle.setFlipX(!fromLeft);
        eagle.play('eagle');
      }

      spawnSnake() {
        const W = this.scale.width;
        this.snake = this.physics.add
          .sprite(50 / 800 * W, 0, 'snake')
          .setOrigin(0.5, 1)
          .setScale(0.5)
          .setCollideWorldBounds(true)
          .setBounce(1, 0);

        const floorTopY = this.ground.y - this.ground.displayHeight;
        this.snake.y = floorTopY;
        this.snake.body.setSize(300, 80);
        this.snake.body.setOffset(-this.snake.displayWidth / 2 + 100, -this.snake.displayHeight + 100);

        this.physics.add.collider(this.snake, this.ground);
        this.snake.play('snake_move');
        this.snake.setVelocityX(100);

        this.physics.add.overlap(this.player, this.snake, this.hitSnake, null, this);
      }

      hitSnake(player, snake) {
        if (this.isHit) return;
        this.isHit = true;
        player.setTint(0xff0000);
        this.time.delayedCall(1000, () => {
          this.score -= 15;
          this.scoreText.setText('Score: ' + this.score);
          player.clearTint();
          this.isHit = false;
        });
      }

      hitEagle(player, eagle) {
        if (this.cursors.down.isDown) return;
        eagle.destroy();
        this.score -= 20;
        this.scoreText.setText('Score: ' + this.score);
        player.setTint(0x4b0082);
        this.time.delayedCall(200, () => player.clearTint());
      }

      endLevel() {
        if (this.isGameOver) return;
        this.isGameOver = true;

        // æš«åœç‰©ç†ã€å‹•ç•«
        this.physics.pause();
        if (this.rainEmitter) this.rainEmitter.stop();
        if (this.player?.anims) this.player.anims.stop();
        this.eagles?.getChildren().forEach(e => e.anims.stop());
        this.snake?.anims.stop();

        const W = this.scale.width;
        const H = this.scale.height;

        // åŠé€æ˜é®ç½©
        this.add.rectangle(0, 0, W, H, 0x000000, 0.7)
          .setOrigin(0)
          .setDepth(100);

        // åˆ¤æ–·éé—œ
        const passed = this.score >= this.levelConfig.passScore;
        const msg = passed ? 'é é—œ ï¼' : 'å¤± æ•— ï¼';
        const color = passed ? '#00ff00' : '#ff0000';

        // ä¸»è¨Šæ¯
        this.add.text(W / 2, H * 0.3, msg, {
          fontFamily: 'a',
          fontSize: '64px',
          color,
          stroke: '#000',
          strokeThickness: 4
        })
          .setOrigin(0.5)
          .setDepth(101);

        // æœ€çµ‚åˆ†æ•¸
        this.add.text(W / 2, H * 0.4333, `æœ€çµ‚åˆ†æ•¸ï¼š${this.score}`, {
          fontFamily: 'a',
          fontSize: '32px',
          color: '#ffffff',
          stroke: '#000',
          strokeThickness: 2
        })
          .setOrigin(0.5)
          .setDepth(101);

        // æŒ‰éˆ•ç¾¤
        const btnY = H * 0.6667;
        const gapX = W * 0.25;

        // Restart
        const restart = this.add.image(W / 2 - gapX, btnY, 'btnRestart')
          .setInteractive({ useHandCursor: true })
          .setScale(0.1)
          .setDepth(101);

        restart
          .on('pointerover', () => {
            restart.setScale(0.15);
            this.btnSelectSound.play();
            restart.setAlpha(0.8);
          })
          .on('pointerout', () => {
            restart.setScale(0.1);
            restart.setAlpha(1);
          })
          .on('pointerdown', () => {
            this.clickSelectSound.play();
            this.scene.restart();
          });

        // Return
        const ret = this.add.image(W / 2, btnY, 'btnReturn')
          .setInteractive({ useHandCursor: true })
          .setScale(0.1)
          .setDepth(101);

        ret
          .on('pointerover', () => {
            this.btnSelectSound.play();
            ret.setScale(0.15);
            ret.setAlpha(0.8);
          })
          .on('pointerout', () => {
            ret.setScale(0.1);
            ret.setAlpha(1);
          })
          .on('pointerdown', () => {
            this.clickSelectSound.play();
            this.scene.start('MenuScene');
          });

        // Next
        if (passed && this.levelConfig.nextScene) {
          const next = this.add.image(W / 2 + gapX, btnY, 'btnNext')
            .setInteractive({ useHandCursor: true })
            .setScale(0.1)
            .setDepth(101);

          next
            .on('pointerover', () => {
              this.btnSelectSound.play();
              next.setScale(0.15);
              next.setAlpha(0.8);
            })
            .on('pointerout', () => {
              next.setScale(0.1);
              next.setAlpha(1);
            })
            .on('pointerdown', () => {
              this.clickSelectSound.play();
              this.scene.start(this.levelConfig.nextScene);
            });
        }
      }

      pauseGame() {
        if (this.isPaused) return;
        this.sound.pauseAll();

        this.isPaused = true;
        this.physics.world.pause();
        this.timer.paused = true;
        this.spawnEvent.paused = true;
        this.player.anims.pause();
        if (this.eagles) this.eagles.getChildren().forEach(e => e.anims.pause());
        if (this.snake) this.snake.anims.pause();
        if (this.rainEmitter) this.rainEmitter.pause();

        const W = this.scale.width;
        const H = this.scale.height;

        // åŠé€æ˜é®ç½©
        this.pauseOverlay = this.add.rectangle(0, 0, W, H, 0x000000, 0.7)
          .setOrigin(0)
          .setDepth(200);

        // æš«åœæ–‡å­—
        this.add.text(W / 2, H * 0.3, 'éŠæˆ²æš«åœ', {
          fontFamily: 'a',
          fontSize: '64px',
          color: '#ffff00',
          stroke: '#000',
          strokeThickness: 4
        })
          .setOrigin(0.5)
          .setDepth(201)
          .setName('pauseText');

        // æŒ‰éˆ•ç¾¤
        const btnY = H * 0.5333;
        const gapX = W * 0.25;

        // ä¸»ç•«é¢
        const btnHome = this.add.image(W / 2 - gapX, btnY, 'btnReturn')
          .setInteractive({ useHandCursor: true })
          .setScale(0.12)
          .setDepth(201)
          .setName('pauseBtnHome');

        btnHome
          .on('pointerover', () => {
            btnHome.setScale(0.15);
            btnHome.setAlpha(0.8);
            this.btnSelectSound.play();
          })
          .on('pointerout', () => {
            btnHome.setScale(0.12);
            btnHome.setAlpha(1);
          })
          .on('pointerdown', () => {
            this.clickSelectSound.play();
            this.resumeGame();
            this.scene.start('MenuScene');
          });

        // é‡ä¾†
        const btnRestart = this.add.image(W / 2, btnY, 'btnRestart')
          .setInteractive({ useHandCursor: true })
          .setScale(0.12)
          .setDepth(201)
          .setName('pauseBtnRestart');
        btnRestart
          .on('pointerover', () => {
            btnRestart.setScale(0.15);
            btnRestart.setAlpha(0.8);
            this.btnSelectSound.play();
          })
          .on('pointerout', () => {
            btnRestart.setScale(0.12);
            btnRestart.setAlpha(1);
          })
          .on('pointerdown', () => {
            this.clickSelectSound.play();
            this.resumeGame();
            this.scene.restart();
          });

        // ç¹¼çºŒ
        const btnContinue = this.add.image(W / 2 + gapX, btnY, 'btnNext')
          .setInteractive({ useHandCursor: true })
          .setScale(0.12)
          .setDepth(201)
          .setName('pauseBtnContinue');
        btnContinue
          .on('pointerover', () => {
            btnContinue.setScale(0.15);
            btnContinue.setAlpha(0.8);
            this.btnSelectSound.play();
          })
          .on('pointerout', () => {
            btnContinue.setScale(0.12);
            btnContinue.setAlpha(1);
          })
          .on('pointerdown', () => {
            this.clickSelectSound.play();
            this.resumeGame();
          });
      }

      resumeGame() {
        if (!this.isPaused) return;
        this.sound.resumeAll();
        this.isPaused = false;
        this.physics.world.resume();
        this.timer.paused = false;
        this.spawnEvent.paused = false;
        this.player.anims.resume();
        if (this.eagles) this.eagles.getChildren().forEach(e => e.anims.resume());
        if (this.snake) this.snake.anims.resume();
        if (this.rainEmitter) this.rainEmitter.resume();

        // åˆªé™¤æš«åœ UI
        this.children.getAll().forEach(child => {
          if (child.depth >= 200) child.destroy();
        });
      }
    }

    // -------------------------------------------------------
    // BaseLevelScene_mulitï¼šå¤šäººé›™äºº å…±ç”¨é‚è¼¯
    // -------------------------------------------------------
    class BaseLevelScene_mulit extends Phaser.Scene {
      constructor(key, config) {
        super({ key });
        this.levelConfig = Object.assign({
          backgroundKey: '',
          timeLimit: 60,
          passScore: 0,
          nextScene: null,
          showSnake: false,
          showEagle: false
        }, config);
      }

      preload() {
        this.load.image('gr', 'asset/ground.png');
        this.load.image('black', 'asset/fruits/black.png');
        this.load.image('red', 'asset/fruits/red.png');
        this.load.image('gold', 'asset/fruits/gold.png');
        this.load.image('colorful', 'asset/fruits/colorful.png');
        this.load.spritesheet('player1', 'asset/player1.png', { frameWidth: 900, frameHeight: 472 });
        this.load.spritesheet('player2', 'asset/player2.png', { frameWidth: 900, frameHeight: 472 });
        this.load.image('btnRestart', 'asset/reset.png');
        this.load.image('btnReturn', 'asset/home.png');
        this.load.image('btnNext', 'asset/next.png');
        this.load.audio('btnselect1', 'asset/audio/select07.mp3');
        this.load.audio('clickselect1', 'asset/audio/click.mp3');
        this.load.audio('eatapple', 'asset/audio/eatapple.mp3');
        this.load.audio('eatapple_p2', 'asset/audio/eatapple_p2.mp3');
      }

      init(data) {
        this.mode = data.mode || 'single';
      }

      create() {
        const W = this.scale.width;
        const H = this.scale.height;

        this.eatapple = this.sound.add('eatapple', { volume: this.game.sound.volume });
        this.eatapple_p2 = this.sound.add('eatapple_p2', { volume: this.game.sound.volume });
        this.btnSelectSound = this.sound.add('btnselect1');
        this.clickSelectSound = this.sound.add('clickselect1');

        this.isGameOver = false;
        this.input.enabled = true;

        // èƒŒæ™¯
        this.add.image(W / 2, H / 2, this.levelConfig.backgroundKey)
          .setDisplaySize(W, H);

        // åœ°é¢
        this.ground = this.physics.add.staticImage(W / 2, H - 1, 'gr')
          .setDisplaySize(W, 40)
          .setOrigin(0.5, 1)
          .refreshBody();

        // P1
        this.player = this.physics.add.sprite(W / 2, 0, 'player1')
          .setScale(0.45)
          .setOrigin(0.5, 1)
          .setCollideWorldBounds(true);
        this.player.y = this.ground.y - this.ground.displayHeight;
        this.physics.add.collider(this.player, this.ground);
        this.player.body.setSize(260, 0).setOffset(380, 0);

        // P2
        this.player2 = this.physics.add.sprite(W * 0.25, 0, 'player2')
          .setScale(0.45)
          .setOrigin(0.5, 1)
          .setCollideWorldBounds(true);
        this.player2.y = this.ground.y - this.ground.displayHeight;
        this.physics.add.collider(this.player2, this.ground);
        this.player2.body.setSize(260, 0).setOffset(380, 0);

        this.wasd = this.input.keyboard.addKeys({ up: Phaser.Input.Keyboard.KeyCodes.W, left: Phaser.Input.Keyboard.KeyCodes.A, down: Phaser.Input.Keyboard.KeyCodes.S, right: Phaser.Input.Keyboard.KeyCodes.D });
        this.cursors = this.input.keyboard.createCursorKeys();
        this.createAnimations();

        // åˆ†æ•¸
        this.score = 0;
        this.score_p2 = 0;
        this.scoreText = this.add.text(16, 16, 'P1: 0', {
          fontFamily: 'a',
          fontSize: '36px',
          color: '#ff0000',
          strokeThickness: 2
        });
        this.scoreText_p2 = this.add.text(16, H * 0.0933, 'P2: 0', {
          fontFamily: 'a',
          fontSize: '36px',
          color: '#0000ff',
          strokeThickness: 2
        });
        this.timeLeft = this.levelConfig.timeLimit;
        this.timerText = this.add.text(W * 0.8125, 16, 'Time: ' + this.timeLeft, {
          fontFamily: 'a',
          fontSize: '36px',
          color: '#ffa500',
          strokeThickness: 2
        });
        this.timer = this.time.addEvent({ delay: 1000, callback: this.updateTimer, callbackScope: this, loop: true });

        // æ‰è½ç‰©
        this.fruits = this.physics.add.group();
        this.spawnEvent = this.time.addEvent({ delay: 800, callback: this.spawnFruit, callbackScope: this, loop: true });
        this.physics.add.overlap(this.player, this.fruits, this.collectFruit, null, this);
        this.physics.add.overlap(this.player2, this.fruits, this.collectFruitP2, null, this);

        // è€é·¹ã€è›‡
        if (this.levelConfig.showEagle) {
          this.eagles = this.physics.add.group();
          this.time.addEvent({ delay: 10000, callback: this.spawnEagle, callbackScope: this, loop: true });
          this.physics.add.overlap(this.player, this.eagles, this.hitEagle, null, this);
          this.physics.add.overlap(this.player2, this.eagles, this.hitEagle, null, this);
        }
        if (this.levelConfig.showSnake) {
          this.time.delayedCall(10000, this.spawnSnake, null, this);
        }

        this.isHitP1 = false;
        this.isHitP2 = false;
        this.isPaused = false;
        this.pauseOverlay = null;
        this.input.keyboard.on('keydown-ESC', () => {
          this.isPaused ? this.resumeGame() : this.pauseGame();
        });
      }

      update() {
        // å¦‚æœæ˜¯æš«åœç‹€æ…‹ï¼Œå°±ç›´æ¥ä¸åšä»»ä½•è™•ç†
        if (this.isPaused) return;

        // â”€â”€â”€ P1 æ§åˆ¶å€åŸŸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // 1) è·³èºï¼šå¦‚æœ P1 æŒ‰ä¸Šä¸‹éµï¼Œä¸¦ä¸”è…³åº•è²¼åœ°ï¼Œå°±è®“ä»–è·³
        if (Phaser.Input.Keyboard.JustDown(this.cursors.up) && this.player.body.blocked.down) {
          this.player.setVelocityY(-350);
        }

        // 2) æ°´å¹³ç§»å‹•ï¼šå…ˆæŠŠé€Ÿåº¦æ­¸é›¶ï¼Œå†ä¾ç…§å·¦å³éµæ”¹é€Ÿåº¦ã€è¨˜éŒ„æ–¹å‘
        this.player.setVelocityX(0);
        const speed1 = 300 * (this.player.isSlowed ? 0.6 : 1);

        if (this.cursors.left.isDown) {
          this.player.setVelocityX(-speed1);
          this.lastDirection = 'left';
        } else if (this.cursors.right.isDown) {
          this.player.setVelocityX(speed1);
          this.lastDirection = 'right';
        }

        // 3) ä¸‹è¹²ï¼šå¦‚æœ P1 æŒ‰ä¸‹éµï¼Œå°±ä¸åšæ°´å¹³è·‘å‹•ï¼Œåªåšä¸‹è¹²å‹•ç•«
        let p1DoingCrouch = false;
        if (this.cursors.down.isDown) {
          p1DoingCrouch = true;
          this.player.setVelocityX(0);
          this.player.anims.play('lie', true);
          this.player.setFlipX(this.lastDirection === 'left');
        }

        // 4) å‹•ç•«ï¼šå¦‚æœæ²’æœ‰åœ¨ä¸‹è¹²ï¼Œå°±æ ¹æ“šé€Ÿåº¦åˆ‡æ›èµ°è·¯æˆ–å¾…æ©Ÿå‹•ç•«
        if (!p1DoingCrouch) {
          if (this.player.body.velocity.x < 0) {
            // P1 å¾€å·¦è·‘
            this.player.anims.play('walk_left', true);
            this.player.setFlipX(false);
          }
          else if (this.player.body.velocity.x > 0) {
            // P1 å¾€å³è·‘
            this.player.anims.play('walk_right', true);
            this.player.setFlipX(false);
          }
          else {
            // P1 å¾…æ©Ÿ
            this.player.anims.play('ready', true);
            this.player.setFlipX(this.lastDirection === 'left');
          }
        }
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


        // â”€â”€â”€ P2 æ§åˆ¶å€åŸŸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // 1) è·³èºï¼šP2 ç”¨ W éµè·³ï¼Œå¦‚æœè…³åº•è²¼åœ°å°±è·³
        if (Phaser.Input.Keyboard.JustDown(this.wasd.up) && this.player2.body.blocked.down) {
          this.player2.setVelocityY(-350);
        }

        // 2) æ°´å¹³ç§»å‹•ï¼šå…ˆæŠŠé€Ÿåº¦æ­¸é›¶ï¼Œå†ä¾ç…§ A / D éµæ”¹é€Ÿåº¦ã€è¨˜éŒ„æ–¹å‘
        this.player2.setVelocityX(0);
        const speed2 = 300 * (this.player2.isSlowed ? 0.6 : 1);

        if (this.wasd.left.isDown) {
          this.player2.setVelocityX(-speed2);
          this.lastDir2 = 'left';
        } else if (this.wasd.right.isDown) {
          this.player2.setVelocityX(speed2);
          this.lastDir2 = 'right';
        }

        // 3) ä¸‹è¹²ï¼šP2 ç”¨ S éµä¸‹è¹²
        let p2DoingCrouch = false;
        if (this.wasd.down.isDown) {
          p2DoingCrouch = true;
          this.player2.setVelocityX(0);
          this.player2.anims.play('lie2', true);
          this.player2.setFlipX(this.lastDir2 === 'left');
        }

        // 4) å‹•ç•«ï¼šå¦‚æœæ²’æœ‰ä¸‹è¹²ï¼Œå°±æ ¹æ“šé€Ÿåº¦åˆ‡æ› P2 çš„èµ°è·¯æˆ–å¾…æ©Ÿ
        if (!p2DoingCrouch) {
          if (this.player2.body.velocity.x < 0) {
            this.player2.anims.play('walk_left2', true);
            this.player2.setFlipX(false);
          }
          else if (this.player2.body.velocity.x > 0) {
            this.player2.anims.play('walk_right2', true);
            this.player2.setFlipX(false);
          }
          else {
            this.player2.anims.play('ready2', true);
            this.player2.setFlipX(this.lastDir2 === 'left2');
          }
        }

        // è›‡é‚Šç•Œåå½ˆ
        if (this.snake && this.snake.body && this.snake.body.velocity) {
          if (this.snake.body.velocity.x > 0) {
            this.snake.setFlipX(true);
          } else if (this.snake.body.velocity.x < 0) {
            this.snake.setFlipX(false);
          }
        }

        // æ¸…ç†è€é·¹
        if (this.eagles) {
          this.eagles.getChildren().forEach(eagle => {
            if (eagle.x < -50 || eagle.x > this.scale.width + 50) {
              eagle.destroy();
            }
          });
        }
      }

      createAnimations() {
        // P1 å‹•ç•«
        this.anims.create({
          key: 'walk_left',
          frames: this.anims.generateFrameNumbers('player1', { start: 0, end: 3 }),
          frameRate: 8,
          repeat: -1
        });
        this.anims.create({ key: 'ready', frames: [{ key: 'player1', frame: 4 }], frameRate: 1, repeat: -1 });
        this.anims.create({
          key: 'walk_right',
          frames: this.anims.generateFrameNumbers('player1', { start: 5, end: 8 }),
          frameRate: 8,
          repeat: -1
        });
        this.anims.create({ key: 'lie', frames: this.anims.generateFrameNumbers('player1', { start: 9, end: 9 }), frameRate: 8, repeat: -1 });

        // P2 å‹•ç•«
        this.anims.create({
          key: 'walk_left2',
          frames: this.anims.generateFrameNumbers('player2', { start: 0, end: 3 }),
          frameRate: 8,
          repeat: -1
        });
        this.anims.create({ key: 'ready2', frames: [{ key: 'player2', frame: 4 }], frameRate: 1, repeat: -1 });
        this.anims.create({
          key: 'walk_right2',
          frames: this.anims.generateFrameNumbers('player2', { start: 5, end: 8 }),
          frameRate: 8,
          repeat: -1
        });
        this.anims.create({ key: 'lie2', frames: this.anims.generateFrameNumbers('player2', { start: 9, end: 9 }), frameRate: 8, repeat: -1 });

        if (this.levelConfig.showEagle) {
          this.anims.create({
            key: 'eagle',
            frames: this.anims.generateFrameNumbers('eagle', { start: 0, end: 8 }),
            frameRate: 9,
            repeat: -1
          });
        }
        if (this.levelConfig.showSnake) {
          this.anims.create({
            key: 'snake_move',
            frames: this.anims.generateFrameNumbers('snake', { start: 0, end: 4 }),
            frameRate: 6,
            repeat: -1
          });
        }
      }

      updateTimer() {
        this.timeLeft--;
        this.timerText.setText('Time: ' + this.timeLeft);
        if (this.timeLeft <= 0) {
          this.timer.remove(false);
          this.spawnEvent.remove(false);
          this.endLevel();
        }
      }

      spawnFruit() {
        const x = Phaser.Math.Between(50, this.scale.width - 50);
        const rand = Math.random();
        let type;
        if (rand < 0.5) type = 'red';
        else if (rand < 0.7) type = 'black';
        else if (rand < 0.95) type = 'gold';
        else if (!this.rainbowDropped) {
          type = 'colorful';
          this.rainbowDropped = true;
        } else type = 'red';
        const fruit = this.fruits.create(x, 0, type).setScale(0.085);
        fruit.type = type;
        fruit.setVelocityY(150);
      }

      collectFruit(player, fruit) {
        fruit.destroy();
        this.eatapple.play({ volume: this.game.sound.volume });
        switch (fruit.type) {
          case 'red':
            this.score += 2;
            break;
          case 'gold':
            this.score += 10;
            break;
          case 'colorful':
            this.score += 100;
            break;
          case 'black':
            this.score -= 10;
            break;
        }
        this.scoreText.setText('P1: ' + this.score);
      }

      collectFruitP2(player2, fruit) {
        fruit.destroy();
        this.eatapple_p2.play({ volume: this.game.sound.volume });
        switch (fruit.type) {
          case 'red':
            this.score_p2 += 2;
            break;
          case 'gold':
            this.score_p2 += 10;
            break;
          case 'colorful':
            this.score_p2 += 100;
            break;
          case 'black':
            this.score_p2 -= 10;
            break;
        }
        this.scoreText_p2.setText('P2: ' + this.score_p2);
      }

      spawnEagle() {
        const W = this.scale.width;
        const y = 400 / 550 * this.scale.height;
        const fromLeft = Phaser.Math.Between(0, 1) === 0;
        const x = fromLeft ? -50 : W + 50;
        const speed = 200 * (fromLeft ? 1 : -1);
        const eagle = this.eagles.create(x, y, 'eagle').setOrigin(0.5).setScale(1.5).setDepth(50);
        eagle.body.allowGravity = false;
        eagle.setVelocityX(speed);
        eagle.setFlipX(!fromLeft);
        eagle.play('eagle');
      }

      spawnSnake() {
        const W = this.scale.width;
        this.snake = this.physics.add
          .sprite(50 / 800 * W, 0, 'snake')
          .setOrigin(0.5, 1)
          .setScale(0.45)
          .setCollideWorldBounds(true)
          .setBounce(1, 0);

        const floorTopY = this.ground.y - this.ground.displayHeight;
        this.snake.y = floorTopY;
        this.snake.body.setSize(300, 80);
        this.snake.body.setOffset(
          -this.snake.displayWidth / 2 + 100,
          -this.snake.displayHeight + 100
        );

        this.physics.add.collider(this.snake, this.ground);
        this.snake.play('snake_move');
        this.snake.setVelocityX(100);

        this.physics.add.overlap(this.player, this.snake, this.hitSnake, null, this);
        this.physics.add.overlap(this.player2, this.snake, this.hitSnake, null, this);
      }

      hitSnake(player, snake) {
        const isP1 = (player === this.player);
        const flag = isP1 ? 'isHitP1' : 'isHitP2';
        const downKey = isP1 ? this.cursors.down : this.wasd.down;

        if (this[flag] || downKey.isDown) return;
        this[flag] = true;

        if (isP1) {
          this.score -= 15;
          this.scoreText.setText('P1: ' + this.score);
        } else {
          this.score_p2 -= 15;
          this.scoreText_p2.setText('P2: ' + this.score_p2);
        }

        player.setTint(0xff0000);
        this.time.delayedCall(500, () => player.clearTint());
        this.time.delayedCall(1000, () => {
          this[flag] = false;
        });
      }

      hitEagle(player, eagle) {
        const isP1 = (player === this.player);
        const isCrouching = isP1
          ? this.cursors.down.isDown
          : this.wasd.down.isDown;
        if (isCrouching) return;

        eagle.destroy();

        if (isP1) {
          this.score -= 20;
          this.scoreText.setText('P1: ' + this.score);
        } else {
          this.score_p2 -= 20;
          this.scoreText_p2.setText('P2: ' + this.score_p2);
        }

        player.setTint(0x4b0082);
        this.time.delayedCall(200, () => player.clearTint());
      }

      endLevel() {
        if (this.isGameOver) return;
        this.isGameOver = true;

        this.physics.pause();
        this.player?.anims.stop();
        this.player2?.anims.stop();
        this.eagles?.getChildren().forEach(e => e.anims.stop());
        this.snake?.anims.stop();

        const W = this.scale.width;
        const H = this.scale.height;

        // åŠé€æ˜é®ç½©
        this.add.rectangle(0, 0, W, H, 0x000000, 0.7)
          .setOrigin(0)
          .setDepth(100);

        // åˆ¤æ–·å‹è² 
        let msg, color;
        if (this.score > this.score_p2) {
          msg = 'ç´…æ–¹å‹åˆ©ï¼';
          color = '#ff0000';
        } else if (this.score < this.score_p2) {
          msg = 'è—æ–¹å‹åˆ©ï¼';
          color = '#0000ff';
        } else {
          msg = 'å¹³ æ‰‹ ï¼';
          color = '#ffff00';
        }

        // ä¸»è¨Šæ¯
        this.add.text(W / 2, H * 0.3, msg, {
          fontFamily: 'a',
          fontSize: '64px',
          color,
          stroke: '#000',
          strokeThickness: 4
        }).setOrigin(0.5).setDepth(101);

        // é›™æ–¹æœ€çµ‚åˆ†æ•¸
        const scoreText = `ç´…æ–¹ï¼š${this.score}  |  è—æ–¹ï¼š${this.score_p2}`;
        this.add.text(W / 2, H * 0.4333, scoreText, {
          fontFamily: 'a',
          fontSize: '32px',
          color: '#ffffff',
          stroke: '#000',
          strokeThickness: 2
        }).setOrigin(0.5).setDepth(101);

        const btnY = H * 0.6667;
        const gapX = W * 0.25;

        // Restart
        const restart = this.add.image(W / 2 - gapX, btnY, 'btnRestart')
          .setInteractive({ useHandCursor: true })
          .setScale(0.1)
          .setDepth(101);
        restart
          .on('pointerover', () => {
            restart.setScale(0.15);
            this.btnSelectSound.play();
            restart.setAlpha(0.8);
          })
          .on('pointerout', () => {
            restart.setScale(0.1);
            restart.setAlpha(1);
          })
          .on('pointerdown', () => {
            this.clickSelectSound.play();
            this.scene.restart();
          });

        // Return
        const ret = this.add.image(W / 2, btnY, 'btnReturn')
          .setInteractive({ useHandCursor: true })
          .setScale(0.1)
          .setDepth(101);
        ret
          .on('pointerover', () => {
            this.btnSelectSound.play();
            ret.setScale(0.15);
            ret.setAlpha(0.8);
          })
          .on('pointerout', () => {
            ret.setScale(0.1);
            ret.setAlpha(1);
          })
          .on('pointerdown', () => {
            this.clickSelectSound.play();
            this.scene.start('MenuScene');
          });

        // Next
        if (this.levelConfig.nextScene) {
          const next = this.add.image(W / 2 + gapX, btnY, 'btnNext')
            .setInteractive({ useHandCursor: true })
            .setScale(0.1)
            .setDepth(101);
          next
            .on('pointerover', () => {
              this.btnSelectSound.play();
              next.setScale(0.15);
              next.setAlpha(0.8);
            })
            .on('pointerout', () => {
              next.setScale(0.1);
              next.setAlpha(1);
            })
            .on('pointerdown', () => {
              this.clickSelectSound.play();
              this.scene.start(this.levelConfig.nextScene);
            });
        }
      }

      pauseGame() {
        if (this.isPaused) return;
        this.sound.pauseAll();

        this.isPaused = true;
        this.physics.world.pause();
        this.timer.paused = true;
        this.spawnEvent.paused = true;
        this.player.anims.pause();
        this.player2.anims.pause();
        if (this.eagles) this.eagles.getChildren().forEach(e => e.anims.pause());
        if (this.snake) this.snake.anims.pause();
        if (this.rainEmitter) this.rainEmitter.pause();

        const W = this.scale.width;
        const H = this.scale.height;

        // åŠé€æ˜é®ç½©
        this.pauseOverlay = this.add.rectangle(0, 0, W, H, 0x000000, 0.7)
          .setOrigin(0)
          .setDepth(200);

        // æš«åœæ–‡å­—
        this.add.text(W / 2, H * 0.3, 'éŠæˆ²æš«åœ', {
          fontFamily: 'a',
          fontSize: '64px',
          color: '#ffff00',
          stroke: '#000',
          strokeThickness: 4
        }).setOrigin(0.5).setDepth(201);

        const btnY = H * 0.5333;
        const gapX = W * 0.25;

        // ä¸»ç•«é¢
        const btnHome = this.add.image(W / 2 - gapX, btnY, 'btnReturn')
          .setInteractive({ useHandCursor: true })
          .setScale(0.12)
          .setDepth(201);
        btnHome
          .on('pointerover', () => {
            btnHome.setScale(0.15);
            btnHome.setAlpha(0.8);
            this.btnSelectSound.play();
          })
          .on('pointerout', () => {
            btnHome.setScale(0.12);
            btnHome.setAlpha(1);
          })
          .on('pointerdown', () => {
            this.clickSelectSound.play();
            this.resumeGame();
            this.scene.start('MenuScene');
          });

        // é‡ä¾†
        const btnRestart = this.add.image(W / 2, btnY, 'btnRestart')
          .setInteractive({ useHandCursor: true })
          .setScale(0.12)
          .setDepth(201);
        btnRestart
          .on('pointerover', () => {
            btnRestart.setScale(0.15);
            btnRestart.setAlpha(0.8);
            this.btnSelectSound.play();
          })
          .on('pointerout', () => {
            btnRestart.setScale(0.12);
            btnRestart.setAlpha(1);
          })
          .on('pointerdown', () => {
            this.clickSelectSound.play();
            this.resumeGame();
            this.scene.restart();
          });

        // ç¹¼çºŒ
        const btnContinue = this.add.image(W / 2 + gapX, btnY, 'btnNext')
          .setInteractive({ useHandCursor: true })
          .setScale(0.12)
          .setDepth(201);
        btnContinue
          .on('pointerover', () => {
            btnContinue.setScale(0.15);
            btnContinue.setAlpha(0.8);
            this.btnSelectSound.play();
          })
          .on('pointerout', () => {
            btnContinue.setScale(0.12);
            btnContinue.setAlpha(1);
          })
          .on('pointerdown', () => {
            this.clickSelectSound.play();
            this.resumeGame();
          });
      }

      resumeGame() {
        if (!this.isPaused) return;
        this.sound.resumeAll();
        this.isPaused = false;
        this.physics.world.resume();
        this.timer.paused = false;
        this.spawnEvent.paused = false;
        this.player.anims.resume();
        this.player2.anims.resume();
        if (this.eagles) this.eagles.getChildren().forEach(e => e.anims.resume());
        if (this.snake) this.snake.anims.resume();
        if (this.rainEmitter) this.rainEmitter.resume();

        this.children.getAll().forEach(child => {
          if (child.depth >= 200) child.destroy();
        });
      }
    }

    // -------------------------------------------------------
    // SettingSceneï¼šå³æ™‚éŸ³é‡æ§åˆ¶
    // -------------------------------------------------------
    class SettingScene extends Phaser.Scene {
      constructor() {
        super({ key: 'SettingScene' });
      }

      preload() {
        this.load.image('setting_bg', 'asset/menu/bg.jpg');
        this.load.image('slider_bar', 'asset/slider_bar.png');
        this.load.image('slider_knob', 'asset/slider_knob.png');
        this.load.audio('btnselect', 'asset/audio/select07.mp3');
        this.load.audio('clickselect', 'asset/audio/click.mp3');
      }

      create() {
        const W = this.scale.width;
        const H = this.scale.height;

        // 1. èƒŒæ™¯èˆ‡æ¨™é¡Œï¼ˆä¾æ—§ç”¨å­—é«” 'a'ï¼Œç¢ºä¿ @font-face å·²åŠ å¥½ï¼‰
        this.add.image(W / 2, H / 2, 'setting_bg')
          .setDisplaySize(W, H)
          .setAlpha(0.4);

        this.add.text(W / 2, H * 0.15, 'è¨­å®š', {
          fontFamily: 'a',
          fontSize: '48px',
          color: '#ffff00'
        }).setOrigin(0.5);

        // 2. 'éŸ³é‡' æ¨™ç±¤ï¼Œæ”¾åœ¨æ»‘æ†å·¦é‚Š
        this.add.text(W * 0.25, H * 0.3333, 'éŸ³é‡', {
          fontFamily: 'a',
          fontSize: '28px',
          color: '#ffffff'
        }).setOrigin(1, 0.5);

        // 3. æ’­æ”¾ç¤ºä¾‹éŸ³æ•ˆï¼ˆæœƒç”¨åœ¨æ‹–æ›³æ™‚ï¼‰
        const sampleSound = this.sound.add('btnselect', { volume: game.sound.volume });

        // 4. è¨ˆç®—æ»‘æ†å¯¬åº¦/ä½ç½®
        //    è®©æ»‘æ†æ¨ªå‘ä»ç”»é¢ 25% å»¶ä¼¸åˆ° 75%ï¼ˆå ä¸€åŠå®½åº¦ï¼‰
        const barX = W * 0.25;         // æ»‘æ†æœ€å·¦ç«¯
        const barY = H * 0.3333;       // æ»‘æ†å‚ç›´ä½ç½®
        const barWidth = W * 0.5;      // å ç”»é¢ 50% å®½åº¦
        // åŸå§‹ slider_bar å›¾ç‰‡é«˜åº¦ï¼Œç”¨æ¥ä¿æŒé«˜åº¦ä¸å˜
        const barTexture = this.textures.get('slider_bar').getSourceImage();
        const barHeight = barTexture.height;

        // 5. æŠŠ slider_bar ç”»å‡ºæ¥ï¼ˆè®¾ origin ä¸º (0,0.5)ï¼‰
        this.add.image(barX, barY, 'slider_bar')
          .setOrigin(0, 0.5)
          .setDisplaySize(barWidth, barHeight);

        // 6. knob åˆå§‹ Xï¼šbarX + barWidth * å½“å‰éŸ³é‡
        const initialKnobX = barX + barWidth * game.sound.volume;
        const knob = this.add.image(initialKnobX, barY, 'slider_knob')
          .setOrigin(0.5)      // ä¸­å¿ƒç‚¹
          .setInteractive({ draggable: true });

        this.input.setDraggable(knob);

        // 7. ç™¾åˆ†æ¯”æ–‡å­—ï¼Œä¹Ÿæ”¾åˆ°æ»‘æ†å³ä¾§
        const volText = this.add.text(barX + barWidth + 20, barY, Math.round(game.sound.volume * 100) + '%', {
          fontFamily: 'a',
          fontSize: '24px',
          color: '#ffff00'
        }).setOrigin(0, 0.5);

        // å®šä¹‰ knob æœ€å·¦/å³çš„æ‹–æ›³èŒƒå›´
        const minX = barX;
        const maxX = barX + barWidth;

        knob.on('dragstart', () => {
          sampleSound.play({ loop: true, volume: game.sound.volume });
        });

        knob.on('drag', (_pointer, dragX) => {
          // é™åˆ¶èŒƒå›´
          dragX = Phaser.Math.Clamp(dragX, minX, maxX);
          knob.x = dragX;

          // é‡æ–°è®¡ç®—éŸ³é‡
          const newVol = (dragX - barX) / barWidth;
          game.sound.volume = newVol;
          volText.setText(Math.round(newVol * 100) + '%');
          sampleSound.setVolume(newVol);
        });

        knob.on('dragend', () => {
          sampleSound.stop();
          this.sound.play('clickselect', { volume: game.sound.volume });
        });

        // 8. è¿”å›ä¸»é¸å–®æŒ‰éˆ•
        const backBtn = this.add.text(W / 2, H * 0.75, 'è¿”å›ä¸»é¸å–®', {
          fontFamily: 'a',
          fontSize: '32px',
          color: '#ff0000',
          backgroundColor: '#ffffff',
          padding: { x: 20, y: 8 }
        }).setOrigin(0.5)
          .setInteractive({ useHandCursor: true });

        backBtn.on('pointerover', () => {
          backBtn.setStyle({ backgroundColor: '#ffc' });
          this.sound.play('btnselect', { volume: game.sound.volume });
        });
        backBtn.on('pointerout', () => {
          backBtn.setStyle({ backgroundColor: '#ffffff' });
        });
        backBtn.on('pointerdown', () => {
          this.sound.play('clickselect', { volume: game.sound.volume });
          this.scene.start('MenuScene');
        });
      }
    }

    // -------------------------------------------------------
    // Level1Sceneï¼šå–®æ©Ÿç¬¬ä¸€é—œ
    // -------------------------------------------------------
    class Level1Scene extends BaseLevelScene {
      constructor() {
        super('single_1Scene', {
          backgroundKey: 'level1',
          timeLimit: 6,
          passScore: 0,
          nextScene: 'single_2Scene',
          showSnake: false,
          showEagle: false
        });
      }

      preload() {
        // è¼‰å…¥èƒŒæ™¯éŸ³æ¨‚

        super.preload();
        this.load.audio('bgm_level1', 'asset/audio/level1.mp3');
        this.load.image('level1', 'asset/menu/sence/level1.jpg');
      }
      create() {
        // é€²é—œå¡çœŸçš„é–‹å§‹æ™‚ï¼Œå…ˆåœæ‰å¤§å»³éŸ³æ¨‚
        this.sound.stopByKey('bgm');

        // æ’­æ”¾é—œå¡è‡ªå·±çš„ BGM
        this.bgm = this.sound.add('bgm_level1', { loop: true, volume: 0.5 });
        this.bgm.play();

        super.create();
      }

      endLevel() {
        super.endLevel();
        if (this.bgm?.isPlaying) this.bgm.stop();
      }

      update() {
        super.update();
      }
    }

    // -------------------------------------------------------
    // Level2Sceneï¼šå–®æ©Ÿç¬¬äºŒé—œ
    // -------------------------------------------------------
    class Level2Scene extends BaseLevelScene {
      constructor() {
        super('single_2Scene', {
          backgroundKey: 'level2',
          timeLimit: 5,
          passScore: 0,
          nextScene: 'single_3Scene',
          showSnake: true,
          showEagle: true
        });
      }

      preload() {
        super.preload();
        this.load.audio('bgm_level2', 'asset/audio/level2.mp3');
        this.load.image('level2', 'asset/menu/sence/level2.jpg');
        this.load.spritesheet('snake', 'asset/snake.png', { frameWidth: 330, frameHeight: 136 });
        this.load.spritesheet('eagle', 'asset/engle.png', { frameWidth: 68, frameHeight: 115 });
        // â”€â”€â”€ è¦†å¯«é è¨­ key â”€â”€â”€
        // æŠŠåŸæœ¬ç”¨ä¾†ç”¢ç”Ÿæ°´æœçš„è²¼åœ–å¾ TextureManager åˆªé™¤
        this.textures.remove('red');
        this.textures.remove('black');
        this.textures.remove('gold');
        this.textures.remove('colorful');

        // å†ç”¨ç›¸åŒçš„ key é‡æ–° loadï¼Œä½ è‡ªå·±çš„ soda åœ–å°±æœƒå–ä»£æ‰åŸæœ¬çš„
        this.load.image('red', 'asset/soda/soda1.png');
        this.load.image('black', 'asset/soda/soda3.png');
        this.load.image('gold', 'asset/soda/soda2.png');
        this.load.image('colorful', 'asset/soda/soda4.png');
      }

      create() {
        this.sound.stopByKey('bgm');

        // æ’­æ”¾é—œå¡è‡ªå·±çš„ BGM
        this.bgm = this.sound.add('bgm_level2', { loop: true, volume: 0.5 });
        this.bgm.play();

        super.create();
        this.lastDirection = 'right';
      }
      endLevel() {
        super.endLevel();
        if (this.bgm?.isPlaying) this.bgm.stop();
      }

      update() {
        super.update();
      }

    }

    // -------------------------------------------------------
    // Level3Sceneï¼šå–®æ©Ÿç¬¬ä¸‰é—œï¼Œæœ‰é›¨å’Œç©æ°´
    // -------------------------------------------------------
    class Level3Scene extends BaseLevelScene {
      constructor() {
        super('single_3Scene', {
          backgroundKey: 'level3',
          timeLimit: 60,
          passScore: 200,
          nextScene: 'EndStoryScene',
          showSnake: true,
          showEagle: true
        });
      }

      preload() {
        // å…ˆå‘¼å«çˆ¶é¡åˆ¥ï¼ŒæŠŠæ‰€æœ‰å…±ç”¨è³‡æº queue é€²ä¾†
        super.preload();
        this.load.audio('bgm_level3', 'asset/audio/level3.mp3');
        this.load.audio('rain', 'asset/audio/rain.mp3');
        // â”€â”€ æŠŠåŸæœ¬çš„æ°´æœ key æ¸…æ‰ â”€â”€
        this.textures.remove('red');
        this.textures.remove('black');
        this.textures.remove('gold');
        this.textures.remove('colorful');

        // â”€â”€ å†è¼‰å…¥ä½ çš„æ–°è²¼åœ–ï¼Œç”¨ç›¸åŒçš„ key è¦†è“‹å®ƒ â”€â”€
        this.load.image('red', 'asset/ham/ham1.png');
        this.load.image('black', 'asset/ham/ham2.png');
        this.load.image('gold', 'asset/ham/ham3.png');
        this.load.image('colorful', 'asset/ham/ham4.png');

        // ç„¶å¾Œè¼‰å…¥ç¬¬ä¸‰é—œç‰¹æœ‰çš„èƒŒæ™¯ã€è›‡ã€è€é·¹ã€æ°´æ»´ã€ç©æ°´â€¦â€¦
        this.load.image('level3', 'asset/menu/sence/level3.jpg');
        this.load.spritesheet('snake', 'asset/snake.png', { frameWidth: 330, frameHeight: 136 });
        this.load.spritesheet('eagle', 'asset/engle.png', { frameWidth: 68, frameHeight: 115 });
        this.load.image('raindrop', 'asset/raindrop.png');
        this.load.image('puddle', 'asset/puddle.png');
      }


      create() {
        this.sound.stopByKey('bgm');

        // æ’­æ”¾é—œå¡è‡ªå·±çš„ BGM
        this.bgm = this.sound.add('bgm_level3', { loop: true, volume: 0.5 });
        this.bgm.play();
        // æ’­æ”¾é—œå¡è‡ªå·±çš„ BGM
        this.bgm = this.sound.add('rain', { loop: true, volume: 0.5 });
        this.bgm.play();
        super.create();

        const W = this.scale.width;
        const H = this.scale.height;
        const rainParticles = this.add.particles('raindrop');
        this.rainEmitter = rainParticles.createEmitter({
          x: { min: 0, max: W },
          y: 0,
          lifespan: 2000,
          speedY: { min: 400, max: 600 },
          scale: { start: 0.02, end: 0.02 },
          quantity: 2,
          frequency: 50,
          blendMode: 'NORMAL'
        });
        rainParticles.setDepth(5);

        const groundTopY = this.ground.y - this.ground.displayHeight;
        this.rainEmitter.setDeathZone({
          type: 'onEnter',
          source: new Phaser.Geom.Rectangle(0, groundTopY, W, H - groundTopY)
        });

        this.puddles = this.physics.add.staticGroup();
        this.shouldSpawn = true;
        this.time.addEvent({
          delay: 5000,
          callback: this.togglePuddles,
          callbackScope: this,
          loop: true
        });

        this.lastDirection = 'right';
      }

      togglePuddles() {
        const W = this.scale.width;
        const groundTopY = this.ground.y - this.ground.displayHeight;
        if (this.shouldSpawn) {
          for (let i = 0; i < 2; i++) {
            const x = Phaser.Math.Between(50, W - 50);
            this.puddles.create(x, groundTopY, 'puddle')
              .setOrigin(0.5, 0.5)
              .setScale(0.08)
              .refreshBody();
          }
        } else {
          const children = this.puddles.getChildren();
          for (let i = 0; i < 2 && children.length > 0; i++) {
            children[0].destroy();
          }
        }
        this.shouldSpawn = !this.shouldSpawn;
      }
      endLevel() {
        super.endLevel();
        if (this.bgm?.isPlaying) this.bgm.stop();
      }

      update() {
        super.update();

        let isOnPuddle = false;
        if (this.puddles) {
          this.puddles.getChildren().forEach(puddle => {
            if (Phaser.Geom.Intersects.RectangleToRectangle(this.player.getBounds(), puddle.getBounds())) {
              isOnPuddle = true;
            }
          });
        }
        this.player.isSlowed = isOnPuddle;
      }
    }

    // -------------------------------------------------------
    // Level1Scene_mulitï¼šå¤šäººç¬¬ä¸€é—œ
    // -------------------------------------------------------
    class Level1Scene_mulit extends BaseLevelScene_mulit {
      constructor() {
        super('Level1Scene_mulit', {
          backgroundKey: 'level1',
          timeLimit: 60,
          passScore: 1,
          nextScene: 'Level2Scene_mulit',
          showSnake: false,
          showEagle: false
        });
      }

      preload() {
        super.preload();
        this.load.audio('bgm_level1', 'asset/audio/level1.mp3');
        this.load.image('level1', 'asset/menu/sence/level1.jpg');
      }
      create() {
        // é€²é—œå¡çœŸçš„é–‹å§‹æ™‚ï¼Œå…ˆåœæ‰å¤§å»³éŸ³æ¨‚
        this.sound.stopByKey('bgm');

        // æ’­æ”¾é—œå¡è‡ªå·±çš„ BGM
        this.bgm = this.sound.add('bgm_level1', { loop: true, volume: 0.5 });
        this.bgm.play();

        super.create();
      }

      endLevel() {
        super.endLevel();
        if (this.bgm?.isPlaying) this.bgm.stop();
      }

      update() {
        super.update();
      }
    }

    // -------------------------------------------------------
    // Level2Scene_mulitï¼šå¤šäººç¬¬äºŒé—œ
    // -------------------------------------------------------
    class Level2Scene_mulit extends BaseLevelScene_mulit {
      constructor() {
        super('Level2Scene_mulit', {
          backgroundKey: 'level2',
          timeLimit: 60,
          passScore: 1,
          nextScene: 'Level3Scene_mulit',
          showSnake: true,
          showEagle: true
        });
      }

      preload() {

        // â”€â”€â”€ è¦†å¯«é è¨­ key â”€â”€â”€
        // æŠŠåŸæœ¬ç”¨ä¾†ç”¢ç”Ÿæ°´æœçš„è²¼åœ–å¾ TextureManager åˆªé™¤
        this.textures.remove('red');
        this.textures.remove('black');
        this.textures.remove('gold');
        this.textures.remove('colorful');

        // å†ç”¨ç›¸åŒçš„ key é‡æ–° loadï¼Œä½ è‡ªå·±çš„ soda åœ–å°±æœƒå–ä»£æ‰åŸæœ¬çš„
        this.load.image('red', 'asset/soda/soda1.png');
        this.load.image('black', 'asset/soda/soda3.png');
        this.load.image('gold', 'asset/soda/soda2.png');
        this.load.image('colorful', 'asset/soda/soda4.png');
        super.preload();
        this.load.audio('bgm_level2', 'asset/audio/level2.mp3');
        this.load.image('level2', 'asset/menu/sence/level2.jpg');
        this.load.spritesheet('snake', 'asset/snake.png', { frameWidth: 330, frameHeight: 136 });
        this.load.spritesheet('eagle', 'asset/engle.png', { frameWidth: 68, frameHeight: 115 });


      }

      create() {
        this.sound.stopByKey('bgm');

        // æ’­æ”¾é—œå¡è‡ªå·±çš„ BGM
        this.bgm = this.sound.add('bgm_level2', { loop: true, volume: 0.5 });
        this.bgm.play();
        super.create();
        this.lastDirection = 'right';
      }
      endLevel() {
        super.endLevel();
        if (this.bgm?.isPlaying) this.bgm.stop();
      }

      update() {
        super.update();
      }
    }

    // -------------------------------------------------------
    // Level3Scene_mulitï¼šå¤šäººç¬¬ä¸‰é—œï¼Œæœ‰é›¨å’Œç©æ°´
    // -------------------------------------------------------
    class Level3Scene_mulit extends BaseLevelScene_mulit {
      constructor() {
        super('Level3Scene_mulit', {
          backgroundKey: 'level3',
          timeLimit: 60,
          passScore: 0,
          nextScene: false,
          showSnake: true,
          showEagle: true
        });
      }

      preload() {
        // â”€â”€ æŠŠåŸæœ¬çš„æ°´æœ key æ¸…æ‰ â”€â”€
        this.textures.remove('red');
        this.textures.remove('black');
        this.textures.remove('gold');
        this.textures.remove('colorful');

        // â”€â”€ å†è¼‰å…¥ä½ çš„æ–°è²¼åœ–ï¼Œç”¨ç›¸åŒçš„ key è¦†è“‹å®ƒ â”€â”€
        this.load.image('red', 'asset/ham/ham1.png');
        this.load.image('black', 'asset/ham/ham2.png');
        this.load.image('gold', 'asset/ham/ham3.png');
        this.load.image('colorful', 'asset/ham/ham4.png');

        super.preload();
         this.load.audio('bgm_level3', 'asset/audio/level3.mp3');
        this.load.audio('rain', 'asset/audio/rain.mp3');
        this.load.image('level3', 'asset/menu/sence/level3.jpg');
        this.load.spritesheet('snake', 'asset/snake.png', { frameWidth: 330, frameHeight: 136 });
        this.load.spritesheet('eagle', 'asset/engle.png', { frameWidth: 68, frameHeight: 115 });
        this.load.image('raindrop', 'asset/raindrop.png');
        this.load.image('puddle', 'asset/puddle.png');


      }

      create() {
         this.sound.stopByKey('bgm');

        // æ’­æ”¾é—œå¡è‡ªå·±çš„ BGM
        this.bgm = this.sound.add('bgm_level3', { loop: true, volume: 0.5 });
        this.bgm.play();
        // æ’­æ”¾é—œå¡è‡ªå·±çš„ BGM
        this.bgm = this.sound.add('rain', { loop: true, volume: 0.5 });
        this.bgm.play();
        super.create();

        const W = this.scale.width;
        const H = this.scale.height;
        const rainParticles = this.add.particles('raindrop');
        this.rainEmitter = rainParticles.createEmitter({
          x: { min: 0, max: W },
          y: 0,
          lifespan: 2000,
          speedY: { min: 400, max: 600 },
          scale: { start: 0.02, end: 0.02 },
          quantity: 2,
          frequency: 50,
          blendMode: 'NORMAL'
        });
        rainParticles.setDepth(5);

        const groundTopY = this.ground.y - this.ground.displayHeight;
        this.rainEmitter.setDeathZone({
          type: 'onEnter',
          source: new Phaser.Geom.Rectangle(0, groundTopY, W, H - groundTopY)
        });

        this.puddles = this.physics.add.staticGroup();
        this.shouldSpawn = true;
        this.time.addEvent({
          delay: 5000,
          callback: this.togglePuddles,
          callbackScope: this,
          loop: true
        });

        this.lastDirection = 'right';
      }

      togglePuddles() {
        const W = this.scale.width;
        const groundTopY = this.ground.y - this.ground.displayHeight;
        if (this.shouldSpawn) {
          for (let i = 0; i < 2; i++) {
            const x = Phaser.Math.Between(50, W - 50);
            this.puddles.create(x, groundTopY, 'puddle')
              .setOrigin(0.5, 0.5)
              .setScale(0.08)
              .refreshBody();
          }
        } else {
          const children = this.puddles.getChildren();
          for (let i = 0; i < 2 && children.length > 0; i++) {
            children[0].destroy();
          }
        }
        this.shouldSpawn = !this.shouldSpawn;
      }
       endLevel() {
        super.endLevel();
        if (this.bgm?.isPlaying) this.bgm.stop();
      }

      update() {
        super.update();

        let isOnPuddle1 = false, isOnPuddle2 = false;
        if (this.puddles) {
          this.puddles.getChildren().forEach(puddle => {
            if (Phaser.Geom.Intersects.RectangleToRectangle(this.player.getBounds(), puddle.getBounds())) {
              isOnPuddle1 = true;
            }
            if (Phaser.Geom.Intersects.RectangleToRectangle(this.player2.getBounds(), puddle.getBounds())) {
              isOnPuddle2 = true;
            }
          });
        }
        this.player.isSlowed = isOnPuddle1;
        this.player2.isSlowed = isOnPuddle2;
      }
    }

    // -------------------------------------------------------
    // EndStorySceneï¼šçµå°¾æ•…äº‹é¡¯ç¤º
    // -------------------------------------------------------
    const endstoryText = [
      "æœ€çµ‚ï¼Œ",
      "ä½ æˆ°å‹å·¨é·¹ã€å·¨èŸ’èˆ‡æƒ¡åŠ£å¤©å€™ï¼Œ",
      "æ‘˜ä¸‹å½©è™¹è˜‹æœï¼›è˜‹æœè¿¸ç™¼å…‰èŠ’ï¼Œ",
      "é‡å•Ÿå¤§åœ°ç”Ÿæ©Ÿã€‚",
      "ä½ å¸¶ç€å¥‡è¹Ÿæ­¸ä¾†ï¼Œ",
      "ï¼Œæˆç‚ºä¸–äººæ™¯ä»°çš„æ°¸æ†å‚³å¥‡ã€‚"
    ];

    class EndStoryScene extends Phaser.Scene {
      constructor() {
        super({ key: 'EndStoryScene' });
      }

      preload() {
        this.load.image('level3', 'asset/menu/sence/level3.jpg');
      }

      create() {
        const W = this.scale.width;
        const H = this.scale.height;

        this.add.image(W / 2, H / 2, 'level3')
          .setDisplaySize(W, H)
          .setAlpha(0.7);

        const rectW = W - 100;
        const rectH = H * 0.7;
        const rectX = W / 2;
        const rectY = H / 2;
        const pad = 5;

        this.add.rectangle(rectX, rectY, rectW, rectH, 0x000000, 0.6).setOrigin(0.5);

        const maskG = this.make.graphics();
        maskG.fillRect(rectX - rectW / 2, rectY - rectH / 2, rectW, rectH);
        const mask = maskG.createGeometryMask();

        this.fullText = endstoryText.join(' ');
        this.text = this.add.text(
          rectX - rectW / 2 + pad,
          rectY - rectH / 2 + pad,
          '',
          {
            fontFamily: 'a',
            fontSize: '24px',
            color: '#ffffff',
            align: 'left',
            wordWrap: { width: rectW - pad * 2, useAdvancedWrap: true },
            lineSpacing: 30
          }
        ).setOrigin(0).setMask(mask);

        this.charIndex = 0;
        this.typeNextChar();
      }

      typeNextChar() {
        this.charIndex++;
        this.text.setText(this.fullText.substr(0, this.charIndex));
        if (this.charIndex < this.fullText.length) {
          this.time.delayedCall(40, () => this.typeNextChar());
        } else {
          this.time.delayedCall(500, () => this.scene.start('CreditScene'));
        }
      }
    }

    // -------------------------------------------------------
    // CreditSceneï¼šè£½ä½œåœ˜éšŠå ´æ™¯ï¼Œæ»¾å‹•æ–‡å­—
    // -------------------------------------------------------
    class CreditScene extends Phaser.Scene {
      constructor() {
        super({ key: 'CreditScene' });
      }

      preload() {
        this.load.image('level3', 'asset/menu/sence/level3.jpg');
      }

      create() {
        const W = this.scale.width;
        const H = this.scale.height;

        this.add.image(W / 2, H / 2, 'level3')
          .setDisplaySize(W, H)
          .setAlpha(0.7);

        const credits = [
          'è£½ä½œåœ˜éšŠ',
          'è£½ä½œäººï¼š\né™³æŸç¿Ray\n è‘‰ä¿¡å®Yeah\næé•·è»’Sherwin\nå³ç´˜ç¿Henry',
          'è…³æœ¬ï¼š\né™³æŸç¿Ray\n è‘‰ä¿¡å®Yeah\næé•·è»’Sherwin\nå³ç´˜ç¿Henry',
          'ç¨‹å¼ï¼š\né™³æŸç¿Ray',
          'ç¾è¡“ï¼š\né™³æŸç¿Ray\n è‘‰ä¿¡å®Yeah',
          'éŸ³æ•ˆï¼š\né™³æŸç¿Ray\nOpen Game Artâ„¢',
          'æ„Ÿè¬éŠç©ï¼'
        ];

        const creditText = this.add.text(W / 2, H + 20, credits.join('\n'), {
          fontFamily: 'a',
          fontSize: '32px',
          color: '#ffffff',
          align: 'center',
          lineSpacing: 32
        }).setOrigin(0.5, 0);

        const maskG = this.make.graphics();
        maskG.fillRect(50, 50, W - 100, H - 100);
        const mask = maskG.createGeometryMask();
        creditText.setMask(mask);

        const totalHeight = creditText.height + 100;
        this.tweens.add({
          targets: creditText,
          y: -totalHeight,
          ease: 'Linear',
          duration: totalHeight * 20,
          onComplete: () => {
            // æ»¾å‹•å®Œæˆå¾Œï¼Œé¡¯ç¤ºã€Œä¸»ç•«é¢ã€æŒ‰éˆ•
            const btn = this.add.text(W - 20, H - 20, 'ä¸»ç•«é¢', {
              fontFamily: 'a',
              fontSize: '24px',
              color: '#ffff00',
              backgroundColor: '#000',
              padding: { x: 10, y: 5 }
            }).setOrigin(1, 1).setInteractive({ useHandCursor: true });

            btn.on('pointerdown', () => {
              this.scene.start('MenuScene');
            });

            // å…è¨±ç”¨æ»‘é¼ æ»¾è¼ªæ‰‹å‹•æ»¾å‹•æ–‡å­—
            this.input.on('wheel', (_p, _g, _dx, dy) => {
              creditText.y -= dy;
              const minY = H - creditText.height - 50;
              const maxY = 50;
              if (creditText.y < minY) creditText.y = minY;
              if (creditText.y > maxY) creditText.y = maxY;
            });
          }
        });
      }
    }

    // -------------------------------------------------------
    // Phaser éŠæˆ²é…ç½®ï¼šä½¿ç”¨ Scale Manager è‡ªé©æ‡‰å…¨è¢å¹•
    // -------------------------------------------------------
    const config = {
      type: Phaser.AUTO,

      scale: {
        mode: Phaser.Scale.RESIZE,                 // ä¿æŒå¯¬é«˜æ¯”æ”¾å¤§
        autoCenter: Phaser.Scale.CENTER_BOTH,   // æ°´å¹³ã€å‚ç›´ç½®ä¸­
        width: window.innerWidth,               // åˆå§‹å¯¬åº¦ = è¦–çª—å¯¬åº¦
        height: window.innerHeight              // åˆå§‹é«˜åº¦ = è¦–çª—é«˜åº¦
      },

      backgroundColor: '#2d2d2d',
      pixelArt: true,
      physics: {
        default: 'arcade',
        arcade: {
          gravity: { y: 500 },
          debug: false,
          debugShowBody: false,
          debugShowVelocity: false
        }
      },

      scene: [
        BootScene,
        MenuScene,
        StoryScene,
        ModeScene,
        Level1Scene,
        Level2Scene,
        Level3Scene,
        Level1Scene_mulit,
        Level2Scene_mulit,
        Level3Scene_mulit,
        MulitLevelSelectScene,
        SettingScene,
        EndStoryScene,
        CreditScene
      ]
    };

    // ç•¶è¦–çª—å¤§å°æ”¹è®Šæ™‚ï¼Œå‹•æ…‹èª¿æ•´ Phaser ç•«å¸ƒ
    window.addEventListener('resize', () => {
      game.scale.resize(window.innerWidth, window.innerHeight);
    });

    const game = new Phaser.Game(config);
  </script>
</body>

</html>
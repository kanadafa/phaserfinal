<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <title>Phaser UI Example</title>
  <script src="./asset/phaser@3.55.2.min.js"></script>
  //
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fontfaceobserver/2.1.0/fontfaceobserver.standalone.js"></script>
  <!-- 引入 FontFaceObserver -->
  <!-- <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js"></script> -->
</head>

<body>

  <style>
    @font-face {
      font-family: 'a';
      src: url('asset/fonts/Cubic_11.woff') format('woff');

    }

    /* 讓整個頁面佔滿視窗，並移除滾動條 */
    html,
    body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background-color: #000;
      overflow: hidden;
    }

    /* Phaser 會自動插入 <canvas>，讓它不留空隙 */
    canvas {
      display: block;
    }
  </style>

  <script>
    // -------------------------------------------------------
    // BootScene：只負責播放背景音樂並啟動 MenuScene
    // -------------------------------------------------------
    class BootScene extends Phaser.Scene {
      constructor() {
        super({ key: 'BootScene', active: true });
      }

      preload() {
        this.load.audio('bgm', 'asset/audio/bgm.mp3');
      }

      create() {

        this.sound.play('bgm', { loop: true, volume: 1 });
        this.scene.launch('MenuScene');
      }
    }

    // -------------------------------------------------------
    // MenuScene：含背景影片、按鈕、字體載入
    // -------------------------------------------------------
    class MenuScene extends Phaser.Scene {
      constructor() {
        super({ key: 'MenuScene' });
      }

      preload() {
        // 大廳 BGM （如果你在 BootScene 已載入，也可以不重複載）
        // this.load.audio('bgm', 'asset/audio/bgm.mp3');

        // UI 音效
        this.load.audio('btnselect', 'asset/audio/select07.mp3');
        this.load.audio('clickselect', 'asset/audio/click.mp3');

        // 背景影片 + 備用背景
        this.load.video('home', 'asset/video/home.mp4', 'loadeddata', false, true);
        this.load.image('bg', 'asset/menu/bg.jpg');

        // 按鈕素材
        this.load.image('btn_start', 'asset/menu/btn_start.png');
        this.load.image('btn_setting', 'asset/menu/btn_setting.png');
        this.load.image('btn_exit', 'asset/menu/btn_exit.png');

        // （可選）字體載入腳本
        // this.load.script('fontface', 'https://cdnjs.cloudflare.com/.../fontfaceobserver.standalone.js');
      }

      create() {
        const W = this.scale.width;
        const H = this.scale.height;
        this.sound.stopAll();

        // 1. 確保大廳 BGM 正在播
        const bgmSound = this.sound.get('bgm');
        if (!bgmSound || !bgmSound.isPlaying) {
          this.sound.play('bgm', { loop: true, volume: 1 });
        }

        // 2. 背景影片
        const homeVideo = this.add.video(W / 2, H / 2, 'home')
          .setDisplaySize(W, H)
          .setDepth(0)
          .setMute(true);

        const raw = homeVideo.video;
        let revInt = null;
        const startReverse = () => {
          raw.pause();
          setTimeout(() => {
            revInt = setInterval(() => {
              if (raw.currentTime <= 0.04) {
                clearInterval(revInt);
                setTimeout(() => { raw.currentTime = 0.01; raw.play(); }, 500);
              } else {
                raw.currentTime -= 1 / 45;
              }
            }, 1000 / 45);
          }, 500);
        };
        raw.addEventListener('ended', startReverse);
        raw.currentTime = 0.01;
        homeVideo.play(false);
        this.events.on('shutdown', () => {
          if (revInt) clearInterval(revInt);
          raw.removeEventListener('ended', startReverse);
        });

        // 3. 靜態備用背景
        this.add.image(W / 2, H / 2, 'bg')
          .setDisplaySize(W, H)
          .setDepth(-1);

        // 4. UI 音效回饋
        const overSound = this.sound.add('btnselect');
        const clickSound = this.sound.add('clickselect');
        this.input.on('gameobjectover', () => overSound.play());
        this.input.on('gameobjectdown', () => clickSound.play());

        // 5. 標題文字（FontFaceObserver 可選）
        if (window.FontFaceObserver) {
          new FontFaceObserver('a').load().then(() => {
            const spaced = '獵人\u200AX\u200A蘋果'.split('').join('\u200A');
            this.add.text(W / 2, H * 0.15, spaced, {
              fontFamily: 'a',
              fontSize: '100px'
            })
              .setOrigin(0.5)
              .setTintFill(0xff0000, 0xffff00, 0xff6600, 0xffffff);
          }).catch(() => {
            this.add.text(W / 2, H * 0.15, '獵人X蘋果', {
              fontFamily: 'Arial', fontSize: '64px', color: '#fff'
            }).setOrigin(0.5);
          });
        } else {
          this.add.text(W / 2, H * 0.15, '獵人X蘋果', {
            fontFamily: 'Arial', fontSize: '64px', color: '#fff'
          }).setOrigin(0.5);
        }

        // 6. START 按鈕
        const startBtn = this.add.image(W / 2, H * 0.417, 'btn_start')
          .setOrigin(0.5).setScale(0.35)
          .setInteractive({ useHandCursor: true });
        startBtn
          .on('pointerover', () => startBtn.setScale(0.38).setAlpha(0.8))
          .on('pointerout', () => startBtn.setScale(0.35).setAlpha(1))
          .on('pointerdown', () => {
            clickSound.play();
            this.scene.start('StoryScene');
          });

        // 7. SETTING 按鈕
        const setBtn = this.add.image(W / 2, H * 0.667, 'btn_setting')
          .setOrigin(0.5).setScale(0.35)
          .setInteractive({ useHandCursor: true });
        setBtn
          .on('pointerover', () => setBtn.setScale(0.38).setAlpha(0.8))
          .on('pointerout', () => setBtn.setScale(0.35).setAlpha(1))
          .on('pointerdown', () => {
            clickSound.play();
            this.scene.start('SettingScene');
          });

        // 8. EXIT 按鈕
        const exitBtn = this.add.image(W / 2, H * 0.917, 'btn_exit')
          .setOrigin(0.5).setScale(0.35)
          .setInteractive({ useHandCursor: true });
        exitBtn
          .on('pointerover', () => exitBtn.setScale(0.38).setAlpha(0.8))
          .on('pointerout', () => exitBtn.setScale(0.35).setAlpha(1))
          .on('pointerdown', () => window.close());
      }

      update() {
        // MenuScene 不需要每幀更新
      }
    }


    // -------------------------------------------------------
    // StoryScene：顯示故事文字，打字特效，可跳過
    // -------------------------------------------------------
    const storyText = [
      "在遙遠的森林深處，有一棵巨大的蘋果樹，這棵巨樹聳立在萬年古林中。",
      "每當蘋果成熟時，樹上會掉落閃亮的金色蘋果，傳聞它的果實每吃一顆就能延壽一年。",
      "運氣好甚至可能會遇見更稀有的彩虹蘋果，吃下去能得永生。",
      "這些蘋果吸引了無數冒險者和尋寶獵人的目光。",
      "你是一名年輕的尋寶獵人，決定深入森林，冒險尋找這棵神奇的蘋果樹。",
      "當你運氣好成功找到了，正想依靠它發家致富時",
      "卻遭遇許多危機",
      "有大老鷹很蟒蛇等著你，甚至是惡劣的天氣",
      "你冒著生命危險闖入森林深處，是死也要成功把傳說中的彩虹蘋果帶回去。"
    ];

    class StoryScene extends Phaser.Scene {
      constructor() {
        super({ key: 'StoryScene' });
      }

      preload() {
        this.load.image('bg', 'asset/menu/bg.png');
      }

      create() {
        const W = this.scale.width;
        const H = this.scale.height;

        // 背景圖
        this.add.image(W / 2, H / 2, 'bg')
          .setDisplaySize(W, H)
          .setAlpha(0.7);

        // 矩形框尺寸
        const rectWidth = W - 100;
        const rectHeight = H * 0.7;
        const rectX = W / 2;
        const rectY = H / 2;
        const padding = 5;

        // 背景框（半透明黑）
        this.add.rectangle(rectX, rectY, rectWidth, rectHeight, 0x000000, 0.6)
          .setOrigin(0.5);

        // 建立遮罩
        const maskG = this.make.graphics();
        maskG.fillRect(
          rectX - rectWidth / 2,
          rectY - rectHeight / 2,
          rectWidth,
          rectHeight
        );
        const mask = maskG.createGeometryMask();

        // 全文合併
        this.fullText = storyText.join(' ');

        // 文字物件（打字區域）
        this.text = this.add.text(
          rectX - rectWidth / 2 + padding,
          rectY - rectHeight / 2 + padding,
          '',
          {
            fontFamily: 'a',
            fontSize: '24px',
            color: '#ffffff',
            wordWrap: {
              width: rectWidth - padding * 2,
              useAdvancedWrap: true
            }
          }
        )
          .setOrigin(0, 0)
          .setMask(mask);

        // 底部提示文字
        this.add.text(W / 2, H - 20, '按 SPACE 鍵跳過', {
          fontFamily: 'a',
          fontSize: '36px',
          color: '#ffffff'
        })
          .setOrigin(0.5, 1);

        // 打字特效初始化
        this.charIndex = 0;
        this.typeNextChar();

        // 按 SPACE 跳過
        this.input.keyboard.on('keydown-SPACE', () => this.skipStory());
      }

      typeNextChar() {
        this.charIndex++;
        this.text.setText(this.fullText.substr(0, this.charIndex));

        if (this.charIndex < this.fullText.length) {
          this.time.delayedCall(40, () => this.typeNextChar());
        } else {
          this.time.delayedCall(1500, () => {
            this.scene.start('ModeScene');
          });
        }
      }

      skipStory() {
        this.time.removeAllEvents();
        this.scene.start('ModeScene');
      }
    }

    // -------------------------------------------------------
    // ModeScene：顯示操作說明，完成後顯示按鈕
    // -------------------------------------------------------
    class ModeScene extends Phaser.Scene {
      constructor() {
        super({ key: 'ModeScene' });
      }

      preload() {
        this.load.audio('btnselect', 'asset/audio/select07.mp3');
        this.load.audio('clickselect', 'asset/audio/click.mp3');
        this.load.image('single', 'asset/menu/playmode/single.png');
        this.load.image('mulit', 'asset/menu/playmode/mulit.png');
        this.load.image('back', 'asset/back.png');
        this.load.image('modebg', 'asset/menu/modebg.jpeg');
      }

      create() {
        const W = this.scale.width;
        const H = this.scale.height;

        // 1) 背景圖（半透明）
        this.add
          .image(W / 2, H / 2, 'modebg')
          .setDisplaySize(W, H)
          .setDepth(0);

        this.helpTexts = [
          '【 P1模式 控制方式 】\n\n' +
          '← / →  ←→ 移動\n' +
          '↑        跳躍\n' +
          '↓        趴下\n\n' +
          '【  P2模式 控制方式 】\n\n' +
          'A / D  ←→ 移動\n' +
          'W        跳躍\n' +
          'S        趴下\n\n' +
          '按任意鍵或點擊，繼續下一段說明',

          '【 遊戲目標 】\n\n' +
          ' 每關卡限時60秒 \n\n' +
          '【 P1模式 】過關標準分別100、150、200 \n\n' +
          '【 P2模式 】比誰的分數比較多 \n\n',

          '【 注意事項 】\n\n' +
          '1.🍎的種類不同會加分與扣分。\n\n' +
          '2.🐍要隨時注意綠綠長長(-15)。\n\n' +
          '3.🦅小心飛過頭上(-20)。\n\n' +
          '按任意鍵或點擊，開始遊戲～'
        ];

        this.currentHelpIndex = 0;

        // 遮罩
        this.overlay = this.add
          .rectangle(0, 0, W, H, 0x000000, 0.7)
          .setOrigin(0)
          .setDepth(1000);

        // 說明文字
        this.helpText = this.add
          .text(
            W / 2,
            H / 2,
            this.helpTexts[this.currentHelpIndex],
            {
              fontFamily: 'a',
              fontSize: '28px',
              color: '#ffffff',
              align: 'center',
              wordWrap: { width: W * 0.8, useAdvancedWrap: true }
            }
          )
          .setOrigin(0.5)
          .setDepth(1001);

        // 一次性按鍵或點擊事件
        this.input.keyboard.once('keydown', () => {
          this.showNextHelp();
        });
        this.input.once('pointerdown', () => {
          this.showNextHelp();
        });
      }

      showNextHelp() {
        this.currentHelpIndex++;

        if (this.currentHelpIndex < this.helpTexts.length) {
          this.helpText.setText(this.helpTexts[this.currentHelpIndex]);

          this.input.keyboard.once('keydown', () => {
            this.showNextHelp();
          });
          this.input.once('pointerdown', () => {
            this.showNextHelp();
          });
        } else {
          // 移除遮罩與文字
          this.overlay.destroy();
          this.helpText.destroy();
          this.showModeButtons();
        }
      }

      showModeButtons() {
        const W = this.scale.width;
        const H = this.scale.height;
        const overSound = this.sound.add('btnselect');
        const clickSound = this.sound.add('clickselect');

        // 再顯示一張半透明背景
        this.add
          .image(W / 2, H / 2, 'modebg')
          .setDisplaySize(W, H)
          .setAlpha(0.7)
          .setDepth(0);

        this.input.on('gameobjectover', () => {
          overSound.play();
        });
        this.input.on('gameobjectdown', () => {
          clickSound.play();
        });

        // 返回按鈕（放在左上角偏一點）
        const backButton = this.add
          .image(W * 0.05, H * 0.05, 'back')
          .setOrigin(0.5)
          .setScale(0.075)
          .setInteractive({ useHandCursor: true })
          .setDepth(1);

        backButton.on('pointerover', () => {
          backButton.setScale(0.08).setAlpha(0.8);
        });
        backButton.on('pointerout', () => {
          backButton.setScale(0.075).setAlpha(1);
        });
        backButton.on('pointerdown', () => {
          this.scene.start('MenuScene');
        });

        // Single 按鈕
        const singleButton = this.add
          .image(W / 2, H * 0.417, 'single')
          .setOrigin(0.5)
          .setScale(0.35)
          .setInteractive({ useHandCursor: true })
          .setDepth(1);

        singleButton.on('pointerover', () => {
          singleButton.setScale(0.38).setAlpha(0.8);
        });
        singleButton.on('pointerout', () => {
          singleButton.setScale(0.35).setAlpha(1);
        });
        singleButton.on('pointerdown', () => {
          this.scene.start('single_1Scene');
        });

        // Multiplayer 按鈕
        const mulitButton = this.add
          .image(W / 2, H * 0.667, 'mulit')
          .setOrigin(0.5)
          .setScale(0.37)
          .setInteractive({ useHandCursor: true })
          .setDepth(1);

        mulitButton.on('pointerover', () => {
          mulitButton.setScale(0.40).setAlpha(0.8);
        });
        mulitButton.on('pointerout', () => {
          mulitButton.setScale(0.37).setAlpha(1);
        });
        mulitButton.on('pointerdown', () => {
          this.scene.start('MulitLevelSelectScene');
        });
      }
    }

    // -------------------------------------------------------
    // MulitLevelSelectScene：多人關卡選擇
    // -------------------------------------------------------
    class MulitLevelSelectScene extends Phaser.Scene {
      constructor() {
        super({ key: 'MulitLevelSelectScene' });
      }

      preload() {
        this.load.image('level_select_bg', 'asset/menu/bg.jpg');
        this.load.audio('btnselect', 'asset/audio/select07.mp3');
        this.load.audio('clickselect', 'asset/audio/click.mp3');
      }

      create() {
        const W = this.scale.width;
        const H = this.scale.height;

        const overSound = this.sound.add('btnselect');
        const clickSound = this.sound.add('clickselect');

        // 半透明遮罩
        this.add.rectangle(0, 0, W, H, 0x000000, 0.7).setOrigin(0);

        // 背景
        this.add.image(W / 2, H / 2, 'level_select_bg')
          .setDisplaySize(W, H)
          .setAlpha(0.4);

        // 主標題
        this.add.text(W / 2, H * 0.167, '選擇多人關卡', {
          fontFamily: 'a',
          fontSize: '48px',
          color: '#ffff00'
        }).setOrigin(0.5);

        const buttonData = [
          { relY: 0.3667, label: '關卡 1', scene: 'Level1Scene_mulit' },
          { relY: 0.55, label: '關卡 2', scene: 'Level2Scene_mulit' },
          { relY: 0.7333, label: '關卡 3', scene: 'Level3Scene_mulit' }
        ];
        buttonData.forEach(({ relY, label, scene }) => {
          const btn = this.add.rectangle(W / 2, H * relY, W * 0.375, H * 0.133, 0xffffff, 1)
            .setStrokeStyle(4, 0xff0000)
            .setInteractive({ useHandCursor: true });
          const text = this.add.text(W / 2, H * relY, label, {
            fontFamily: 'a',
            fontSize: '36px',
            color: '#000'
          }).setOrigin(0.5);

          btn.on('pointerover', () => {
            btn.setFillStyle(0xffcc00, 1);
            btn.setStrokeStyle(6, 0xff6600);
            overSound.play();
          });
          btn.on('pointerout', () => {
            btn.setFillStyle(0xffffff, 1);
            btn.setStrokeStyle(4, 0xff0000);
          });
          btn.on('pointerdown', () => {
            clickSound.play();
            this.scene.start(scene);
          });
        });

        // 返回按鈕
        const backBtn = this.add.text(W / 2, H * 0.9, '返回', {
          fontFamily: 'a',
          fontSize: '28px',
          color: '#ff0000',
          backgroundColor: '#fff'
        })
          .setOrigin(0.5)
          .setPadding(20, 8, 20, 8)
          .setInteractive({ useHandCursor: true });

        backBtn.on('pointerover', () => {
          backBtn.setStyle({ backgroundColor: '#ffc' });
          overSound.play();
        });
        backBtn.on('pointerout', () => backBtn.setStyle({ backgroundColor: '#fff' }));
        backBtn.on('pointerdown', () => {
          clickSound.play();
          this.scene.start('ModeScene');
        });
      }
    }

    // -------------------------------------------------------
    // BaseLevelScene：單機關卡共用邏輯
    // -------------------------------------------------------
    class BaseLevelScene extends Phaser.Scene {
      constructor(key, config) {
        super({ key });
        this.levelConfig = Object.assign({
          backgroundKey: '',
          timeLimit: 60,
          passScore: 0,
          nextScene: null,
          showSnake: false,
          showEagle: false
        }, config);
      }

      preload() {
        // 共用資源
        this.load.image('gr', 'asset/ground.png');
        this.load.image('black', 'asset/fruits/black.png');
        this.load.image('red', 'asset/fruits/red.png');
        this.load.image('gold', 'asset/fruits/gold.png');
        this.load.image('colorful', 'asset/fruits/colorful.png');
        this.load.spritesheet('player1', 'asset/player1.png', { frameWidth: 900, frameHeight: 472 });

        this.load.image('btnRestart', 'asset/reset.png');
        this.load.image('btnReturn', 'asset/home.png');
        this.load.image('btnNext', 'asset/next.png');
        this.load.audio('btnselect1', 'asset/audio/select07.mp3');
        this.load.audio('clickselect1', 'asset/audio/click.mp3');
        this.load.audio('eatapple', 'asset/audio/eatapple.mp3');
      }

      init(data) {
        this.mode = data.mode || 'single';
      }

      create() {
        const W = this.scale.width;
        const H = this.scale.height;

        this.btnSelectSound = this.sound.add('btnselect1');
        this.clickSelectSound = this.sound.add('clickselect1');
        this.eatapple = this.sound.add('eatapple', { volume: this.game.sound.volume });

        this.isGameOver = false;
        this.input.enabled = true;

        // 背景圖
        this.add.image(W / 2, H / 2, this.levelConfig.backgroundKey)
          .setDisplaySize(W, H);

        // 地面
        this.ground = this.physics.add.staticImage(
          W / 2,
          H - 1,
          'gr'
        )
          .setDisplaySize(W, 40)
          .setOrigin(0.5, 1)
          .refreshBody();

        // 角色
        this.player = this.physics.add
          .sprite(W / 2, 0, 'player1')
          .setScale(0.45)
          .setOrigin(0.5, 1)
          .setCollideWorldBounds(true);

        this.player.y = this.ground.y - this.ground.displayHeight;
        this.physics.add.collider(this.player, this.ground);

        this.player.body.setSize(260, 0);
        this.player.body.setOffset(380, 0);

        this.cursors = this.input.keyboard.createCursorKeys();
        this.createAnimations();

        // 分數與時間
        this.score = 0;
        this.timeLeft = this.levelConfig.timeLimit;
        this.rainbowDropped = false;

        this.scoreText = this.add.text(16, 16,
          `Score: 0 / ${this.levelConfig.passScore}`, {
          fontFamily: 'a',
          fontSize: '36px',
          color: '#ff0000',
          strokeThickness: 2
        }
        );

        this.timerText = this.add.text(W * 0.8125, 16, 'Time: ' + this.timeLeft, {
          fontFamily: 'a',
          fontSize: '36px',
          color: '#ffa500',
          strokeThickness: 2
        });

        this.timer = this.time.addEvent({ delay: 1000, callback: this.updateTimer, callbackScope: this, loop: true });

        // 掉落物
        this.fruits = this.physics.add.group();
        this.spawnEvent = this.time.addEvent({ delay: 800, callback: this.spawnFruit, callbackScope: this, loop: true });
        this.physics.add.overlap(this.player, this.fruits, this.collectFruit, null, this);

        // 老鷹
        if (this.levelConfig.showEagle) {
          this.eagles = this.physics.add.group();
          this.time.addEvent({ delay: 10000, callback: this.spawnEagle, callbackScope: this, loop: true });
          this.physics.add.overlap(this.player, this.eagles, this.hitEagle, null, this);
        }

        // 蛇
        if (this.levelConfig.showSnake) {
          this.isSnakeActive = false;
          this.time.delayedCall(10000, this.spawnSnake, null, this);
        }

        // 暫停功能
        this.isPaused = false;
        this.pauseOverlay = null;
        this.input.keyboard.on('keydown-ESC', () => {
          this.isPaused ? this.resumeGame() : this.pauseGame();
        });
      }

      update() {
        if (this.isPaused) return;

        if (Phaser.Input.Keyboard.JustDown(this.cursors.up) && this.player.body.blocked.down) {
          this.player.setVelocityY(-350);
        }

        this.player.setVelocityX(0);
        const speed = 300 * (this.player.isSlowed ? 0.6 : 1);

        if (this.cursors.left.isDown) {
          this.player.setVelocityX(-speed);
          this.lastDirection = 'left';
        } else if (this.cursors.right.isDown) {
          this.player.setVelocityX(speed);
          this.lastDirection = 'right';
        } else {
          this.player.setVelocityX(0);
        }

        if (this.cursors.down.isDown) {
          this.player.setVelocityX(0);
          this.player.anims.play('lie', true);
          this.player.setFlipX(this.lastDirection === 'left');
          return;
        }

        if (this.player.body.velocity.x < 0) {
          this.player.anims.play('walk_left', true);
          this.player.setFlipX(false);
        } else if (this.player.body.velocity.x > 0) {
          this.player.anims.play('walk_right', true);
          this.player.setFlipX(false);
        } else {
          this.player.anims.play('ready', true);
          this.player.setFlipX(this.lastDirection === 'left');
        }

        // 蛇邊界反彈：如果有蛇
        if (this.snake && this.snake.body && this.snake.body.velocity) {
          if (this.snake.body.velocity.x > 0) {
            this.snake.setFlipX(true);
          } else if (this.snake.body.velocity.x < 0) {
            this.snake.setFlipX(false);
          }
        }

        // 清理飛出畫面的老鷹
        if (this.eagles) {
          this.eagles.getChildren().forEach(eagle => {
            if (eagle.x < -50 || eagle.x > this.scale.width + 50) {
              eagle.destroy();
            }
          });
        }
      }

      createAnimations() {
        this.anims.create({
          key: 'walk_left',
          frames: this.anims.generateFrameNumbers('player1', { start: 0, end: 3 }),
          frameRate: 8,
          repeat: -1
        });
        this.anims.create({ key: 'ready', frames: [{ key: 'player1', frame: 4 }], frameRate: 1, repeat: -1 });
        this.anims.create({
          key: 'walk_right',
          frames: this.anims.generateFrameNumbers('player1', { start: 5, end: 8 }),
          frameRate: 8,
          repeat: -1
        });
        this.anims.create({ key: 'lie', frames: this.anims.generateFrameNumbers('player1', { start: 9, end: 9 }), frameRate: 8, repeat: -1 });

        if (this.levelConfig.showEagle) {
          this.anims.create({
            key: 'eagle',
            frames: this.anims.generateFrameNumbers('eagle', { start: 0, end: 8 }),
            frameRate: 9,
            repeat: -1
          });
        }
        if (this.levelConfig.showSnake) {
          this.anims.create({
            key: 'snake_move',
            frames: this.anims.generateFrameNumbers('snake', { start: 0, end: 4 }),
            frameRate: 6,
            repeat: -1
          });
        }
      }

      updateTimer() {
        this.timeLeft--;
        const H = this.scale.height;
        this.timerText.setText('Time: ' + this.timeLeft);
        if (this.timeLeft <= 0) {
          this.timer.remove(false);
          this.spawnEvent.remove(false);
          this.endLevel();
        }
      }

      spawnFruit() {
        const x = Phaser.Math.Between(50, this.scale.width - 50);
        const rand = Math.random();
        let type;
        if (rand < 0.5) type = 'red';
        else if (rand < 0.7) type = 'black';
        else if (rand < 0.95) type = 'gold';
        else if (!this.rainbowDropped) {
          type = 'colorful';
          this.rainbowDropped = true;
        } else type = 'red';
        const fruit = this.fruits.create(x, 0, type).setScale(0.085);
        fruit.type = type;
        fruit.setVelocityY(150);
      }

      collectFruit(player, fruit) {
        fruit.destroy();
        this.eatapple.play({ volume: this.game.sound.volume });
        switch (fruit.type) {
          case 'red':
            this.score += 2;
            break;
          case 'gold':
            this.score += 10;
            break;
          case 'colorful':
            this.score += 100;
            break;
          case 'black':
            this.score -= 10;
            break;
        }
        this.scoreText.setText(
          `Score: ${this.score} / ${this.levelConfig.passScore}`
        );
      }

      spawnEagle() {
        const W = this.scale.width;
        const y = 400 / 550 * this.scale.height; // 相對高度
        const fromLeft = Phaser.Math.Between(0, 1) === 0;
        const x = fromLeft ? -50 : W + 50;
        const speed = 200 * (fromLeft ? 1 : -1);
        const eagle = this.eagles.create(x, y, 'eagle').setOrigin(0.5).setScale(1.5).setDepth(50);
        eagle.body.allowGravity = false;
        eagle.setVelocityX(speed);
        eagle.setFlipX(!fromLeft);
        eagle.play('eagle');
      }

      spawnSnake() {
        const W = this.scale.width;
        this.snake = this.physics.add
          .sprite(50 / 800 * W, 0, 'snake')
          .setOrigin(0.5, 1)
          .setScale(0.5)
          .setCollideWorldBounds(true)
          .setBounce(1, 0);

        const floorTopY = this.ground.y - this.ground.displayHeight;
        this.snake.y = floorTopY;
        this.snake.body.setSize(300, 80);
        this.snake.body.setOffset(-this.snake.displayWidth / 2 + 100, -this.snake.displayHeight + 100);

        this.physics.add.collider(this.snake, this.ground);
        this.snake.play('snake_move');
        this.snake.setVelocityX(100);

        this.physics.add.overlap(this.player, this.snake, this.hitSnake, null, this);
      }

      hitSnake(player, snake) {
        if (this.isHit) return;
        this.isHit = true;
        player.setTint(0xff0000);
        this.time.delayedCall(1000, () => {
          this.score -= 15;
          this.scoreText.setText('Score: ' + this.score);
          player.clearTint();
          this.isHit = false;
        });
      }

      hitEagle(player, eagle) {
        if (this.cursors.down.isDown) return;
        eagle.destroy();
        this.score -= 20;
        this.scoreText.setText('Score: ' + this.score);
        player.setTint(0x4b0082);
        this.time.delayedCall(200, () => player.clearTint());
      }

      endLevel() {
        if (this.isGameOver) return;
        this.isGameOver = true;

        // 暫停物理、動畫
        this.physics.pause();
        if (this.rainEmitter) this.rainEmitter.stop();
        if (this.player?.anims) this.player.anims.stop();
        this.eagles?.getChildren().forEach(e => e.anims.stop());
        this.snake?.anims.stop();

        const W = this.scale.width;
        const H = this.scale.height;

        // 半透明遮罩
        this.add.rectangle(0, 0, W, H, 0x000000, 0.7)
          .setOrigin(0)
          .setDepth(100);

        // 判斷過關
        const passed = this.score >= this.levelConfig.passScore;
        const msg = passed ? '過 關 ！' : '失 敗 ！';
        const color = passed ? '#00ff00' : '#ff0000';

        // 主訊息
        this.add.text(W / 2, H * 0.3, msg, {
          fontFamily: 'a',
          fontSize: '64px',
          color,
          stroke: '#000',
          strokeThickness: 4
        })
          .setOrigin(0.5)
          .setDepth(101);

        // 最終分數
        this.add.text(W / 2, H * 0.4333, `最終分數：${this.score}`, {
          fontFamily: 'a',
          fontSize: '32px',
          color: '#ffffff',
          stroke: '#000',
          strokeThickness: 2
        })
          .setOrigin(0.5)
          .setDepth(101);

        // 按鈕群
        const btnY = H * 0.6667;
        const gapX = W * 0.25;

        // Restart
        const restart = this.add.image(W / 2 - gapX, btnY, 'btnRestart')
          .setInteractive({ useHandCursor: true })
          .setScale(0.1)
          .setDepth(101);

        restart
          .on('pointerover', () => {
            restart.setScale(0.15);
            this.btnSelectSound.play();
            restart.setAlpha(0.8);
          })
          .on('pointerout', () => {
            restart.setScale(0.1);
            restart.setAlpha(1);
          })
          .on('pointerdown', () => {
            this.clickSelectSound.play();
            this.scene.restart();
          });

        // Return
        const ret = this.add.image(W / 2, btnY, 'btnReturn')
          .setInteractive({ useHandCursor: true })
          .setScale(0.1)
          .setDepth(101);

        ret
          .on('pointerover', () => {
            this.btnSelectSound.play();
            ret.setScale(0.15);
            ret.setAlpha(0.8);
          })
          .on('pointerout', () => {
            ret.setScale(0.1);
            ret.setAlpha(1);
          })
          .on('pointerdown', () => {
            this.clickSelectSound.play();
            this.scene.start('MenuScene');
          });

        // Next
        if (passed && this.levelConfig.nextScene) {
          const next = this.add.image(W / 2 + gapX, btnY, 'btnNext')
            .setInteractive({ useHandCursor: true })
            .setScale(0.1)
            .setDepth(101);

          next
            .on('pointerover', () => {
              this.btnSelectSound.play();
              next.setScale(0.15);
              next.setAlpha(0.8);
            })
            .on('pointerout', () => {
              next.setScale(0.1);
              next.setAlpha(1);
            })
            .on('pointerdown', () => {
              this.clickSelectSound.play();
              this.scene.start(this.levelConfig.nextScene);
            });
        }
      }

      pauseGame() {
        if (this.isPaused) return;
        this.sound.pauseAll();

        this.isPaused = true;
        this.physics.world.pause();
        this.timer.paused = true;
        this.spawnEvent.paused = true;
        this.player.anims.pause();
        if (this.eagles) this.eagles.getChildren().forEach(e => e.anims.pause());
        if (this.snake) this.snake.anims.pause();
        if (this.rainEmitter) this.rainEmitter.pause();

        const W = this.scale.width;
        const H = this.scale.height;

        // 半透明遮罩
        this.pauseOverlay = this.add.rectangle(0, 0, W, H, 0x000000, 0.7)
          .setOrigin(0)
          .setDepth(200);

        // 暫停文字
        this.add.text(W / 2, H * 0.3, '遊戲暫停', {
          fontFamily: 'a',
          fontSize: '64px',
          color: '#ffff00',
          stroke: '#000',
          strokeThickness: 4
        })
          .setOrigin(0.5)
          .setDepth(201)
          .setName('pauseText');

        // 按鈕群
        const btnY = H * 0.5333;
        const gapX = W * 0.25;

        // 主畫面
        const btnHome = this.add.image(W / 2 - gapX, btnY, 'btnReturn')
          .setInteractive({ useHandCursor: true })
          .setScale(0.12)
          .setDepth(201)
          .setName('pauseBtnHome');

        btnHome
          .on('pointerover', () => {
            btnHome.setScale(0.15);
            btnHome.setAlpha(0.8);
            this.btnSelectSound.play();
          })
          .on('pointerout', () => {
            btnHome.setScale(0.12);
            btnHome.setAlpha(1);
          })
          .on('pointerdown', () => {
            this.clickSelectSound.play();
            this.resumeGame();
            this.scene.start('MenuScene');
          });

        // 重來
        const btnRestart = this.add.image(W / 2, btnY, 'btnRestart')
          .setInteractive({ useHandCursor: true })
          .setScale(0.12)
          .setDepth(201)
          .setName('pauseBtnRestart');
        btnRestart
          .on('pointerover', () => {
            btnRestart.setScale(0.15);
            btnRestart.setAlpha(0.8);
            this.btnSelectSound.play();
          })
          .on('pointerout', () => {
            btnRestart.setScale(0.12);
            btnRestart.setAlpha(1);
          })
          .on('pointerdown', () => {
            this.clickSelectSound.play();
            this.resumeGame();
            this.scene.restart();
          });

        // 繼續
        const btnContinue = this.add.image(W / 2 + gapX, btnY, 'btnNext')
          .setInteractive({ useHandCursor: true })
          .setScale(0.12)
          .setDepth(201)
          .setName('pauseBtnContinue');
        btnContinue
          .on('pointerover', () => {
            btnContinue.setScale(0.15);
            btnContinue.setAlpha(0.8);
            this.btnSelectSound.play();
          })
          .on('pointerout', () => {
            btnContinue.setScale(0.12);
            btnContinue.setAlpha(1);
          })
          .on('pointerdown', () => {
            this.clickSelectSound.play();
            this.resumeGame();
          });
      }

      resumeGame() {
        if (!this.isPaused) return;
        this.sound.resumeAll();
        this.isPaused = false;
        this.physics.world.resume();
        this.timer.paused = false;
        this.spawnEvent.paused = false;
        this.player.anims.resume();
        if (this.eagles) this.eagles.getChildren().forEach(e => e.anims.resume());
        if (this.snake) this.snake.anims.resume();
        if (this.rainEmitter) this.rainEmitter.resume();

        // 刪除暫停 UI
        this.children.getAll().forEach(child => {
          if (child.depth >= 200) child.destroy();
        });
      }
    }

    // -------------------------------------------------------
    // BaseLevelScene_mulit：多人雙人 共用邏輯
    // -------------------------------------------------------
    class BaseLevelScene_mulit extends Phaser.Scene {
      constructor(key, config) {
        super({ key });
        this.levelConfig = Object.assign({
          backgroundKey: '',
          timeLimit: 60,
          passScore: 0,
          nextScene: null,
          showSnake: false,
          showEagle: false
        }, config);
      }

      preload() {
        this.load.image('gr', 'asset/ground.png');
        this.load.image('black', 'asset/fruits/black.png');
        this.load.image('red', 'asset/fruits/red.png');
        this.load.image('gold', 'asset/fruits/gold.png');
        this.load.image('colorful', 'asset/fruits/colorful.png');
        this.load.spritesheet('player1', 'asset/player1.png', { frameWidth: 900, frameHeight: 472 });
        this.load.spritesheet('player2', 'asset/player2.png', { frameWidth: 900, frameHeight: 472 });
        this.load.image('btnRestart', 'asset/reset.png');
        this.load.image('btnReturn', 'asset/home.png');
        this.load.image('btnNext', 'asset/next.png');
        this.load.audio('btnselect1', 'asset/audio/select07.mp3');
        this.load.audio('clickselect1', 'asset/audio/click.mp3');
        this.load.audio('eatapple', 'asset/audio/eatapple.mp3');
        this.load.audio('eatapple_p2', 'asset/audio/eatapple_p2.mp3');
      }

      init(data) {
        this.mode = data.mode || 'single';
      }

      create() {
        const W = this.scale.width;
        const H = this.scale.height;

        this.eatapple = this.sound.add('eatapple', { volume: this.game.sound.volume });
        this.eatapple_p2 = this.sound.add('eatapple_p2', { volume: this.game.sound.volume });
        this.btnSelectSound = this.sound.add('btnselect1');
        this.clickSelectSound = this.sound.add('clickselect1');

        this.isGameOver = false;
        this.input.enabled = true;

        // 背景
        this.add.image(W / 2, H / 2, this.levelConfig.backgroundKey)
          .setDisplaySize(W, H);

        // 地面
        this.ground = this.physics.add.staticImage(W / 2, H - 1, 'gr')
          .setDisplaySize(W, 40)
          .setOrigin(0.5, 1)
          .refreshBody();

        // P1
        this.player = this.physics.add.sprite(W / 2, 0, 'player1')
          .setScale(0.45)
          .setOrigin(0.5, 1)
          .setCollideWorldBounds(true);
        this.player.y = this.ground.y - this.ground.displayHeight;
        this.physics.add.collider(this.player, this.ground);
        this.player.body.setSize(260, 0).setOffset(380, 0);

        // P2
        this.player2 = this.physics.add.sprite(W * 0.25, 0, 'player2')
          .setScale(0.45)
          .setOrigin(0.5, 1)
          .setCollideWorldBounds(true);
        this.player2.y = this.ground.y - this.ground.displayHeight;
        this.physics.add.collider(this.player2, this.ground);
        this.player2.body.setSize(260, 0).setOffset(380, 0);

        this.wasd = this.input.keyboard.addKeys({ up: Phaser.Input.Keyboard.KeyCodes.W, left: Phaser.Input.Keyboard.KeyCodes.A, down: Phaser.Input.Keyboard.KeyCodes.S, right: Phaser.Input.Keyboard.KeyCodes.D });
        this.cursors = this.input.keyboard.createCursorKeys();
        this.createAnimations();

        // 分數
        this.score = 0;
        this.score_p2 = 0;
        this.scoreText = this.add.text(16, 16, 'P1: 0', {
          fontFamily: 'a',
          fontSize: '36px',
          color: '#ff0000',
          strokeThickness: 2
        });
        this.scoreText_p2 = this.add.text(16, H * 0.0933, 'P2: 0', {
          fontFamily: 'a',
          fontSize: '36px',
          color: '#0000ff',
          strokeThickness: 2
        });
        this.timeLeft = this.levelConfig.timeLimit;
        this.timerText = this.add.text(W * 0.8125, 16, 'Time: ' + this.timeLeft, {
          fontFamily: 'a',
          fontSize: '36px',
          color: '#ffa500',
          strokeThickness: 2
        });
        this.timer = this.time.addEvent({ delay: 1000, callback: this.updateTimer, callbackScope: this, loop: true });

        // 掉落物
        this.fruits = this.physics.add.group();
        this.spawnEvent = this.time.addEvent({ delay: 800, callback: this.spawnFruit, callbackScope: this, loop: true });
        this.physics.add.overlap(this.player, this.fruits, this.collectFruit, null, this);
        this.physics.add.overlap(this.player2, this.fruits, this.collectFruitP2, null, this);

        // 老鷹、蛇
        if (this.levelConfig.showEagle) {
          this.eagles = this.physics.add.group();
          this.time.addEvent({ delay: 10000, callback: this.spawnEagle, callbackScope: this, loop: true });
          this.physics.add.overlap(this.player, this.eagles, this.hitEagle, null, this);
          this.physics.add.overlap(this.player2, this.eagles, this.hitEagle, null, this);
        }
        if (this.levelConfig.showSnake) {
          this.time.delayedCall(10000, this.spawnSnake, null, this);
        }

        this.isHitP1 = false;
        this.isHitP2 = false;
        this.isPaused = false;
        this.pauseOverlay = null;
        this.input.keyboard.on('keydown-ESC', () => {
          this.isPaused ? this.resumeGame() : this.pauseGame();
        });
      }

      update() {
        // 如果是暫停狀態，就直接不做任何處理
        if (this.isPaused) return;

        // ─── P1 控制區域 ───────────────────────────────────────────
        // 1) 跳躍：如果 P1 按上下鍵，並且腳底貼地，就讓他跳
        if (Phaser.Input.Keyboard.JustDown(this.cursors.up) && this.player.body.blocked.down) {
          this.player.setVelocityY(-350);
        }

        // 2) 水平移動：先把速度歸零，再依照左右鍵改速度、記錄方向
        this.player.setVelocityX(0);
        const speed1 = 300 * (this.player.isSlowed ? 0.6 : 1);

        if (this.cursors.left.isDown) {
          this.player.setVelocityX(-speed1);
          this.lastDirection = 'left';
        } else if (this.cursors.right.isDown) {
          this.player.setVelocityX(speed1);
          this.lastDirection = 'right';
        }

        // 3) 下蹲：如果 P1 按下鍵，就不做水平跑動，只做下蹲動畫
        let p1DoingCrouch = false;
        if (this.cursors.down.isDown) {
          p1DoingCrouch = true;
          this.player.setVelocityX(0);
          this.player.anims.play('lie', true);
          this.player.setFlipX(this.lastDirection === 'left');
        }

        // 4) 動畫：如果沒有在下蹲，就根據速度切換走路或待機動畫
        if (!p1DoingCrouch) {
          if (this.player.body.velocity.x < 0) {
            // P1 往左跑
            this.player.anims.play('walk_left', true);
            this.player.setFlipX(false);
          }
          else if (this.player.body.velocity.x > 0) {
            // P1 往右跑
            this.player.anims.play('walk_right', true);
            this.player.setFlipX(false);
          }
          else {
            // P1 待機
            this.player.anims.play('ready', true);
            this.player.setFlipX(this.lastDirection === 'left');
          }
        }
        // ────────────────────────────────────────────────────────────


        // ─── P2 控制區域 ───────────────────────────────────────────
        // 1) 跳躍：P2 用 W 鍵跳，如果腳底貼地就跳
        if (Phaser.Input.Keyboard.JustDown(this.wasd.up) && this.player2.body.blocked.down) {
          this.player2.setVelocityY(-350);
        }

        // 2) 水平移動：先把速度歸零，再依照 A / D 鍵改速度、記錄方向
        this.player2.setVelocityX(0);
        const speed2 = 300 * (this.player2.isSlowed ? 0.6 : 1);

        if (this.wasd.left.isDown) {
          this.player2.setVelocityX(-speed2);
          this.lastDir2 = 'left';
        } else if (this.wasd.right.isDown) {
          this.player2.setVelocityX(speed2);
          this.lastDir2 = 'right';
        }

        // 3) 下蹲：P2 用 S 鍵下蹲
        let p2DoingCrouch = false;
        if (this.wasd.down.isDown) {
          p2DoingCrouch = true;
          this.player2.setVelocityX(0);
          this.player2.anims.play('lie2', true);
          this.player2.setFlipX(this.lastDir2 === 'left');
        }

        // 4) 動畫：如果沒有下蹲，就根據速度切換 P2 的走路或待機
        if (!p2DoingCrouch) {
          if (this.player2.body.velocity.x < 0) {
            this.player2.anims.play('walk_left2', true);
            this.player2.setFlipX(false);
          }
          else if (this.player2.body.velocity.x > 0) {
            this.player2.anims.play('walk_right2', true);
            this.player2.setFlipX(false);
          }
          else {
            this.player2.anims.play('ready2', true);
            this.player2.setFlipX(this.lastDir2 === 'left2');
          }
        }

        // 蛇邊界反彈
        if (this.snake && this.snake.body && this.snake.body.velocity) {
          if (this.snake.body.velocity.x > 0) {
            this.snake.setFlipX(true);
          } else if (this.snake.body.velocity.x < 0) {
            this.snake.setFlipX(false);
          }
        }

        // 清理老鷹
        if (this.eagles) {
          this.eagles.getChildren().forEach(eagle => {
            if (eagle.x < -50 || eagle.x > this.scale.width + 50) {
              eagle.destroy();
            }
          });
        }
      }

      createAnimations() {
        // P1 動畫
        this.anims.create({
          key: 'walk_left',
          frames: this.anims.generateFrameNumbers('player1', { start: 0, end: 3 }),
          frameRate: 8,
          repeat: -1
        });
        this.anims.create({ key: 'ready', frames: [{ key: 'player1', frame: 4 }], frameRate: 1, repeat: -1 });
        this.anims.create({
          key: 'walk_right',
          frames: this.anims.generateFrameNumbers('player1', { start: 5, end: 8 }),
          frameRate: 8,
          repeat: -1
        });
        this.anims.create({ key: 'lie', frames: this.anims.generateFrameNumbers('player1', { start: 9, end: 9 }), frameRate: 8, repeat: -1 });

        // P2 動畫
        this.anims.create({
          key: 'walk_left2',
          frames: this.anims.generateFrameNumbers('player2', { start: 0, end: 3 }),
          frameRate: 8,
          repeat: -1
        });
        this.anims.create({ key: 'ready2', frames: [{ key: 'player2', frame: 4 }], frameRate: 1, repeat: -1 });
        this.anims.create({
          key: 'walk_right2',
          frames: this.anims.generateFrameNumbers('player2', { start: 5, end: 8 }),
          frameRate: 8,
          repeat: -1
        });
        this.anims.create({ key: 'lie2', frames: this.anims.generateFrameNumbers('player2', { start: 9, end: 9 }), frameRate: 8, repeat: -1 });

        if (this.levelConfig.showEagle) {
          this.anims.create({
            key: 'eagle',
            frames: this.anims.generateFrameNumbers('eagle', { start: 0, end: 8 }),
            frameRate: 9,
            repeat: -1
          });
        }
        if (this.levelConfig.showSnake) {
          this.anims.create({
            key: 'snake_move',
            frames: this.anims.generateFrameNumbers('snake', { start: 0, end: 4 }),
            frameRate: 6,
            repeat: -1
          });
        }
      }

      updateTimer() {
        this.timeLeft--;
        this.timerText.setText('Time: ' + this.timeLeft);
        if (this.timeLeft <= 0) {
          this.timer.remove(false);
          this.spawnEvent.remove(false);
          this.endLevel();
        }
      }

      spawnFruit() {
        const x = Phaser.Math.Between(50, this.scale.width - 50);
        const rand = Math.random();
        let type;
        if (rand < 0.5) type = 'red';
        else if (rand < 0.7) type = 'black';
        else if (rand < 0.95) type = 'gold';
        else if (!this.rainbowDropped) {
          type = 'colorful';
          this.rainbowDropped = true;
        } else type = 'red';
        const fruit = this.fruits.create(x, 0, type).setScale(0.085);
        fruit.type = type;
        fruit.setVelocityY(150);
      }

      collectFruit(player, fruit) {
        fruit.destroy();
        this.eatapple.play({ volume: this.game.sound.volume });
        switch (fruit.type) {
          case 'red':
            this.score += 2;
            break;
          case 'gold':
            this.score += 10;
            break;
          case 'colorful':
            this.score += 100;
            break;
          case 'black':
            this.score -= 10;
            break;
        }
        this.scoreText.setText('P1: ' + this.score);
      }

      collectFruitP2(player2, fruit) {
        fruit.destroy();
        this.eatapple_p2.play({ volume: this.game.sound.volume });
        switch (fruit.type) {
          case 'red':
            this.score_p2 += 2;
            break;
          case 'gold':
            this.score_p2 += 10;
            break;
          case 'colorful':
            this.score_p2 += 100;
            break;
          case 'black':
            this.score_p2 -= 10;
            break;
        }
        this.scoreText_p2.setText('P2: ' + this.score_p2);
      }

      spawnEagle() {
        const W = this.scale.width;
        const y = 400 / 550 * this.scale.height;
        const fromLeft = Phaser.Math.Between(0, 1) === 0;
        const x = fromLeft ? -50 : W + 50;
        const speed = 200 * (fromLeft ? 1 : -1);
        const eagle = this.eagles.create(x, y, 'eagle').setOrigin(0.5).setScale(1.5).setDepth(50);
        eagle.body.allowGravity = false;
        eagle.setVelocityX(speed);
        eagle.setFlipX(!fromLeft);
        eagle.play('eagle');
      }

      spawnSnake() {
        const W = this.scale.width;
        this.snake = this.physics.add
          .sprite(50 / 800 * W, 0, 'snake')
          .setOrigin(0.5, 1)
          .setScale(0.45)
          .setCollideWorldBounds(true)
          .setBounce(1, 0);

        const floorTopY = this.ground.y - this.ground.displayHeight;
        this.snake.y = floorTopY;
        this.snake.body.setSize(300, 80);
        this.snake.body.setOffset(
          -this.snake.displayWidth / 2 + 100,
          -this.snake.displayHeight + 100
        );

        this.physics.add.collider(this.snake, this.ground);
        this.snake.play('snake_move');
        this.snake.setVelocityX(100);

        this.physics.add.overlap(this.player, this.snake, this.hitSnake, null, this);
        this.physics.add.overlap(this.player2, this.snake, this.hitSnake, null, this);
      }

      hitSnake(player, snake) {
        const isP1 = (player === this.player);
        const flag = isP1 ? 'isHitP1' : 'isHitP2';
        const downKey = isP1 ? this.cursors.down : this.wasd.down;

        if (this[flag] || downKey.isDown) return;
        this[flag] = true;

        if (isP1) {
          this.score -= 15;
          this.scoreText.setText('P1: ' + this.score);
        } else {
          this.score_p2 -= 15;
          this.scoreText_p2.setText('P2: ' + this.score_p2);
        }

        player.setTint(0xff0000);
        this.time.delayedCall(500, () => player.clearTint());
        this.time.delayedCall(1000, () => {
          this[flag] = false;
        });
      }

      hitEagle(player, eagle) {
        const isP1 = (player === this.player);
        const isCrouching = isP1
          ? this.cursors.down.isDown
          : this.wasd.down.isDown;
        if (isCrouching) return;

        eagle.destroy();

        if (isP1) {
          this.score -= 20;
          this.scoreText.setText('P1: ' + this.score);
        } else {
          this.score_p2 -= 20;
          this.scoreText_p2.setText('P2: ' + this.score_p2);
        }

        player.setTint(0x4b0082);
        this.time.delayedCall(200, () => player.clearTint());
      }

      endLevel() {
        if (this.isGameOver) return;
        this.isGameOver = true;

        this.physics.pause();
        this.player?.anims.stop();
        this.player2?.anims.stop();
        this.eagles?.getChildren().forEach(e => e.anims.stop());
        this.snake?.anims.stop();

        const W = this.scale.width;
        const H = this.scale.height;

        // 半透明遮罩
        this.add.rectangle(0, 0, W, H, 0x000000, 0.7)
          .setOrigin(0)
          .setDepth(100);

        // 判斷勝負
        let msg, color;
        if (this.score > this.score_p2) {
          msg = '紅方勝利！';
          color = '#ff0000';
        } else if (this.score < this.score_p2) {
          msg = '藍方勝利！';
          color = '#0000ff';
        } else {
          msg = '平 手 ！';
          color = '#ffff00';
        }

        // 主訊息
        this.add.text(W / 2, H * 0.3, msg, {
          fontFamily: 'a',
          fontSize: '64px',
          color,
          stroke: '#000',
          strokeThickness: 4
        }).setOrigin(0.5).setDepth(101);

        // 雙方最終分數
        const scoreText = `紅方：${this.score}  |  藍方：${this.score_p2}`;
        this.add.text(W / 2, H * 0.4333, scoreText, {
          fontFamily: 'a',
          fontSize: '32px',
          color: '#ffffff',
          stroke: '#000',
          strokeThickness: 2
        }).setOrigin(0.5).setDepth(101);

        const btnY = H * 0.6667;
        const gapX = W * 0.25;

        // Restart
        const restart = this.add.image(W / 2 - gapX, btnY, 'btnRestart')
          .setInteractive({ useHandCursor: true })
          .setScale(0.1)
          .setDepth(101);
        restart
          .on('pointerover', () => {
            restart.setScale(0.15);
            this.btnSelectSound.play();
            restart.setAlpha(0.8);
          })
          .on('pointerout', () => {
            restart.setScale(0.1);
            restart.setAlpha(1);
          })
          .on('pointerdown', () => {
            this.clickSelectSound.play();
            this.scene.restart();
          });

        // Return
        const ret = this.add.image(W / 2, btnY, 'btnReturn')
          .setInteractive({ useHandCursor: true })
          .setScale(0.1)
          .setDepth(101);
        ret
          .on('pointerover', () => {
            this.btnSelectSound.play();
            ret.setScale(0.15);
            ret.setAlpha(0.8);
          })
          .on('pointerout', () => {
            ret.setScale(0.1);
            ret.setAlpha(1);
          })
          .on('pointerdown', () => {
            this.clickSelectSound.play();
            this.scene.start('MenuScene');
          });

        // Next
        if (this.levelConfig.nextScene) {
          const next = this.add.image(W / 2 + gapX, btnY, 'btnNext')
            .setInteractive({ useHandCursor: true })
            .setScale(0.1)
            .setDepth(101);
          next
            .on('pointerover', () => {
              this.btnSelectSound.play();
              next.setScale(0.15);
              next.setAlpha(0.8);
            })
            .on('pointerout', () => {
              next.setScale(0.1);
              next.setAlpha(1);
            })
            .on('pointerdown', () => {
              this.clickSelectSound.play();
              this.scene.start(this.levelConfig.nextScene);
            });
        }
      }

      pauseGame() {
        if (this.isPaused) return;
        this.sound.pauseAll();

        this.isPaused = true;
        this.physics.world.pause();
        this.timer.paused = true;
        this.spawnEvent.paused = true;
        this.player.anims.pause();
        this.player2.anims.pause();
        if (this.eagles) this.eagles.getChildren().forEach(e => e.anims.pause());
        if (this.snake) this.snake.anims.pause();
        if (this.rainEmitter) this.rainEmitter.pause();

        const W = this.scale.width;
        const H = this.scale.height;

        // 半透明遮罩
        this.pauseOverlay = this.add.rectangle(0, 0, W, H, 0x000000, 0.7)
          .setOrigin(0)
          .setDepth(200);

        // 暫停文字
        this.add.text(W / 2, H * 0.3, '遊戲暫停', {
          fontFamily: 'a',
          fontSize: '64px',
          color: '#ffff00',
          stroke: '#000',
          strokeThickness: 4
        }).setOrigin(0.5).setDepth(201);

        const btnY = H * 0.5333;
        const gapX = W * 0.25;

        // 主畫面
        const btnHome = this.add.image(W / 2 - gapX, btnY, 'btnReturn')
          .setInteractive({ useHandCursor: true })
          .setScale(0.12)
          .setDepth(201);
        btnHome
          .on('pointerover', () => {
            btnHome.setScale(0.15);
            btnHome.setAlpha(0.8);
            this.btnSelectSound.play();
          })
          .on('pointerout', () => {
            btnHome.setScale(0.12);
            btnHome.setAlpha(1);
          })
          .on('pointerdown', () => {
            this.clickSelectSound.play();
            this.resumeGame();
            this.scene.start('MenuScene');
          });

        // 重來
        const btnRestart = this.add.image(W / 2, btnY, 'btnRestart')
          .setInteractive({ useHandCursor: true })
          .setScale(0.12)
          .setDepth(201);
        btnRestart
          .on('pointerover', () => {
            btnRestart.setScale(0.15);
            btnRestart.setAlpha(0.8);
            this.btnSelectSound.play();
          })
          .on('pointerout', () => {
            btnRestart.setScale(0.12);
            btnRestart.setAlpha(1);
          })
          .on('pointerdown', () => {
            this.clickSelectSound.play();
            this.resumeGame();
            this.scene.restart();
          });

        // 繼續
        const btnContinue = this.add.image(W / 2 + gapX, btnY, 'btnNext')
          .setInteractive({ useHandCursor: true })
          .setScale(0.12)
          .setDepth(201);
        btnContinue
          .on('pointerover', () => {
            btnContinue.setScale(0.15);
            btnContinue.setAlpha(0.8);
            this.btnSelectSound.play();
          })
          .on('pointerout', () => {
            btnContinue.setScale(0.12);
            btnContinue.setAlpha(1);
          })
          .on('pointerdown', () => {
            this.clickSelectSound.play();
            this.resumeGame();
          });
      }

      resumeGame() {
        if (!this.isPaused) return;
        this.sound.resumeAll();
        this.isPaused = false;
        this.physics.world.resume();
        this.timer.paused = false;
        this.spawnEvent.paused = false;
        this.player.anims.resume();
        this.player2.anims.resume();
        if (this.eagles) this.eagles.getChildren().forEach(e => e.anims.resume());
        if (this.snake) this.snake.anims.resume();
        if (this.rainEmitter) this.rainEmitter.resume();

        this.children.getAll().forEach(child => {
          if (child.depth >= 200) child.destroy();
        });
      }
    }

    // -------------------------------------------------------
    // SettingScene：即時音量控制
    // -------------------------------------------------------
    class SettingScene extends Phaser.Scene {
      constructor() {
        super({ key: 'SettingScene' });
      }

      preload() {
        this.load.image('setting_bg', 'asset/menu/bg.jpg');
        this.load.image('slider_bar', 'asset/slider_bar.png');
        this.load.image('slider_knob', 'asset/slider_knob.png');
        this.load.audio('btnselect', 'asset/audio/select07.mp3');
        this.load.audio('clickselect', 'asset/audio/click.mp3');
      }

      create() {
        const W = this.scale.width;
        const H = this.scale.height;

        // 1. 背景與標題（依旧用字體 'a'，確保 @font-face 已加好）
        this.add.image(W / 2, H / 2, 'setting_bg')
          .setDisplaySize(W, H)
          .setAlpha(0.4);

        this.add.text(W / 2, H * 0.15, '設定', {
          fontFamily: 'a',
          fontSize: '48px',
          color: '#ffff00'
        }).setOrigin(0.5);

        // 2. '音量' 標籤，放在滑杆左邊
        this.add.text(W * 0.25, H * 0.3333, '音量', {
          fontFamily: 'a',
          fontSize: '28px',
          color: '#ffffff'
        }).setOrigin(1, 0.5);

        // 3. 播放示例音效（會用在拖曳時）
        const sampleSound = this.sound.add('btnselect', { volume: game.sound.volume });

        // 4. 計算滑杆寬度/位置
        //    让滑杆横向从画面 25% 延伸到 75%（占一半宽度）
        const barX = W * 0.25;         // 滑杆最左端
        const barY = H * 0.3333;       // 滑杆垂直位置
        const barWidth = W * 0.5;      // 占画面 50% 宽度
        // 原始 slider_bar 图片高度，用来保持高度不变
        const barTexture = this.textures.get('slider_bar').getSourceImage();
        const barHeight = barTexture.height;

        // 5. 把 slider_bar 画出来（设 origin 为 (0,0.5)）
        this.add.image(barX, barY, 'slider_bar')
          .setOrigin(0, 0.5)
          .setDisplaySize(barWidth, barHeight);

        // 6. knob 初始 X：barX + barWidth * 当前音量
        const initialKnobX = barX + barWidth * game.sound.volume;
        const knob = this.add.image(initialKnobX, barY, 'slider_knob')
          .setOrigin(0.5)      // 中心点
          .setInteractive({ draggable: true });

        this.input.setDraggable(knob);

        // 7. 百分比文字，也放到滑杆右侧
        const volText = this.add.text(barX + barWidth + 20, barY, Math.round(game.sound.volume * 100) + '%', {
          fontFamily: 'a',
          fontSize: '24px',
          color: '#ffff00'
        }).setOrigin(0, 0.5);

        // 定义 knob 最左/右的拖曳范围
        const minX = barX;
        const maxX = barX + barWidth;

        knob.on('dragstart', () => {
          sampleSound.play({ loop: true, volume: game.sound.volume });
        });

        knob.on('drag', (_pointer, dragX) => {
          // 限制范围
          dragX = Phaser.Math.Clamp(dragX, minX, maxX);
          knob.x = dragX;

          // 重新计算音量
          const newVol = (dragX - barX) / barWidth;
          game.sound.volume = newVol;
          volText.setText(Math.round(newVol * 100) + '%');
          sampleSound.setVolume(newVol);
        });

        knob.on('dragend', () => {
          sampleSound.stop();
          this.sound.play('clickselect', { volume: game.sound.volume });
        });

        // 8. 返回主選單按鈕
        const backBtn = this.add.text(W / 2, H * 0.75, '返回主選單', {
          fontFamily: 'a',
          fontSize: '32px',
          color: '#ff0000',
          backgroundColor: '#ffffff',
          padding: { x: 20, y: 8 }
        }).setOrigin(0.5)
          .setInteractive({ useHandCursor: true });

        backBtn.on('pointerover', () => {
          backBtn.setStyle({ backgroundColor: '#ffc' });
          this.sound.play('btnselect', { volume: game.sound.volume });
        });
        backBtn.on('pointerout', () => {
          backBtn.setStyle({ backgroundColor: '#ffffff' });
        });
        backBtn.on('pointerdown', () => {
          this.sound.play('clickselect', { volume: game.sound.volume });
          this.scene.start('MenuScene');
        });
      }
    }

    // -------------------------------------------------------
    // Level1Scene：單機第一關
    // -------------------------------------------------------
    class Level1Scene extends BaseLevelScene {
      constructor() {
        super('single_1Scene', {
          backgroundKey: 'level1',
          timeLimit: 6,
          passScore: 0,
          nextScene: 'single_2Scene',
          showSnake: false,
          showEagle: false
        });
      }

      preload() {
        // 載入背景音樂

        super.preload();
        this.load.audio('bgm_level1', 'asset/audio/level1.mp3');
        this.load.image('level1', 'asset/menu/sence/level1.jpg');
      }
      create() {
        // 進關卡真的開始時，先停掉大廳音樂
        this.sound.stopByKey('bgm');

        // 播放關卡自己的 BGM
        this.bgm = this.sound.add('bgm_level1', { loop: true, volume: 0.5 });
        this.bgm.play();

        super.create();
      }

      endLevel() {
        super.endLevel();
        if (this.bgm?.isPlaying) this.bgm.stop();
      }

      update() {
        super.update();
      }
    }

    // -------------------------------------------------------
    // Level2Scene：單機第二關
    // -------------------------------------------------------
    class Level2Scene extends BaseLevelScene {
      constructor() {
        super('single_2Scene', {
          backgroundKey: 'level2',
          timeLimit: 5,
          passScore: 0,
          nextScene: 'single_3Scene',
          showSnake: true,
          showEagle: true
        });
      }

      preload() {
        super.preload();
        this.load.audio('bgm_level2', 'asset/audio/level2.mp3');
        this.load.image('level2', 'asset/menu/sence/level2.jpg');
        this.load.spritesheet('snake', 'asset/snake.png', { frameWidth: 330, frameHeight: 136 });
        this.load.spritesheet('eagle', 'asset/engle.png', { frameWidth: 68, frameHeight: 115 });
        // ─── 覆寫預設 key ───
        // 把原本用來產生水果的貼圖從 TextureManager 刪除
        this.textures.remove('red');
        this.textures.remove('black');
        this.textures.remove('gold');
        this.textures.remove('colorful');

        // 再用相同的 key 重新 load，你自己的 soda 圖就會取代掉原本的
        this.load.image('red', 'asset/soda/soda1.png');
        this.load.image('black', 'asset/soda/soda3.png');
        this.load.image('gold', 'asset/soda/soda2.png');
        this.load.image('colorful', 'asset/soda/soda4.png');
      }

      create() {
        this.sound.stopByKey('bgm');

        // 播放關卡自己的 BGM
        this.bgm = this.sound.add('bgm_level2', { loop: true, volume: 0.5 });
        this.bgm.play();

        super.create();
        this.lastDirection = 'right';
      }
      endLevel() {
        super.endLevel();
        if (this.bgm?.isPlaying) this.bgm.stop();
      }

      update() {
        super.update();
      }

    }

    // -------------------------------------------------------
    // Level3Scene：單機第三關，有雨和積水
    // -------------------------------------------------------
    class Level3Scene extends BaseLevelScene {
      constructor() {
        super('single_3Scene', {
          backgroundKey: 'level3',
          timeLimit: 60,
          passScore: 200,
          nextScene: 'EndStoryScene',
          showSnake: true,
          showEagle: true
        });
      }

      preload() {
        // 先呼叫父類別，把所有共用資源 queue 進來
        super.preload();
        this.load.audio('bgm_level3', 'asset/audio/level3.mp3');
        this.load.audio('rain', 'asset/audio/rain.mp3');
        // ── 把原本的水果 key 清掉 ──
        this.textures.remove('red');
        this.textures.remove('black');
        this.textures.remove('gold');
        this.textures.remove('colorful');

        // ── 再載入你的新貼圖，用相同的 key 覆蓋它 ──
        this.load.image('red', 'asset/ham/ham1.png');
        this.load.image('black', 'asset/ham/ham2.png');
        this.load.image('gold', 'asset/ham/ham3.png');
        this.load.image('colorful', 'asset/ham/ham4.png');

        // 然後載入第三關特有的背景、蛇、老鷹、水滴、積水……
        this.load.image('level3', 'asset/menu/sence/level3.jpg');
        this.load.spritesheet('snake', 'asset/snake.png', { frameWidth: 330, frameHeight: 136 });
        this.load.spritesheet('eagle', 'asset/engle.png', { frameWidth: 68, frameHeight: 115 });
        this.load.image('raindrop', 'asset/raindrop.png');
        this.load.image('puddle', 'asset/puddle.png');
      }


      create() {
        this.sound.stopByKey('bgm');

        // 播放關卡自己的 BGM
        this.bgm = this.sound.add('bgm_level3', { loop: true, volume: 0.5 });
        this.bgm.play();
        // 播放關卡自己的 BGM
        this.bgm = this.sound.add('rain', { loop: true, volume: 0.5 });
        this.bgm.play();
        super.create();

        const W = this.scale.width;
        const H = this.scale.height;
        const rainParticles = this.add.particles('raindrop');
        this.rainEmitter = rainParticles.createEmitter({
          x: { min: 0, max: W },
          y: 0,
          lifespan: 2000,
          speedY: { min: 400, max: 600 },
          scale: { start: 0.02, end: 0.02 },
          quantity: 2,
          frequency: 50,
          blendMode: 'NORMAL'
        });
        rainParticles.setDepth(5);

        const groundTopY = this.ground.y - this.ground.displayHeight;
        this.rainEmitter.setDeathZone({
          type: 'onEnter',
          source: new Phaser.Geom.Rectangle(0, groundTopY, W, H - groundTopY)
        });

        this.puddles = this.physics.add.staticGroup();
        this.shouldSpawn = true;
        this.time.addEvent({
          delay: 5000,
          callback: this.togglePuddles,
          callbackScope: this,
          loop: true
        });

        this.lastDirection = 'right';
      }

      togglePuddles() {
        const W = this.scale.width;
        const groundTopY = this.ground.y - this.ground.displayHeight;
        if (this.shouldSpawn) {
          for (let i = 0; i < 2; i++) {
            const x = Phaser.Math.Between(50, W - 50);
            this.puddles.create(x, groundTopY, 'puddle')
              .setOrigin(0.5, 0.5)
              .setScale(0.08)
              .refreshBody();
          }
        } else {
          const children = this.puddles.getChildren();
          for (let i = 0; i < 2 && children.length > 0; i++) {
            children[0].destroy();
          }
        }
        this.shouldSpawn = !this.shouldSpawn;
      }
      endLevel() {
        super.endLevel();
        if (this.bgm?.isPlaying) this.bgm.stop();
      }

      update() {
        super.update();

        let isOnPuddle = false;
        if (this.puddles) {
          this.puddles.getChildren().forEach(puddle => {
            if (Phaser.Geom.Intersects.RectangleToRectangle(this.player.getBounds(), puddle.getBounds())) {
              isOnPuddle = true;
            }
          });
        }
        this.player.isSlowed = isOnPuddle;
      }
    }

    // -------------------------------------------------------
    // Level1Scene_mulit：多人第一關
    // -------------------------------------------------------
    class Level1Scene_mulit extends BaseLevelScene_mulit {
      constructor() {
        super('Level1Scene_mulit', {
          backgroundKey: 'level1',
          timeLimit: 60,
          passScore: 1,
          nextScene: 'Level2Scene_mulit',
          showSnake: false,
          showEagle: false
        });
      }

      preload() {
        super.preload();
        this.load.audio('bgm_level1', 'asset/audio/level1.mp3');
        this.load.image('level1', 'asset/menu/sence/level1.jpg');
      }
      create() {
        // 進關卡真的開始時，先停掉大廳音樂
        this.sound.stopByKey('bgm');

        // 播放關卡自己的 BGM
        this.bgm = this.sound.add('bgm_level1', { loop: true, volume: 0.5 });
        this.bgm.play();

        super.create();
      }

      endLevel() {
        super.endLevel();
        if (this.bgm?.isPlaying) this.bgm.stop();
      }

      update() {
        super.update();
      }
    }

    // -------------------------------------------------------
    // Level2Scene_mulit：多人第二關
    // -------------------------------------------------------
    class Level2Scene_mulit extends BaseLevelScene_mulit {
      constructor() {
        super('Level2Scene_mulit', {
          backgroundKey: 'level2',
          timeLimit: 60,
          passScore: 1,
          nextScene: 'Level3Scene_mulit',
          showSnake: true,
          showEagle: true
        });
      }

      preload() {

        // ─── 覆寫預設 key ───
        // 把原本用來產生水果的貼圖從 TextureManager 刪除
        this.textures.remove('red');
        this.textures.remove('black');
        this.textures.remove('gold');
        this.textures.remove('colorful');

        // 再用相同的 key 重新 load，你自己的 soda 圖就會取代掉原本的
        this.load.image('red', 'asset/soda/soda1.png');
        this.load.image('black', 'asset/soda/soda3.png');
        this.load.image('gold', 'asset/soda/soda2.png');
        this.load.image('colorful', 'asset/soda/soda4.png');
        super.preload();
        this.load.audio('bgm_level2', 'asset/audio/level2.mp3');
        this.load.image('level2', 'asset/menu/sence/level2.jpg');
        this.load.spritesheet('snake', 'asset/snake.png', { frameWidth: 330, frameHeight: 136 });
        this.load.spritesheet('eagle', 'asset/engle.png', { frameWidth: 68, frameHeight: 115 });


      }

      create() {
        this.sound.stopByKey('bgm');

        // 播放關卡自己的 BGM
        this.bgm = this.sound.add('bgm_level2', { loop: true, volume: 0.5 });
        this.bgm.play();
        super.create();
        this.lastDirection = 'right';
      }
      endLevel() {
        super.endLevel();
        if (this.bgm?.isPlaying) this.bgm.stop();
      }

      update() {
        super.update();
      }
    }

    // -------------------------------------------------------
    // Level3Scene_mulit：多人第三關，有雨和積水
    // -------------------------------------------------------
    class Level3Scene_mulit extends BaseLevelScene_mulit {
      constructor() {
        super('Level3Scene_mulit', {
          backgroundKey: 'level3',
          timeLimit: 60,
          passScore: 0,
          nextScene: false,
          showSnake: true,
          showEagle: true
        });
      }

      preload() {
        // ── 把原本的水果 key 清掉 ──
        this.textures.remove('red');
        this.textures.remove('black');
        this.textures.remove('gold');
        this.textures.remove('colorful');

        // ── 再載入你的新貼圖，用相同的 key 覆蓋它 ──
        this.load.image('red', 'asset/ham/ham1.png');
        this.load.image('black', 'asset/ham/ham2.png');
        this.load.image('gold', 'asset/ham/ham3.png');
        this.load.image('colorful', 'asset/ham/ham4.png');

        super.preload();
         this.load.audio('bgm_level3', 'asset/audio/level3.mp3');
        this.load.audio('rain', 'asset/audio/rain.mp3');
        this.load.image('level3', 'asset/menu/sence/level3.jpg');
        this.load.spritesheet('snake', 'asset/snake.png', { frameWidth: 330, frameHeight: 136 });
        this.load.spritesheet('eagle', 'asset/engle.png', { frameWidth: 68, frameHeight: 115 });
        this.load.image('raindrop', 'asset/raindrop.png');
        this.load.image('puddle', 'asset/puddle.png');


      }

      create() {
         this.sound.stopByKey('bgm');

        // 播放關卡自己的 BGM
        this.bgm = this.sound.add('bgm_level3', { loop: true, volume: 0.5 });
        this.bgm.play();
        // 播放關卡自己的 BGM
        this.bgm = this.sound.add('rain', { loop: true, volume: 0.5 });
        this.bgm.play();
        super.create();

        const W = this.scale.width;
        const H = this.scale.height;
        const rainParticles = this.add.particles('raindrop');
        this.rainEmitter = rainParticles.createEmitter({
          x: { min: 0, max: W },
          y: 0,
          lifespan: 2000,
          speedY: { min: 400, max: 600 },
          scale: { start: 0.02, end: 0.02 },
          quantity: 2,
          frequency: 50,
          blendMode: 'NORMAL'
        });
        rainParticles.setDepth(5);

        const groundTopY = this.ground.y - this.ground.displayHeight;
        this.rainEmitter.setDeathZone({
          type: 'onEnter',
          source: new Phaser.Geom.Rectangle(0, groundTopY, W, H - groundTopY)
        });

        this.puddles = this.physics.add.staticGroup();
        this.shouldSpawn = true;
        this.time.addEvent({
          delay: 5000,
          callback: this.togglePuddles,
          callbackScope: this,
          loop: true
        });

        this.lastDirection = 'right';
      }

      togglePuddles() {
        const W = this.scale.width;
        const groundTopY = this.ground.y - this.ground.displayHeight;
        if (this.shouldSpawn) {
          for (let i = 0; i < 2; i++) {
            const x = Phaser.Math.Between(50, W - 50);
            this.puddles.create(x, groundTopY, 'puddle')
              .setOrigin(0.5, 0.5)
              .setScale(0.08)
              .refreshBody();
          }
        } else {
          const children = this.puddles.getChildren();
          for (let i = 0; i < 2 && children.length > 0; i++) {
            children[0].destroy();
          }
        }
        this.shouldSpawn = !this.shouldSpawn;
      }
       endLevel() {
        super.endLevel();
        if (this.bgm?.isPlaying) this.bgm.stop();
      }

      update() {
        super.update();

        let isOnPuddle1 = false, isOnPuddle2 = false;
        if (this.puddles) {
          this.puddles.getChildren().forEach(puddle => {
            if (Phaser.Geom.Intersects.RectangleToRectangle(this.player.getBounds(), puddle.getBounds())) {
              isOnPuddle1 = true;
            }
            if (Phaser.Geom.Intersects.RectangleToRectangle(this.player2.getBounds(), puddle.getBounds())) {
              isOnPuddle2 = true;
            }
          });
        }
        this.player.isSlowed = isOnPuddle1;
        this.player2.isSlowed = isOnPuddle2;
      }
    }

    // -------------------------------------------------------
    // EndStoryScene：結尾故事顯示
    // -------------------------------------------------------
    const endstoryText = [
      "最終，",
      "你戰勝巨鷹、巨蟒與惡劣天候，",
      "摘下彩虹蘋果；蘋果迸發光芒，",
      "重啟大地生機。",
      "你帶着奇蹟歸來，",
      "，成為世人景仰的永恆傳奇。"
    ];

    class EndStoryScene extends Phaser.Scene {
      constructor() {
        super({ key: 'EndStoryScene' });
      }

      preload() {
        this.load.image('level3', 'asset/menu/sence/level3.jpg');
      }

      create() {
        const W = this.scale.width;
        const H = this.scale.height;

        this.add.image(W / 2, H / 2, 'level3')
          .setDisplaySize(W, H)
          .setAlpha(0.7);

        const rectW = W - 100;
        const rectH = H * 0.7;
        const rectX = W / 2;
        const rectY = H / 2;
        const pad = 5;

        this.add.rectangle(rectX, rectY, rectW, rectH, 0x000000, 0.6).setOrigin(0.5);

        const maskG = this.make.graphics();
        maskG.fillRect(rectX - rectW / 2, rectY - rectH / 2, rectW, rectH);
        const mask = maskG.createGeometryMask();

        this.fullText = endstoryText.join(' ');
        this.text = this.add.text(
          rectX - rectW / 2 + pad,
          rectY - rectH / 2 + pad,
          '',
          {
            fontFamily: 'a',
            fontSize: '24px',
            color: '#ffffff',
            align: 'left',
            wordWrap: { width: rectW - pad * 2, useAdvancedWrap: true },
            lineSpacing: 30
          }
        ).setOrigin(0).setMask(mask);

        this.charIndex = 0;
        this.typeNextChar();
      }

      typeNextChar() {
        this.charIndex++;
        this.text.setText(this.fullText.substr(0, this.charIndex));
        if (this.charIndex < this.fullText.length) {
          this.time.delayedCall(40, () => this.typeNextChar());
        } else {
          this.time.delayedCall(500, () => this.scene.start('CreditScene'));
        }
      }
    }

    // -------------------------------------------------------
    // CreditScene：製作團隊場景，滾動文字
    // -------------------------------------------------------
    class CreditScene extends Phaser.Scene {
      constructor() {
        super({ key: 'CreditScene' });
      }

      preload() {
        this.load.image('level3', 'asset/menu/sence/level3.jpg');
      }

      create() {
        const W = this.scale.width;
        const H = this.scale.height;

        this.add.image(W / 2, H / 2, 'level3')
          .setDisplaySize(W, H)
          .setAlpha(0.7);

        const credits = [
          '製作團隊',
          '製作人：\n陳柏睿Ray\n 葉信宏Yeah\n李長軒Sherwin\n吳紘睿Henry',
          '腳本：\n陳柏睿Ray\n 葉信宏Yeah\n李長軒Sherwin\n吳紘睿Henry',
          '程式：\n陳柏睿Ray',
          '美術：\n陳柏睿Ray\n 葉信宏Yeah',
          '音效：\n陳柏睿Ray\nOpen Game Art™',
          '感謝遊玩！'
        ];

        const creditText = this.add.text(W / 2, H + 20, credits.join('\n'), {
          fontFamily: 'a',
          fontSize: '32px',
          color: '#ffffff',
          align: 'center',
          lineSpacing: 32
        }).setOrigin(0.5, 0);

        const maskG = this.make.graphics();
        maskG.fillRect(50, 50, W - 100, H - 100);
        const mask = maskG.createGeometryMask();
        creditText.setMask(mask);

        const totalHeight = creditText.height + 100;
        this.tweens.add({
          targets: creditText,
          y: -totalHeight,
          ease: 'Linear',
          duration: totalHeight * 20,
          onComplete: () => {
            // 滾動完成後，顯示「主畫面」按鈕
            const btn = this.add.text(W - 20, H - 20, '主畫面', {
              fontFamily: 'a',
              fontSize: '24px',
              color: '#ffff00',
              backgroundColor: '#000',
              padding: { x: 10, y: 5 }
            }).setOrigin(1, 1).setInteractive({ useHandCursor: true });

            btn.on('pointerdown', () => {
              this.scene.start('MenuScene');
            });

            // 允許用滑鼠滾輪手動滾動文字
            this.input.on('wheel', (_p, _g, _dx, dy) => {
              creditText.y -= dy;
              const minY = H - creditText.height - 50;
              const maxY = 50;
              if (creditText.y < minY) creditText.y = minY;
              if (creditText.y > maxY) creditText.y = maxY;
            });
          }
        });
      }
    }

    // -------------------------------------------------------
    // Phaser 遊戲配置：使用 Scale Manager 自適應全螢幕
    // -------------------------------------------------------
    const config = {
      type: Phaser.AUTO,

      scale: {
        mode: Phaser.Scale.RESIZE,                 // 保持寬高比放大
        autoCenter: Phaser.Scale.CENTER_BOTH,   // 水平、垂直置中
        width: window.innerWidth,               // 初始寬度 = 視窗寬度
        height: window.innerHeight              // 初始高度 = 視窗高度
      },

      backgroundColor: '#2d2d2d',
      pixelArt: true,
      physics: {
        default: 'arcade',
        arcade: {
          gravity: { y: 500 },
          debug: false,
          debugShowBody: false,
          debugShowVelocity: false
        }
      },

      scene: [
        BootScene,
        MenuScene,
        StoryScene,
        ModeScene,
        Level1Scene,
        Level2Scene,
        Level3Scene,
        Level1Scene_mulit,
        Level2Scene_mulit,
        Level3Scene_mulit,
        MulitLevelSelectScene,
        SettingScene,
        EndStoryScene,
        CreditScene
      ]
    };

    // 當視窗大小改變時，動態調整 Phaser 畫布
    window.addEventListener('resize', () => {
      game.scale.resize(window.innerWidth, window.innerHeight);
    });

    const game = new Phaser.Game(config);
  </script>
</body>

</html>